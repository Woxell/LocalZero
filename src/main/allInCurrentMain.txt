===== ./java/com/localzero/api/config/DataInitializer.java =====
package com.localzero.api.config;

import com.localzero.api.entity.*;
import com.localzero.api.enumeration.InitiativeCategory;
import com.localzero.api.repository.*;
import jakarta.annotation.PostConstruct;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Configuration;

import java.time.LocalDateTime;

@Configuration
@RequiredArgsConstructor
public class DataInitializer {

    private final PersonRepository personRepository;
    private final InitiativeRepository initiativeRepository;
    private final PostRepository postRepository;
    private final CommunityRepository communityRepository;

    @PostConstruct
    public void initData() {
        // Skapa och spara community f√∂rst
        Community community = new Community();
        community.setMemberEmail("test@example.com");
        community = communityRepository.save(community);

        // Skapa och spara person
        Person person = new Person();
        person.setEmail("test@example.com");
        person.setName("Test Anv√§ndare");
        person.setPassword("{noop}password");
        person.setCommunity(community);
        person = personRepository.save(person);

        // Skapa och spara initiative
        Initiative initiative = new Initiative();
        initiative.setTitle("Milj√∂initiativ");
        initiative.setDescription("Planterar tr√§d i Malm√∂");
        initiative.setCategory(InitiativeCategory.ENVIRONMENT);
        initiative.setLocation("Malm√∂");
        initiative.setStartDate(LocalDateTime.now().plusDays(1));
        initiative.setEndDate(LocalDateTime.now().plusDays(10));
        initiative.setPublic(true);
        initiative.setCreator(person);
        initiative.setCommunity(community);
        initiative.setCommunityMember(person);
        initiative.setCreationDatetime(LocalDateTime.now());

        // ‚ö†Ô∏è Viktigt: spara f√∂rst, sedan l√§gg till deltagare
        initiative = initiativeRepository.save(initiative);
        initiative.getParticipants().add(person);
        initiative = initiativeRepository.save(initiative); // spara igen med deltagare

        // Skapa och spara post
        Post post = new Post();
        post.setContent("F√∂rsta inl√§gget i initiativet!");
        post.setAuthor(person);
        post.setInitiative(initiative);
        post.setCreationDatetime(LocalDateTime.now());
        post.setLikesCount(0);
        postRepository.save(post);
    }
}


===== ./java/com/localzero/api/controller/FeedController.java =====
package com.localzero.api.controller;

import com.localzero.api.entity.Initiative;
import com.localzero.api.entity.Person;
import com.localzero.api.entity.Post;
import com.localzero.api.service.InitiativeService;
import com.localzero.api.service.PersonService;
import com.localzero.api.service.PostService;
import lombok.AllArgsConstructor;
import org.springframework.security.core.Authentication;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;

import java.util.ArrayList;
import java.util.List;

@Controller
@AllArgsConstructor
public class FeedController {

    private final PersonService personService;
    private final PostService postService;
    private final InitiativeService initiativeService;

    @GetMapping("/feed")
    public String showFeed(Authentication authentication, Model model) {
        String email = authentication.getName();
        Person person = personService.findByEmail(email);

        // 1. H√§mta initiativ anv√§ndaren deltar i
        List<Initiative> initiatives = initiativeService.getByParticipant(email);

        // 2. H√§mta poster fr√•n initiativen
        List<Post> postsFromInitiatives = new ArrayList<>();
        for (Initiative initiative : initiatives) {
            postsFromInitiatives.addAll(postService.getPostsByInitiativeId(initiative.getId()));
        }

        // 3. H√§mta alla enskilda poster (utan initiativ)
        List<Post> allStandalonePosts = postService.getAllStandalonePosts();

        // 4. Kombinera och sortera
        List<Post> combinedPosts = new ArrayList<>();
        combinedPosts.addAll(postsFromInitiatives);
        combinedPosts.addAll(allStandalonePosts);
        combinedPosts.sort((a, b) -> b.getCreationDatetime().compareTo(a.getCreationDatetime()));

        // üß™ Debug
        System.out.println("==== FEED DEBUG ====");
        System.out.println("Anv√§ndare: " + email);
        System.out.println("Deltar i initiativ: " + initiatives.size());
        for (Initiative i : initiatives) {
            System.out.println(" ‚Üí " + i.getTitle());
        }
        System.out.println("Totalt antal inl√§gg i feed: " + combinedPosts.size());
        for (Post p : combinedPosts) {
            System.out.println(" - " + p.getContent() + " | av: " + p.getAuthor().getEmail() +
                    " | initiativ: " + (p.getInitiative() != null ? p.getInitiative().getTitle() : "Enskild"));
        }

        // 5. Skicka till vy
        model.addAttribute("name", person.getName());
        model.addAttribute("posts", combinedPosts);
        model.addAttribute("source", "feed");

        return "feed";
    }
}


===== ./java/com/localzero/api/controller/IndexController.java =====
package com.localzero.api.controller;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;

@Controller
public class IndexController {
    @GetMapping("/") public String toDefaultPath(){
        return "feed";
    }
}


===== ./java/com/localzero/api/controller/InitiativeController.java =====
package com.localzero.api.controller;

/**
 * @author: Emil
 */

import com.localzero.api.entity.Initiative;
import com.localzero.api.entity.Person;
import com.localzero.api.enumeration.InitiativeCategory;
import com.localzero.api.repository.InitiativeRepository;
import com.localzero.api.repository.PersonRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import com.localzero.api.template.InitiativeCreator;

import java.security.Principal;
import java.time.LocalDateTime;

@Controller
@RequestMapping("/initiatives")
public class InitiativeController {

    private final InitiativeCreator ic;

    public InitiativeController(InitiativeCreator ic){
        this.ic = ic;
    }

@Autowired
    private InitiativeRepository initiativeRepository;
@Autowired
    private PersonRepository personRepository;


    @PostMapping("/create")
    public String createInitiative(@RequestParam String title,
                                   @RequestParam String description,
                                   @RequestParam String location,
                                   @RequestParam String startDate,
                                   @RequestParam String endDate,
                                   @RequestParam InitiativeCategory category,
                                   @RequestParam(required = false, defaultValue = "false") boolean isPublic,
                                   @AuthenticationPrincipal UserDetails user) {

        Initiative initiative = new Initiative();
        initiative.setTitle(title);
        initiative.setDescription(description);
        initiative.setLocation(location);
        initiative.setStartDate(LocalDateTime.parse(startDate));
        initiative.setEndDate(LocalDateTime.parse(endDate));
        initiative.setCategory(category);
        initiative.setPublic(isPublic);

        ic.create(user.getUsername(), initiative);

        return "redirect:/feed";
    }    @RequestMapping("/new")
    public String showCreateInitiativeForm(Model model) {
    model.addAttribute("categories", InitiativeCategory.values());
        return "create-initiative";
    }


}


===== ./java/com/localzero/api/controller/LoginController.java =====
package com.localzero.api.controller;

/**
 * @author: Andr√©
 */

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;

@Controller
public class LoginController {

    @GetMapping("/login")
    public String login() {
        return "login";
    }
/*
    @GetMapping("/register")
    public String register() {
        return "register";
    }

 */
}


===== ./java/com/localzero/api/controller/MessageController.java =====
package com.localzero.api.controller;





import com.localzero.api.entity.DirectMessage;
import com.localzero.api.entity.Notification;
import com.localzero.api.repository.DirectMessageRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;
import com.localzero.api.repository.NotificationsRepository;
import com.localzero.api.repository.PersonRepository;
import org.springframework.security.core.Authentication;

import java.io.IOException;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Controller
@RequestMapping("/messages")
public class MessageController {

    @Autowired
    private DirectMessageRepository directMessageRepository;  //repository object som Spring Boot skapar varje g√•ng vi kallar directMessageRepository

    @Autowired
    private NotificationsRepository notificationRepo;
    @Autowired
    private PersonRepository personRepo;

    @GetMapping
    public String renderChatPage(Authentication authentication, Model model) {
        String loggedInUserEmail = authentication.getName(); // Get the logged-in user's email
        List<DirectMessage> messages = new ArrayList<>();
        messages.addAll(directMessageRepository.findByReceiverEmail(loggedInUserEmail));
        messages.addAll(directMessageRepository.findBySenderEmail(loggedInUserEmail));
        model.addAttribute("messages", messages); // Add messages to the model
        return "messages"; // Resolves messages.html
    }

    @PostMapping
    @ResponseBody
    public DirectMessage sendMessage(@RequestBody DirectMessage message) { //Request, g√∂r JSON till ett object som kan sparas

        message.setCreationDatetime(LocalDateTime.now());
        DirectMessage saved = directMessageRepository.save(message);

        Notification n = new Notification();
        n.setPerson(personRepo.findById(message.getReceiverEmail()).orElseThrow());
        n.setDescription("New Message from " + message.getSenderEmail());
        n.setRead(false);
        n.setCreationDatetime(LocalDateTime.now()); //Vet inte om det beh√∂vs riktigt
        notificationRepo.save(n);
        return saved;
    }

    @PostMapping(value = "/image", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    @ResponseBody
    public DirectMessage sendImageMessage(
            @RequestParam("senderEmail") String senderEmail,
            @RequestParam("receiverEmail") String receiverEmail,
            @RequestParam("file") MultipartFile file) throws IOException {

        DirectMessage message = new DirectMessage();
        message.setSenderEmail(senderEmail);
        message.setReceiverEmail(receiverEmail);
        message.setCreationDatetime(LocalDateTime.now());
        message.setContent("image");
        message.setImageData(file.getBytes());
       DirectMessage saved = directMessageRepository.save(message);

       Notification n = new Notification();
        n.setPerson(personRepo.findById(message.getReceiverEmail()).orElseThrow());
        n.setDescription("New Message from " + message.getSenderEmail());
        n.setRead(false);
        n.setCreationDatetime(LocalDateTime.now()); //Vet inte om det beh√∂vs riktigt, men kanske f√∂r att sortera notifications!!
        notificationRepo.save(n);
        return saved;
    }

    @GetMapping("/image/{id}")
    @ResponseBody
    public ResponseEntity<byte[]> getImage(@PathVariable long id) {  //Skickar tillbaka bildens inneh√•ll som bytes
        DirectMessage message = directMessageRepository.findById(id).orElseThrow();
        return ResponseEntity.ok().contentType(MediaType.IMAGE_JPEG).body(message.getImageData());
    }

    @GetMapping(value = "/get")
    @ResponseBody
    public List<DirectMessage> getMessages(@RequestParam String user1, @RequestParam String user2) { //@RequestParam f√•r d√• users mail. Frontend viktigt att best√§mma users mail p√• r√§tt s√§tt! S√• att denna metod kan hitta r√§tt
        return directMessageRepository.findConversationBetween(user1, user2);
    }
}

===== ./java/com/localzero/api/controller/NotificationController.java =====
package com.localzero.api.controller;

import com.localzero.api.entity.Notification;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;
import com.localzero.api.repository.NotificationsRepository;
import java.util.List;

@RestController
@RequestMapping("/notifications")
public class NotificationController {

    @Autowired
    private NotificationsRepository notificationsRepository;

    @GetMapping
    public List<Notification> getUnread (@RequestParam String email) {

        return notificationsRepository.findByPersonEmailAndIsReadFalse(email);


    }

    @PutMapping ("/{id}/read")
    public void markAsRead(@PathVariable long id) {
        Notification n = notificationsRepository.findById(id).orElseThrow();
        n.setRead(true);
        notificationsRepository.save(n);
    }

}


===== ./java/com/localzero/api/controller/PostController.java =====
package com.localzero.api.controller;


import com.localzero.api.service.InitiativeService;
import com.localzero.api.service.PostService;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import com.localzero.api.template.PostCreator;

@Controller
public class PostController {
    private final PostService postService;
    private final PostCreator pCreator;
    private final InitiativeService inservice;

    public PostController(PostService postService, PostCreator pCreator, InitiativeService inservice) {
        this.postService = postService;
        this.pCreator = pCreator;
        this.inservice = inservice;

    }

    @GetMapping("/create-post")
    public String ShowCreatedPostFrom(Model model, @AuthenticationPrincipal UserDetails currentUser) {
        if(currentUser != null){
            model.addAttribute("initiatives",inservice.getByParticipant(currentUser.getUsername()));
        }else {
            model.addAttribute("initiatives",inservice.getAll());

        }
        return "create-post";
    }

    @PostMapping("/create-post")
    public String createPost(@RequestParam String content,@RequestParam(required = false) Long initiativeId ,@AuthenticationPrincipal UserDetails currentUser) {
        if (currentUser == null) {
            return "redirect:/login";
        }
        pCreator.create(currentUser.getUsername(), content, initiativeId);

        return "redirect:/feed";
    }


    @PostMapping("/posts/{id}/like")
    public String likePost(@PathVariable long id,
                           @RequestParam String source,
                           @AuthenticationPrincipal UserDetails currentUser) {
        if (currentUser == null) {
            return "redirect:/login";
        }

        postService.incrementLikes(id);

        if ("feed".equals(source)) {
            return "redirect:/feed";
        } else {
            String email = currentUser.getUsername();
            return "redirect:/profile/" + email;
        }
    }

}


===== ./java/com/localzero/api/controller/ProfileController.java =====
package com.localzero.api.controller;

import com.localzero.api.entity.Person;
import com.localzero.api.entity.Post;
import com.localzero.api.service.PersonService;
import com.localzero.api.service.PostService;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Optional;

@Controller
@RequestMapping("/profile")
public class ProfileController {
    private final PersonService personService;
    private final PostService postService;

    public ProfileController(PersonService personService, PostService postService) {
        this.personService = personService;
        this.postService = postService;
    }

    @GetMapping
    public String myProfile(Model model, @AuthenticationPrincipal UserDetails currentUser) {
        if (currentUser == null) {
            return "redirect:/login";
        }

        String email = currentUser.getUsername();
        Person user = personService.findByEmail(email);
        List<Post> posts = postService.getPostsByAuthorEmail(email);

        model.addAttribute("user", user);
        model.addAttribute("posts", posts);
        model.addAttribute("source", "profile");
        return "profile";
    }

    @GetMapping("/{email}")
    public String OtherProfile(@PathVariable String email, Model model) {
        Optional<Person> optionalUser = personService.findOptionalByEmail(email);

        if (optionalUser.isEmpty()) {
            model.addAttribute("message", "Anv√§ndaren med e-post '" + email + "' hittades inte.");
            return "user-not-found";
        }
        Person user = optionalUser.get();
        List<Post> posts = postService.getPostsByAuthorEmail(email);
        model.addAttribute("user", user);
        model.addAttribute("posts", posts);
        model.addAttribute("source", "profile");
        return "profile";
    }

}



===== ./java/com/localzero/api/controller/RegistrationController.java =====
package com.localzero.api.controller;

/**
 * @author: Andr√©
 */

import com.localzero.api.entity.Person;
import com.localzero.api.entity.UserRoleAssignment;
import com.localzero.api.enumeration.UserRole;
import com.localzero.api.repository.PersonRepository;
import lombok.Data;
import lombok.SneakyThrows;
import org.antlr.v4.runtime.misc.LogManager;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.util.List;

@Controller
public class RegistrationController {

    @Autowired
    private PersonRepository personRepository;

    @GetMapping("/register")
    public String showRegistrationForm(Model model){
        return "register";
    }

//    @PostMapping( "/register")
//    public Person createPerson(@RequestBody Person person) {
//        // L√∂senord ej krypterade, Spring Security beh√∂ver d√§rf√∂r {noop} prefix
//        person.setPassword("{noop}" + person.getPassword());
//        //Save sparar personen till databasen (blir en insert into person osv automatiskt)
//        return personRepository.save(person);
//    }


    // Denna metod anv√§nds f√∂r att hantera registrering av nya anv√§ndare
    @SneakyThrows
    @PostMapping("/register")
    public String handleRegister(@RequestBody RegistrationRequest rq) {
        try {
            Person person = new Person();
            person.setName(rq.getName());
            person.setEmail(rq.getEmail());
            person.setPassword("{noop}" + rq.getPassword()); // L√§gger till {noop} prefix f√∂r att undvika kryptering
            if (person.getProfilePic() != null && person.getProfilePic().length == 0) {
                person.setProfilePic(null);
            }
            personRepository.save(person);
            System.out.println("Person saved!!!!!!!!");
            return "redirect:/login"; // Omregistrering lyckades, omdirigera till inloggning
        } catch (Exception e) {
            System.out.println("Redirect failed!!!!!!!!");
            e.printStackTrace();
            return "error"; // Om n√•got g√•r fel, returnera ett felmeddelande
        }
    }
}

@Data
class RegistrationRequest {
    private String name;
    private String email;
    private String password;
    private byte[] profilePicture;
    private List<UserRole> roles;
}


===== ./java/com/localzero/api/controller/UserRoleController.java =====
package com.localzero.api.controller;


import com.localzero.api.entity.Person;
import com.localzero.api.enumeration.UserRole;
import com.localzero.api.entity.UserRoleAssignment;
import com.localzero.api.repository.PersonRepository;
import com.localzero.api.repository.UserRoleAssignmentRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;
import java.util.List;

@RestController
@RequestMapping("/roles")
public class UserRoleController {

    @Autowired
    private UserRoleAssignmentRepository roleRepo;
    @Autowired
    private PersonRepository personRepo;

    @PostMapping
    public UserRoleAssignment assignRole(@RequestParam String email, @RequestParam UserRole role) {

        Person p = personRepo.findById(email).orElseThrow();

        UserRoleAssignment assignment = new UserRoleAssignment();
        assignment.setPerson(p);
        assignment.setRole(role);
        return roleRepo.save(assignment);
        
    }

    @GetMapping
    public List<UserRoleAssignment> getRoles(@RequestParam String email) {
        return roleRepo.findByPersonEmail(email);
    }

}


===== ./java/com/localzero/api/entity/Community.java =====
package com.localzero.api.entity;

/**
 * @author: Andr√© , Emil
 */

import jakarta.persistence.*;
import lombok.Data;

import java.io.Serializable;

@Entity
@Data
//@IdClass(Community.class)
public class Community {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;


    @Column(name = "member_email", nullable = false)
    private String memberEmail;

}
/*
@Data
class CommunityId implements Serializable {
    private Long id;
    private String memberEmail;
}

 */

===== ./java/com/localzero/api/entity/DirectMessage.java =====
package com.localzero.api.entity;

/**
 * @author: Adrian , Emil
 */

import jakarta.persistence.*;
import lombok.Data;

import java.time.LocalDateTime;

@Entity
@Data
//@IdClass(DirectMessageId.class)
public class DirectMessage {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;


    @Column(name = "sender_email", nullable = false)
    private String senderEmail;


    @Column(name = "receiver_email", nullable = false)
    private String receiverEmail;

    @ManyToOne
    @JoinColumn(name = "sender_email", referencedColumnName = "email", insertable = false, updatable = false)
    private Person sender;

    @ManyToOne
    @JoinColumn(name = "receiver_email", referencedColumnName = "email", insertable = false, updatable = false)
    private Person receiver;

    @Column(name = "content", nullable = false)
    private String content;

    @Column(name = "creation_datetime", nullable = false)
    private LocalDateTime creationDatetime;

    @Lob
    @Column(name = "image_data")
    private byte[] imageData;
}
/*
@Data
class DirectMessageId implements Serializable {
    private String senderEmail;
    private String receiverEmail;
}

 */


===== ./java/com/localzero/api/entity/EcoAction.java =====
package com.localzero.api.entity;
import jakarta.persistence.*;
import lombok.Data;

/**
 * @author: Mahyar, Emil
 */

@Entity
@Data
@Table(name = "eco_action")
public class EcoAction {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "author_email",nullable = false)
    private String authorEmail;

    /*
    @Id
    @Column(name = "author_email")
    private String authorEmail;

     */

    @Column(name = "community_id",nullable = false)
    private Long communityId;

    private String content;

    @Column(name = "carbon_savings")
    private Float carbonSavings;

    @ManyToOne
    @JoinColumn(name = "community_id", referencedColumnName = "id", insertable = false, updatable = false)
    private Community community;
}


===== ./java/com/localzero/api/entity/Initiative.java =====
package com.localzero.api.entity;

/**
 * @author Andr√©
 * @author Emil
 */

import com.localzero.api.enumeration.InitiativeCategory;
import jakarta.persistence.*;
import lombok.Data;

import java.time.LocalDateTime;
import java.util.HashSet;
import java.util.Set;

@Entity
@Data
public class Initiative {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne
    @JoinColumn(name = "creator_email", referencedColumnName = "email", nullable = false)
    private Person creator;

    @Column(nullable = false)
    private String title;

    @Column(nullable = false,columnDefinition = "TEXT")
    private String description;

    @Column(nullable = false)
    private String location;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private InitiativeCategory category;

    @Column(name = "start_date",nullable = false)
    private LocalDateTime startDate;

    @Column(name = "end_date",nullable = false)
    private LocalDateTime endDate;

    @Column(name = "is_public",nullable = false)
    private boolean isPublic;

    @Column(name = "creation_datetime", nullable = false)
    private LocalDateTime creationDatetime;

    @ManyToOne
    @JoinColumn(name = "community_id", referencedColumnName = "id")
    private Community community;

    @ManyToOne
    @JoinColumn(name = "communitymember_email", referencedColumnName = "email", nullable = false)
    private Person communityMember;

    @ManyToMany
    @JoinTable(
            name = "initiative_participant",
            joinColumns = @JoinColumn(name = "initiative_id"),
            inverseJoinColumns = @JoinColumn(name = "participant_email")
    )
    private Set<Person> participants = new HashSet<>();

}


===== ./java/com/localzero/api/entity/InitiativeParticipant.java =====
/*
package com.localzero.api.entity;

/**
 * @author Andr√© , Emil
 */

import jakarta.persistence.*;
import lombok.Data;

import java.io.Serializable;
/*
@Entity
@Data
//@IdClass(InitiativeParticipantId.class)
public class InitiativeParticipant {

    @EmbeddedId
    private InitiativeParticipantId initiativeParticipantId = new InitiativeParticipantId();
/*
    @Id
    @Column(name = "initiative_id", nullable = false)
    private Long initiativeId;

 */
/*
    @Id
    @Column(name = "participant_email", nullable = false)
    private String participantEmail;

 */
/*
    @ManyToOne
    @MapsId("initiativeId")
    @JoinColumn(name = "initiative_id", referencedColumnName = "id", insertable = false, updatable = false)
    private Initiative initiative;

    @ManyToOne
    @MapsId("participantEmail")
    @JoinColumn(name = "participant_email", referencedColumnName = "email", insertable = false, updatable = false)
    private Person participant;
}
/*
@Data
class InitiativeParticipantId implements Serializable {
    private Long initiativeId;
    private String participantEmail;
}

 */





===== ./java/com/localzero/api/entity/Notification.java =====
package com.localzero.api.entity;

/**
 * @author Adrian Von kr√∂sus Schwenssonmssims üíÄ
 */

import jakarta.persistence.*;
import lombok.Data;

import java.time.LocalDateTime;

    @Entity
    @Data
    public class Notification {

        @Id
        @GeneratedValue(strategy = GenerationType.IDENTITY)
        private Long id;

        @ManyToOne
        @JoinColumn(name = "email", referencedColumnName = "email", nullable = false)
        private Person person;

        @Column(name = "description", nullable = false)
        private String description;

        @Column(name = "creation_datetime", nullable = false)
        private LocalDateTime creationDatetime;

        @Column(name = "is_read")
        private boolean isRead = false;

    }



===== ./java/com/localzero/api/entity/Person.java =====
package com.localzero.api.entity;

/**
 * @author Andr√©
 */

import jakarta.persistence.*;
import lombok.Data;

@Entity
@Data
public class Person {

    @Id
    private String email;

    private String name;

    private String password;

    @Lob
    @Basic(fetch = FetchType.LAZY)
    @Column(name = "profile_pic")
    private byte[] profilePic;

    @ManyToOne
    @JoinColumn(name = "community_id", referencedColumnName = "id")
    private Community community;
}

===== ./java/com/localzero/api/entity/Post.java =====
package com.localzero.api.entity;

/**
 * @author Emil
 * @author Mahyar
 */

import jakarta.persistence.*;
import lombok.Data;
import com.localzero.api.template.TimeStampEntry;

import java.time.LocalDateTime;

@Entity
@Data
public class Post implements TimeStampEntry{

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne
    @JoinColumn(name = "initiative_id")
    private Initiative initiative;

    @ManyToOne
    @JoinColumn(name = "author_email", referencedColumnName = "email")
    private Person author;

    private String content;

    @Lob
    private byte[] image;

    private int likesCount;

    @Column(name = "creation_datetime")
    private LocalDateTime creationDatetime;

    @PrePersist
    private void onCreate() {
        creationDatetime = LocalDateTime.now();
        likesCount = 0;
    }

    
}


===== ./java/com/localzero/api/entity/PostComment.java =====
package com.localzero.api.entity;

/**
 * @author Emil
 */

import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.NoArgsConstructor;
import lombok.Data;

import java.io.Serializable;
import java.time.LocalDateTime;

@Entity
@Data
public class PostComment {

    @EmbeddedId
    private PostCommentId id = new PostCommentId();

    @ManyToOne
    @MapsId("postId")
    @JoinColumn(name = "post_id", referencedColumnName = "id", nullable = false)
    private Post post;

    @ManyToOne
    @MapsId("memberEmail")
    @JoinColumn(name = "author_email", referencedColumnName = "email", nullable = false)
    private Person author;

    private String content;

    @Column(nullable = false)
    private LocalDateTime creationDatetime;

}
/*
@AllArgsConstructor
@NoArgsConstructor

 */
@Data
class PostCommentId implements Serializable {
    private Long postId;
    private String memberEmail;
}

===== ./java/com/localzero/api/entity/UserRoleAssignment.java =====
package com.localzero.api.entity;

import jakarta.persistence.Entity;
import jakarta.persistence.*;
import lombok.Data;
import com.localzero.api.enumeration.UserRole;

@Entity
@Data
public class UserRoleAssignment {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(optional = false)
    @JoinColumn(name = "email", referencedColumnName = "email")
    private Person person;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private UserRole role;

}


===== ./java/com/localzero/api/enumeration/InitiativeCategory.java =====
package com.localzero.api.enumeration;

public enum InitiativeCategory {
    TOOL_SHARING,
    FOOD_SWAP,
    GARDENING,
    RECYCLING,
    RIDE_SHARING,
    ENVIRONMENT
}


===== ./java/com/localzero/api/enumeration/UserRole.java =====
package com.localzero.api.enumeration;

public enum UserRole {

    RESIDENT,
    ORGANIZER
}


===== ./java/com/localzero/api/LocalZeroApplication.java =====
package com.localzero.api;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class LocalZeroApplication {

    public static void main(String[] args) {
        SpringApplication.run(LocalZeroApplication.class, args);
    }
}


===== ./java/com/localzero/api/repository/CommunityRepository.java =====
package com.localzero.api.repository;

import com.localzero.api.entity.Community;
import org.springframework.data.jpa.repository.JpaRepository;

public interface CommunityRepository extends JpaRepository<Community,Long> {
}


===== ./java/com/localzero/api/repository/DirectMessageRepository.java =====
package com.localzero.api.repository;

import com.localzero.api.entity.DirectMessage;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;

import java.util.List;

public interface DirectMessageRepository extends JpaRepository<DirectMessage, Long> {

    @Query("""
        SELECT dm FROM DirectMessage dm
        WHERE (dm.senderEmail = :user1 AND dm.receiverEmail = :user2)
           OR (dm.senderEmail = :user2 AND dm.receiverEmail = :user1) 
        ORDER BY dm.creationDatetime
    """)
    //OR f√∂r att se b√•da Conversations
    List<DirectMessage> findConversationBetween(String user1, String user2);

    List<DirectMessage> findByReceiverEmail(String receiverEmail);

    List<DirectMessage> findBySenderEmail(String senderEmail);

}


===== ./java/com/localzero/api/repository/InitiativeRepository.java =====
package com.localzero.api.repository;

import com.localzero.api.entity.Initiative;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

import java.util.List;

public interface InitiativeRepository extends JpaRepository<Initiative,Long> {
    List<Initiative> findByCreatorEmail(String email);
    @Query("""
        SELECT i FROM Initiative i
        JOIN i.participants p
        WHERE p.email = :email
    """)
    List<Initiative> findByParticipantEmail(@Param("email") String email);

}


===== ./java/com/localzero/api/repository/NotificationsRepository.java =====
package com.localzero.api.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import com.localzero.api.entity.Notification;
import java.util.List;


public interface NotificationsRepository extends JpaRepository<Notification, Long> {

    List<Notification>findByPersonEmailAndIsReadFalse(String email);
}



===== ./java/com/localzero/api/repository/PersonRepository.java =====
package com.localzero.api.repository;
import com.localzero.api.entity.Person;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.Optional;

public interface PersonRepository extends JpaRepository<Person,String> {
    Optional<Person> findByEmail(String email);
}


===== ./java/com/localzero/api/repository/PostRepository.java =====
package com.localzero.api.repository;

import com.localzero.api.entity.Post;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface PostRepository extends JpaRepository<Post, Long> {
    List<Post> findByAuthorEmailOrderByCreationDatetimeDesc(String authorEmail);

    List<Post> findByInitiativeIsNullOrderByCreationDatetimeDesc();

    List<Post> findByInitiativeIdOrderByCreationDatetimeDesc(Long initiativeId);
}


===== ./java/com/localzero/api/repository/UserRoleAssignmentRepository.java =====
package com.localzero.api.repository;

import com.localzero.api.entity.UserRoleAssignment;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface UserRoleAssignmentRepository extends JpaRepository<UserRoleAssignment, Long> {
    List<UserRoleAssignment> findByPersonEmail(String email);
}

===== ./java/com/localzero/api/security/SecurityConfiguration.java =====
package com.localzero.api.security;

import com.localzero.api.service.PersonService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationProvider;
import org.springframework.security.authentication.dao.DaoAuthenticationProvider;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.crypto.password.NoOpPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
@EnableWebSecurity
public class SecurityConfiguration {

    @Autowired
    private PersonService personService;

    @Bean
    public UserDetailsService userDetailsService() {
        return personService;
    }

    @Bean
    public AuthenticationProvider authenticationProvider() {
        DaoAuthenticationProvider authProvider = new DaoAuthenticationProvider();
        authProvider.setUserDetailsService(personService);
        return authProvider;
    }

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity httpSecurity) throws Exception {
        return httpSecurity
                .csrf(AbstractHttpConfigurer::disable)
                .formLogin(httpForm -> {
                    httpForm
                            .loginPage("/login")
                            .usernameParameter("email")
                            .permitAll();
                    httpForm.defaultSuccessUrl("/feed", true); // Redirect to /feed after login
                })
                .authorizeHttpRequests(registry -> {
                    registry
                            .requestMatchers("/register", "/css/**", "/js/**").permitAll()
                            .anyRequest().authenticated();
                })
                .build();
    }
}


===== ./java/com/localzero/api/service/InitiativeService.java =====
package com.localzero.api.service;

import com.localzero.api.entity.Initiative;
import com.localzero.api.repository.InitiativeRepository;
import org.springframework.stereotype.Service;

import java.util.List;
@Service
public class InitiativeService {
    private final InitiativeRepository ir;

    public InitiativeService(InitiativeRepository ir){
        this.ir = ir;
    }

    public List<Initiative> getAll(){
        return ir.findAll();
    }

    public List<Initiative> getByParticipant(String email){
        return ir.findByParticipantEmail(email);
    }
    public Initiative getById(Long id){
        return ir.findById(id).orElseThrow();
    }
}


===== ./java/com/localzero/api/service/PersonService.java =====
package com.localzero.api.service;

import com.localzero.api.entity.Person;
import com.localzero.api.repository.PersonRepository;
import lombok.AllArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

import java.util.Optional;

@Service
@AllArgsConstructor
public class PersonService implements UserDetailsService {

    @Autowired
    private final PersonRepository personRepository;

    @Override
    public UserDetails loadUserByUsername(String email) throws UsernameNotFoundException {
        System.out.println("Loading user by email: " + email);
        Optional<Person> person = personRepository.findByEmail(email);
        if (person.isPresent()) {
            var personObj = person.get();
            return User.builder().
                    username(personObj.getEmail()).
                    password(personObj.getPassword()).
                    build();
        } else {
            throw new UsernameNotFoundException("User not found with email: " + email);
        }
    }

    public Person findByEmail(String email) {
        return personRepository.findByEmail(email).orElseThrow(() -> new RuntimeException("User not found"));
    }

    public Optional<Person> findOptionalByEmail(String email) {
        return personRepository.findById(email);
    }

}


===== ./java/com/localzero/api/service/PostService.java =====
package com.localzero.api.service;

import com.localzero.api.entity.Post;
import com.localzero.api.repository.PostRepository;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class PostService {

    private final PostRepository postRepository;

    public PostService(PostRepository postRepository) {
        this.postRepository = postRepository;
    }

    public List<Post> getPostsByAuthorEmail(String email) {
        return postRepository.findByAuthorEmailOrderByCreationDatetimeDesc(email);
    }

    public Post save(Post post) {
        return postRepository.save(post);
    }

    public List<Post> getAllStandalonePosts() {
        return postRepository.findByInitiativeIsNullOrderByCreationDatetimeDesc();
    }

    public List<Post> getPostsByInitiativeId(Long initiativeId) {
        return postRepository.findByInitiativeIdOrderByCreationDatetimeDesc(initiativeId);
    }

    public void incrementLikes(long postId) {
        Post post = postRepository.findById(postId).orElseThrow();
        post.setLikesCount(post.getLikesCount() + 1);
        postRepository.save(post);
    }
}


===== ./java/com/localzero/api/template/AbstractCreator.java =====
package template;

import com.localzero.api.entity.Person;
import com.localzero.api.entity.Post;
import com.localzero.api.template.TimeStampEntry;

import java.time.LocalDateTime;

public abstract class AbstractCreator<T extends TimeStampEntry> {

    public final T create(String email, String content){
        Person user = loadUser(email);
        T entity = build(user,content);
        setTimestamps(entity);
        return persist(entity);
    }

    protected abstract Person loadUser(String email);
    protected abstract T build(Person user,String content);
    protected abstract void setTimestamps(T entity);
    protected abstract T persist(T entity);

}


===== ./java/com/localzero/api/template/AbstractInitiativeCreator.java =====
package com.localzero.api.template;

import com.localzero.api.entity.Initiative;
import com.localzero.api.entity.Person;

import java.time.LocalDateTime;

public abstract class AbstractInitiativeCreator {
    public final Initiative create(String email, Initiative initiative){
        Person user = loadUser(email);
        initiativedetailer(user,initiative);
        initiative.setCreationDatetime(LocalDateTime.now());
        return save(initiative);
    }

    protected abstract Person loadUser(String email);
    protected abstract  void initiativedetailer(Person user, Initiative initiative);
    protected abstract Initiative save(Initiative initiative);
}


===== ./java/com/localzero/api/template/InitiativeCreator.java =====
package com.localzero.api.template;

import com.localzero.api.entity.Initiative;
import com.localzero.api.entity.Person;
import com.localzero.api.repository.InitiativeRepository;
import com.localzero.api.service.PersonService;
import org.springframework.stereotype.Service;

@Service
public class InitiativeCreator extends AbstractInitiativeCreator {

    private final InitiativeRepository ir;
    private final PersonService ps;

    public InitiativeCreator(InitiativeRepository ir, PersonService ps){
        this.ir = ir;
        this.ps = ps;
    }

    @Override
    protected Person loadUser(String email) {
        return ps.findByEmail(email);
    }


    @Override
    protected void initiativedetailer(Person user, Initiative initiative) {
        initiative.setCreator(user);
        initiative.setCommunity(user.getCommunity());
        initiative.setCommunityMember(user);
        initiative.getParticipants().add(user);
    }

    @Override
    protected Initiative save(Initiative initiative) {
        return ir.save(initiative);
    }
}


===== ./java/com/localzero/api/template/PostCreator.java =====
package com.localzero.api.template;

import com.localzero.api.entity.Initiative;
import com.localzero.api.entity.Person;
import com.localzero.api.entity.Post;
import com.localzero.api.repository.InitiativeRepository;
import com.localzero.api.repository.PostRepository;
import com.localzero.api.service.PersonService;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;

@Service
public class PostCreator extends template.AbstractCreator<Post> {

    private final PostRepository postRepo;
    private final PersonService personService;
    private final InitiativeRepository initiativeRepository;

    public PostCreator(PostRepository postRepo, PersonService personService, InitiativeRepository initiativeRepository){
        this.postRepo = postRepo;
        this.personService = personService;
        this.initiativeRepository = initiativeRepository;
    }

    @Override
    protected Person loadUser(String email) {
        return personService.findByEmail(email);
    }

    @Override
    protected Post build(Person user,String content) {
        Post post = new Post();
        post.setAuthor(user);
        post.setContent(content);
        post.setLikesCount(0);
        return post;
    }

    public Post create(String email, String content,Long initiativeId){
        Post post = super.create(email,content);
        if (initiativeId != null){
            Initiative initiative = initiativeRepository.findById(initiativeId).orElseThrow();
            post.setInitiative(initiative);
        }
        return postRepo.save(post);
    }

    @Override
    protected void setTimestamps(Post entity) {
        entity.setCreationDatetime(LocalDateTime.now());
    }

    @Override
    protected Post persist(Post entity) {
        return postRepo.save(entity);
    }


}


===== ./java/com/localzero/api/template/TimeStampEntry.java =====
package com.localzero.api.template;

import java.time.LocalDateTime;

public interface TimeStampEntry {
    void setCreationDatetime(LocalDateTime dateTime);
}


===== ./resources/application-secrets.properties =====
spring.datasource.password=hx408oft
spring.datasource.username=ac9996

===== ./resources/application.properties =====
spring.application.name=LocalZero
spring.config.import=optional:application-secrets.properties
spring.datasource.url=jdbc:postgresql://pgserver.mau.se:5432/localzerooo
spring.datasource.username=${spring.datasource.username}
spring.datasource.password=${spring.datasource.password}
spring.datasource.hikari.maximum-pool-size=2
spring.jpa.hibernate.ddl-auto= create-drop
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true
logging.level.org.hibernate.type.descriptor.sql=TRACE
spring.thymeleaf.prefix=classpath:/templates/
spring.thymeleaf.suffix=.html



===== ./resources/static/css/dm.css =====
body {
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI', sans-serif;
    background-image: url("https://www.psdstack.com/wp-content/uploads/2019/08/copyright-free-images-750x420.jpg");
    background-repeat: no-repeat;
    background-size: cover;
    background-position: center;
    min-height: 100vh;
    overflow: hidden;
}

.navbar {
    display: flex;
    justify-content: space-between;
    background-color: #2c3e50;
    padding: 1rem 2rem;
    color: white;
}

.navbar a {
    color: white;
    text-decoration: none;
    font-weight: bold;
    margin-left: 1rem;
}

.navbar a:hover {
    text-decoration: underline;
}

.messages-layout {
    display: flex;
    height: calc(100vh - 60px); /* Full height minus navbar */
    overflow: hidden; /* Prevent layout scrolling */
}

.dm-container {
    width: 30%;
    border-right: 1px solid #ddd;
    overflow-y: scroll;
    padding: 20px;
    background: rgba(255, 255, 255, 0.9);
}

.chat-container {
    width: 70%;
    overflow-y: scroll;
    padding: 20px;
    background: rgba(255, 255, 255, 0.9);
}

/* Custom scrollbar styling */
.dm-container::-webkit-scrollbar,
.chat-container::-webkit-scrollbar {
    width: 8px;
}

.dm-container::-webkit-scrollbar-thumb,
.chat-container::-webkit-scrollbar-thumb {
    background-color: #888;
    border-radius: 4px;
}

.dm-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
}

.dm-item:hover {
    background-color: #f5f5f5;
}



===== ./resources/static/css/feed.css =====
body{
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI',sans-serif;
    background-image: url("https://www.psdstack.com/wp-content/uploads/2019/08/copyright-free-images-750x420.jpg");
    background-repeat: no-repeat;
    background-size: cover;
    background-position: center;
    min-height: 100vh;
}

.feed-wrapper{
    max-width: 800px;
    margin: 2rem auto;
    padding: 1rem;
    background-color: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 15px;
    backdrop-filter: blur(15px);
    box-shadow: 0 0 20px rgba(0,0,0,0.2);
}

.feed-post{
    background: rgba(255,255,255,0.15);
    border-radius: 10px;
    margin-bottom: 1rem;
    padding: 1rem;
    color: black;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

.feed-post-header{
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    color: #333;
}

.feed-post-content{
    font-size: 1rem;
    line-height: 1.4;
    color: #111;
}

.feed-post img{
    max-width: 100%;
    border-radius: 8px;
    margin-top: 0.5rem;
}

.feed-actions{
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.feed-actions button{
    background-color: #ffffffcc;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s;
}

.feed-actions button:hover{
    background-color: white;
}

.likes-count{
    font-size: 0.9rem;
    color: #222;
}

.navbar{
    display: flex;
    justify-content: space-between;
    background-color: #2c3e50;
    padding: 1rem 2rem;
    color: white;
}
.navbar a{
    color: white;
    text-decoration: none;
    font-weight: bold;
    margin-left: 1rem;
}
.navbar a:hover{
    text-decoration: underline;
}



===== ./resources/static/css/initiative.css =====
textarea, input[type="text"], input[type="datetime-local"], select {
    border: 2px solid #ffb6c1;
    border-radius: 10px;
    padding: 10px;
    font-size: 16px;
    width: 100%;
    margin-bottom: 12px;
    background-color: rgba(255, 255, 255, 0.8);
}

textarea:focus, input:focus, select:focus {
    outline: none;
    border-color: #ff77b9;
    box-shadow: 0 0 5px #ff7bbe;
}

button {
    background-color: #fd80bf;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

button:hover {
    background-color: #ff7bbe;
}

.create-initiative-container {
    border: 2px solid #ffcce5;
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    backdrop-filter: blur(15px);
    padding: 2rem;
    max-width: 500px;
    margin: 2rem auto;
    box-shadow: 0 0 25px rgba(255, 182, 193, 0.4);
}

.create-initiative-container h2 {
    text-align: center;
    color: #333;
    margin-bottom: 1.5rem;
    font-size: 1.5rem;
}


===== ./resources/static/css/login.css =====
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', sans-serif;
}

body {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background-image: url("https://www.psdstack.com/wp-content/uploads/2019/08/copyright-free-images-750x420.jpg");
    background-repeat: no-repeat;
    background-position: center;
    background-size: cover;
}

section {
    background-color: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 15px;
    backdrop-filter: blur(15px);
    padding: 2rem;
    width: 350px;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
}

.form-container h1 {
    color: black;
    text-align: center;
    margin-bottom: 1rem;
}

.input-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
}

.input-group label {
    color: black;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.input-group input {
    padding: 0.5rem;
    border: none;
    border-radius: 8px;
    outline: none;
}

button {
    width: 100%;
    padding: 0.6rem;
    border: none;
    border-radius: 8px;
    background-color: #ffffffcc;
    font-weight: bold;
    cursor: pointer;
    transition: 0.3s;
}



button:hover {
    background-color: white;
}


===== ./resources/static/css/main.css =====
{
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', sans-serif;
}

*{
    font-family: 'Segoe UI', sans-serif;
}

body {
    min-height: 100vh;
    padding-top: 70px;
    background-image: url("https://www.psdstack.com/wp-content/uploads/2019/08/copyright-free-images-750x420.jpg");
    background-repeat: no-repeat;
    background-position: center;
    background-size: cover;
    font-family: 'Segoe UI', sans-serif;
}

.navbar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1000;
    display: flex;
    flex-wrap: wrap; /* M√∂jligg√∂r radbrytning */
    justify-content: center; /* Centrera inneh√•ll i flera rader */
    gap: 1rem;
    background-color: #2c3e50;
    padding: 1rem 2rem;
    color: white;
}

.navbar a {
    color: white;
    text-decoration: none;
    font-weight: bold;
    margin-left: 0.5rem;
}
.navbar a:hover {
    text-decoration: underline;
}

.feed-wrapper {
    max-width: 800px;
    margin: 2rem auto;
    padding: 1rem;
    background-color: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 15px;
    backdrop-filter: blur(15px);
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
}


.like-button{
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2rem;
    padding: 0;
}

.like-button:hover{
    tansform: scale(1.1);
}

.post-footer{
    text-align: right;
    font-size: 0.8rem;
    color: #555;
    margin-top: 0.5rem;
}

.feed-post {
    background: rgba(255, 255, 255, 0.15);
    border-radius: 10px;
    margin-bottom: 1rem;
    padding: 1rem;
    color: black;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

.feed-post-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    color: #000000;
}

.feed-post-content {
    font-size: 1rem;
    line-height: 1.4;
    color: #000000;
}

.feed-post img {
    max-width: 100%;
    border-radius: 8px;
    margin-top: 0.5rem;
}

.feed-actions {
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.feed-actions button {
    background-color: #ffffffcc;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s;
}
.feed-actions button:hover {
    background-color: white;
}

.likes-count {
    font-size: 0.9rem;
    color: #222;
}

.form-container,
.create-initiative-container {
    background-color: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 15px;
    backdrop-filter: blur(15px);
    padding: 2rem;
    max-width: 350px;
    margin: 2rem auto;
    box-shadow: 0 0 15px rgba(0,0,0,0.2);
}

.form-container h1,
.create-initiative-container h1 {
    text-align: center;
    margin-bottom: 1rem;
    color: black;
}

.input-group,
.create-initiative-container .input-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
}

.input-group label,
.create-initiative-container .input-group label {
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: black;
}

.input-group input,
.create-initiative-container .input-group input,
.create-initiative-container .input-group textarea,
textarea {
    padding: 0.5rem;
    border: none;
    border-radius: 8px;
    outline: none;
    resize: vertical;
}

button {
    width: 100%;
    padding: 0.6rem;
    border: none;
    border-radius: 8px;
    background-color: #ffffffcc;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s;
}

button:hover {
    background-color: white;
}

.profile-container {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 2rem;
    margin-top: 3rem;
    flex-wrap: wrap;
    padding: 0 2rem;
}

.profile-card {
    background-color: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.4);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 2rem 3rem;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.25);
    width: 100%;
    max-width: 350px;
    color: #000000;
}


.profile-card h1 {
    margin-top: 0;
    font-size: 1.8rem;
    color: #000000;
}

.profile-card p {
    font-size: 1rem;
    margin: 0.5rem 0;
    color: #000000;
}

.profile-card strong {
    color: #222;
}

.user-posts {
    flex: 1;
    max-width: 800px;
    min-width: 300px;
}

.user-posts h2 {
    color: #222;
    margin-bottom: 1rem;
}



===== ./resources/static/css/post.css =====
textarea, select {
    border: 2px solid #ffb6c1;
    border-radius: 10px;
    padding: 10px;
    font-size: 16px;
    width: 100%;
    margin-bottom: 12px;
}

textarea:focus, select:focus {
    outline: none;
    border-color: #ff77b9;
    box-shadow: 0 0 5px #ff7bbe;
}

button {
    background-color: #fd80bf;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
}

button:hover {
    background-color: rgba(255, 123, 194, 0.99);
}

.flex-row {
    display: flex;
    align-items: center;
    gap: 10px;
}

.form-container {
    border: 2px solid #ffcce5;
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    backdrop-filter: blur(15px);
    padding: 2rem;
    max-width: 500px;
    margin: 2rem auto;
    box-shadow: 0 0 25px rgba(255, 182, 193, 0.4);
}

===== ./resources/static/css/profile.css =====
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f4f6f8;
    margin: 0;
    padding: 0;
}

.navbar{
    display: flex;
    justify-content: space-between;
    background-color: #2c3e50;
    padding: 1rem 2rem;
    color: white;
}

.navbar a{
    color: white;
    text-decoration: none;
    font-weight: bold;
    margin-left: 1rem;
}

.navbar a:hover{
    text-decoration: underline;
}

.profile-container {
    display: flex;
    justify-content: center;
    margin-top: 3rem;
}


.profile-card {
    background-color: #ffffff;
    border-radius: 12px;
    padding: 2rem 3rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: 350px;
}

.profile-card h1 {
    margin-top: 0;
    font-size: 2rem;
    color: #333;
}

.profile-card p {
    font-size: 1rem;
    margin: 0.5rem 0;
    color: #555;
}

.profile-card strong {
    color: #222;
}


@media (max-width: 350px) {
    .profile-card {
        padding: 1.5rem;
    }

    .profile-card h1 {
        font-size: 1.5rem;
    }
}

===== ./resources/static/js/register.js =====
const baseURL = 'http://localhost:8080';

document.getElementById("submit").addEventListener('click', (event) => {
    event.preventDefault(); // Prevent default form submission
    submitForm();
});

function submitForm() {
    console.log("Submit button clicked");

    const data = {
        name: document.getElementById('name').value,
        email: document.getElementById('email').value,
        password: document.getElementById('password').value,
        profilePicture: document.getElementById('profilePicture').value
    };

    if (!data.name || !data.email || !data.password) {
        alert("Please fill in all fields");
        return;
    }

    console.log(data);

    const jsonData = JSON.stringify(data);
    fetch(baseURL + '/register', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: jsonData
    })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            }
        })
}

===== ./resources/static/js/script.js =====


===== ./resources/templates/create-initiative.html =====
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Initiative Creator</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/initiative.css">

</head>
<body>
<div th:replace="fragments :: navbar"></div>

<div class="create-initiative-container">
<h2>Create an Initiative!</h2>
<form th:action="@{/initiatives/create}" method="post">
    <label for="title">Title: </label><br>
    <input type="text" name="title" id="title" required><br><br>

    <label for="description">Description:</label><br>
    <textarea name="description"  id="description" required></textarea><br><br>

    <label for="location">Location:</label><br>
    <input type="text" name="location" id="location" required><br><br>

    <label for="startDate">Start Date and time:</label><br>
    <input type="datetime-local" name="startDate" id="startDate" required><br><br>

    <label for="endDate">End Date and time:</label><br>
    <input type="datetime-local" name="endDate" id="endDate" required><br><br>

    <label for="category">Category:</label><br>
    <select name="category" id="category" required>
        <option th:each="cat : ${categories}"
                th:value="${cat}"
                th:text="${cat}"
        ></option>
    </select><br><br>

    <label for="isPublic">Public Initiative?</label>
    <input type="checkbox" name="isPublic" id="isPublic" value="true"><br><br>

    <button type="submit">Create Initiative</button>
</form>
</div>
</body>
</html>

===== ./resources/templates/create-post.html =====
<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Create Post</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/post.css">
</head>
<body>

<div th:replace="fragments :: navbar"></div>

<div class="form-container">
    <h1> Create new post</h1>

    <form th:action="@{/create-post}" method="post">
        <textarea name="content" placeholder="Write your post here" required></textarea>


        <label for="initiativeId">Choose Initiative (Optional):</label>
        <select name="initiativeId" id="initiativeId">
            <option value="">-Public-</option>
            <option th:each="i : ${initiatives}" th:value="${i.id}" th:text="${i.title}"></option>
        </select>
        <button type="submit">Publish</button>
    </form>
</div>

</body>
</html>

===== ./resources/templates/feed.html =====
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LocalZero - Feed</title>
    <link rel="stylesheet" href="/css/main.css">
</head>

<body>

<div th:replace="~{fragments :: navbar}"></div>

<div class="feed-wrapper">
    <div th:each="post : ${posts}">
        <div th:replace="~{fragments :: post(post=${post})}"></div>
    </div>
</div>

</body>
</html>


===== ./resources/templates/fragments.html =====
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>


<div th:fragment="navbar">
    <nav class="navbar">
        <a href="/profile">Profile</a>
        <a href="/messages">Direct Messages</a>
        <a href="/initiative/feed">Initiatives</a>
        <a href="/feed">Feed</a>
        <a href="/initiatives/new">Create initiative</a>
        <a href="/create-post">Create post</a>
        <a href="/logout">Log Out</a>
    </nav>
</div>

<div th:fragment="profile(user, posts)">
    <div class="profile-container">
        <div class="profile-card">
        <h1 th:text="'Hello,' + ${user.name} + '!'">Hello, User!</h1>
        <p><strong>Email</strong> <span th:text="${user.email}">mail@example.com</span></p>
        <!--<p><strong>Inl√§gg:</strong> <span th:text="${user.posts.size()}">0</span></p> -->
        </div>
        <div class="user-posts">
            <h2>Your posts</h2>
            <div th:if="${#lists.isEmpty(posts)}">
                <p>You have not posts yet!</p>
            </div>
            <div th:each="post : ${posts}">
                <div th:replace="~{fragments :: post(post=${post})}"></div>
            </div>
        </div>
    </div>
</div>

<div th:fragment="post(post)">
    <div class="feed-post">
        <div class="feed-post-header">
            <span th:if="${post != null and post.author != null}" th:text="${post.author.name}"></span>
            <span th:unless="${post != null and post.author != null}">Unknown user</span>

            <span th:if="${post.initiative != null}" th:text="' i ' + ${post.initiative.title}"></span>
        </div>

        <div class="feed-post-content" th:text="${post.content}">Post Content</div>

        <div class="feed-actions">
            <form th:action="@{/posts/{id}/like(id=${post.id})}" method="post" style="display:inline;">
                <input type ="hidden" name="source" th:value="${source}"/>
                <button type="submit" class="like-button">‚ù§Ô∏è</button>
                <span th:text="${post.likesCount}">0</span>
            </form>
        </div>

        <div class="post-footer">
            <span th:text="${#temporals.format(post.creationDatetime, 'yyyy-MM-dd HH:mm')}"></span>
        </div>
    </div>
</div>


<div th:fragment="chat">
    <div class="chat-area">
        <!-- Chat messages will go here -->
    </div>
    <div class="chat-input">
        <textarea placeholder="Type a message..."></textarea>
        <button>Send</button>
    </div>
</div>

</body>
</html>

===== ./resources/templates/login.html =====
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LocalZero - Login</title>
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<section class="form-container">
<h1>Login</h1>
<form th:action="@{/login}" method="post">
    <div class="input-group">
        <label for="email">Email:</label>
        <input type="text" id="email" name="email" required>
    </div>
    <div class="input-group">
        <label for="password">Password:</label>
        <input type="password" id="password" name="password" required>
    </div>
    <button type="submit">Login</button>
    <p>Don't have an account? <a th:href="@{/register}" style="color: #90cdf4">Register here</a></p>

</form>
</section>
</body>
</html>

===== ./resources/templates/messages.html =====
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LocalZero - Direct Messages</title>
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>

<div th:replace="~{fragments :: navbar}"></div>

<div class="messages-layout">
    <div class="dm-container">
        <h1>Direct Messages</h1>
        <div class="dm-list">
            <div class="dm-item" th:each="message : ${messages}">
                <div class="dm-header">
                    <span th:text="${message.sender.name}">Sender Name</span>
                    <span th:text="${message.timestamp}">Timestamp</span>
                </div>
                <div class="dm-content" th:text="${message.content}">Message Content</div>
            </div>
        </div>
    </div>

    <div class="chat-container">
        <div th:replace="~{fragments :: chat}"></div>
    </div>
</div>
</body>
</html>

===== ./resources/templates/profile.html =====
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LocalZero - Profile</title>
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>

<div th:replace="fragments :: navbar"></div>
<div th:replace="~{fragments :: profile(user=${user}, posts=${posts})}"></div>



</body>
</html>

===== ./resources/templates/register.html =====
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>LocalZero - Register</title>
    <link rel="stylesheet" href="/css/main.css">
    <script src="/js/register.js" defer></script>
</head>
<body>
<section>
<form class="form-container" method="post">
    <h1>Register</h1>
    <div class="input-group">
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" required>
    </div>
    <div class="input-group">
        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required>
    </div>
    <div class="input-group">
        <label for="password">Password:</label>
        <input type="password" id="password" name="password" required>
    </div>
    <div class="input-group">
        <label for="profilePicture">Profile Picture :</label>
        <input type="file" id="profilePicture" name="profilePicture" accept="image/*" onchange="previewFile(this)" required>
    </div>
    <button id= "submit" type="button">Register</button>
</form>
</section>
</body>
</html>

===== ./resources/templates/user-not-found.html =====

<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Anv√§ndare ej hittad</title>
    <link rel="stylesheet" href="/css/profileStyle.css">
</head>
<body>

<!-- Navbar -->
<div th:replace="fragments :: navbar"></div>

<!-- Felmeddelande -->
<div class="error-container">
    <h1>Oj!</h1>
    <p th:text="${message}">Anv√§ndaren hittades inte.</p>
    <a href="/feed">Tillbaka till fl√∂det</a>
</div>

</body>
</html>


===== ./java/com/localzero/api/config/DataInitializer.java =====
package com.localzero.api.config;

import com.localzero.api.entity.*;
import com.localzero.api.enumeration.InitiativeCategory;
import com.localzero.api.repository.*;
import jakarta.annotation.PostConstruct;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Configuration;

import java.time.LocalDateTime;
import java.util.Set;

@Configuration
@RequiredArgsConstructor
public class DataInitializer {

    private final PersonRepository personRepository;
    private final InitiativeRepository initiativeRepository;
    private final PostRepository postRepository;
    private final CommunityRepository communityRepository;

    @PostConstruct
    public void initData() {
        Community c1 = new Community();
        c1.setMemberEmail("Lund");
        communityRepository.save(c1);

        Community c2 = new Community();
        c2.setMemberEmail("Stockholm");
        communityRepository.save(c2);

        Community c3 = new Community();
        c3.setMemberEmail("G√∂teborg");
        communityRepository.save(c3);

        Person p1 = new Person();
        p1.setEmail("alice@example.com");
        p1.setName("Alice");
        p1.setPassword("{noop}pass");
        p1.setCommunities(Set.of(c1));
        personRepository.save(p1);

        Person p2 = new Person();
        p2.setEmail("bob@example.com");
        p2.setName("Bob");
        p2.setPassword("{noop}pass");
        p1.setCommunities(Set.of(c1));
        personRepository.save(p2);

        Person p3 = new Person();
        p3.setEmail("charlie@example.com");
        p3.setName("Charlie");
        p3.setPassword("{noop}pass");
        p1.setCommunities(Set.of(c2));
        personRepository.save(p3);

        Initiative i1 = new Initiative();
        i1.setTitle("Cykelverkstad");
        i1.setDescription("Laga cyklar");
        i1.setCategory(InitiativeCategory.TOOL_SHARING);
        i1.setLocation("Lund");
        i1.setStartDate(LocalDateTime.now().plusDays(1));
        i1.setEndDate(LocalDateTime.now().plusDays(3));
        i1.setPublic(true);
        i1.setCreator(p2);
        i1.setCommunityMember(p2);
        i1.setCreationDatetime(LocalDateTime.now());
        i1.setCommunities(Set.of(c1));
        i1.getParticipants().add(p2);
        initiativeRepository.save(i1);

        Initiative i2 = new Initiative();
        i2.setTitle("Kompostering i kvarteret");
        i2.setDescription("Skapa ett kompostsystem i tr√§dg√•rden");
        i2.setCategory(InitiativeCategory.RECYCLING);
        i2.setLocation("Malm√∂");
        i2.setStartDate(LocalDateTime.now().plusDays(2));
        i2.setEndDate(LocalDateTime.now().plusDays(5));
        i2.setPublic(true);
        i2.setCreator(p1);
        i2.setCommunityMember(p1);
        i2.setCreationDatetime(LocalDateTime.now());
        i2.setCommunities(Set.of(c1));
        i2.getParticipants().add(p1);
        initiativeRepository.save(i2);

        Post post1 = new Post();
        post1.setAuthor(p1);
        post1.setInitiative(i2);
        post1.setContent("Vi har f√•tt hem nya k√§rl!");
        post1.setCreationDatetime(LocalDateTime.now());
        post1.setLikesCount(0);
        postRepository.save(post1);

        Post post2 = new Post();
        post2.setAuthor(p2);
        post2.setInitiative(i1);
        post2.setContent("Cykelverkstad startar imorgon!");
        post2.setCreationDatetime(LocalDateTime.now());
        post2.setLikesCount(0);
        postRepository.save(post2);

        Post standalone = new Post();
        standalone.setAuthor(p3);
        standalone.setContent("N√•gon som vill sam√•ka till eko-marknaden?");
        standalone.setCreationDatetime(LocalDateTime.now());
        standalone.setLikesCount(0);
        postRepository.save(standalone);
    }
}

===== ./java/com/localzero/api/controller/FeedController.java =====
package com.localzero.api.controller;

import com.localzero.api.entity.Initiative;
import com.localzero.api.entity.Person;
import com.localzero.api.entity.Post;
import com.localzero.api.service.InitiativeService;
import com.localzero.api.service.PersonService;
import com.localzero.api.service.PostService;
import lombok.AllArgsConstructor;
import org.springframework.security.core.Authentication;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;


import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

@Controller
@AllArgsConstructor
public class FeedController {

    private final PersonService personService;
    private final PostService postService;
    private final InitiativeService initiativeService;

    @GetMapping("/feed")
    public String showFeed(Authentication authentication, Model model) {
        String email = authentication.getName();
        Person person = personService.findByEmail(email);

        List<Initiative> myInitiatives = initiativeService.getByParticipant(email);

        List<Post> postsFromMyInitiatives = new ArrayList<>();
        for (Initiative initiative : myInitiatives) {
            postsFromMyInitiatives.addAll(postService.getPostsByInitiativeId(initiative.getId()));
        }

        List<Post> allStandalonePosts = postService.getAllStandalonePosts();

        Set<Long> myInitiativeIds = new HashSet<>();
        for (Initiative i : myInitiatives) {
            myInitiativeIds.add(i.getId());
        }

        List<Initiative> visibleInitiatives = initiativeService.getPublicOrByCommunities(person.getCommunities());


        List<Post> postsFromVisibleInitiatives = new ArrayList<>();
        for (Initiative initiative : visibleInitiatives) {
            if (!myInitiativeIds.contains(initiative.getId())) {
                postsFromVisibleInitiatives.addAll(postService.getPostsByInitiativeId(initiative.getId()));
            }
        }

        List<Post> combinedPosts = new ArrayList<>();
        combinedPosts.addAll(postsFromMyInitiatives);
        combinedPosts.addAll(postsFromVisibleInitiatives);
        combinedPosts.addAll(allStandalonePosts);
        combinedPosts.sort((a, b) -> b.getCreationDatetime().compareTo(a.getCreationDatetime()));

        System.out.println("==== FEED DEBUG ====");
        System.out.println("Anv√§ndare: " + email);
        System.out.println("Deltar i initiativ: " + myInitiatives.size());
        for (Initiative i : myInitiatives) {
            System.out.println(" ‚Üí " + i.getTitle());
        }
        System.out.println("Totalt antal inl√§gg i feed: " + combinedPosts.size());
        for (Post p : combinedPosts) {
            System.out.println(" - " + p.getContent() + " | av: " + p.getAuthor().getEmail() +
                    " | initiativ: " + (p.getInitiative() != null ? p.getInitiative().getTitle() : "Enskild"));
        }

        model.addAttribute("name", person.getName());
        model.addAttribute("posts", combinedPosts);
        model.addAttribute("source", "feed");

        return "feed";
    }
}

===== ./java/com/localzero/api/controller/IndexController.java =====
package com.localzero.api.controller;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;

@Controller
public class IndexController {
    @GetMapping("/") public String toDefaultPath(){
        return "feed";
    }
}


===== ./java/com/localzero/api/controller/InitiativeController.java =====
package com.localzero.api.controller;

import com.localzero.api.entity.Community;
import com.localzero.api.entity.Initiative;
import com.localzero.api.entity.Person;
import com.localzero.api.entity.Post;
import com.localzero.api.enumeration.InitiativeCategory;
import com.localzero.api.repository.CommunityRepository;
import com.localzero.api.repository.InitiativeRepository;
import com.localzero.api.repository.PersonRepository;
import com.localzero.api.repository.PostRepository;
import com.localzero.api.service.InitiativeService;
import com.localzero.api.template.InitiativeCreator;
import lombok.RequiredArgsConstructor;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;

import java.time.LocalDateTime;
import java.util.HashSet;
import java.util.List;
import java.util.Objects;
import java.util.Set;
import java.util.stream.Collectors;

@Controller
@RequestMapping("/initiatives")
@RequiredArgsConstructor
public class InitiativeController {

    private final InitiativeCreator ic;
    private final InitiativeRepository initiativeRepository;
    private final PersonRepository personRepository;
    private final CommunityRepository communityRepository;
    private final InitiativeService initiativeService;
    private final PostRepository postRepository;

    @PostMapping("/create")
    public String createInitiative(@RequestParam String title,
                                   @RequestParam String description,
                                   @RequestParam String location,
                                   @RequestParam String startDate,
                                   @RequestParam String endDate,
                                   @RequestParam InitiativeCategory category,
                                   @RequestParam(required = false, defaultValue = "false") boolean isPublic,
                                   @RequestParam List<Long> communityIds,
                                   @AuthenticationPrincipal UserDetails user) {

        Initiative initiative = new Initiative();
        initiative.setTitle(title);
        initiative.setDescription(description);
        initiative.setLocation(location);
        initiative.setStartDate(LocalDateTime.parse(startDate));
        initiative.setEndDate(LocalDateTime.parse(endDate));
        initiative.setCategory(category);
        initiative.setPublic(isPublic);

        Person creator = personRepository.findByEmail(user.getUsername()).orElseThrow();
        initiative.setCreator(creator);
        initiative.setCommunityMember(creator);


        Set<Community> selectedCommunities = new HashSet<>(communityRepository.findAllById(communityIds));
        initiative.setCommunities(selectedCommunities);

        ic.create(user.getUsername(), initiative);

        return "redirect:/feed";
    }
    @GetMapping("/feed")
    public String showInitiatives(Model model, @AuthenticationPrincipal UserDetails currentUser) {
        Person person = personRepository.findByEmail(currentUser.getUsername()).orElseThrow();
        List<Initiative> initiatives = initiativeService.getVisibleForUser(person);
        initiatives = initiatives.stream().filter(Objects::nonNull).toList();
        List<Initiative> myInitiatives = initiativeService.getByParticipant(person.getEmail());

        Set<Long> joinedInitiativeIds = myInitiatives.stream().map(Initiative::getId).collect(Collectors.toSet());
        
        model.addAttribute("initiatives", initiatives);
        model.addAttribute("joinedInitiativeIds", joinedInitiativeIds);

        return "initiative-feed";
    }

    @GetMapping("/new")
    public String showCreateInitiativeForm(Model model) {
        model.addAttribute("categories", InitiativeCategory.values());
        model.addAttribute("allCommunities", communityRepository.findAll());
        return "create-initiative";
    }

    @GetMapping("/{id}")
    public String showEditInitiativeForm(@PathVariable Long id, Model model, @AuthenticationPrincipal UserDetails currentUser) {
        Initiative initiative = initiativeService.getById(id);
        Person person = personRepository.findByEmail(currentUser.getUsername()).orElseThrow();
        boolean isParticipant = initiative.getParticipants().stream().anyMatch(p -> p.getEmail().equals(person.getEmail()));

        model.addAttribute("initiative", initiative);
        model.addAttribute("isParticipant", isParticipant);
        List<Post> posts = postRepository.findByInitiativeIdOrderByCreationDatetimeDesc(initiative.getId());
        model.addAttribute("posts",posts);
        return "initiative-view";
    }

    @PostMapping("/{id}/join")
    public String joinInitiative(@PathVariable Long id, @AuthenticationPrincipal UserDetails currentUser) {
        initiativeService.addParticipant(id, currentUser.getUsername());
        return "redirect:/initiatives/" + id;
    }

}


===== ./java/com/localzero/api/controller/LoginController.java =====
package com.localzero.api.controller;

/**
 * @author: Andr√©
 */

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;

@Controller
public class LoginController {

    @GetMapping("/login")
    public String login() {
        return "login";
    }
/*
    @GetMapping("/register")
    public String register() {
        return "register";
    }

 */
}


===== ./java/com/localzero/api/controller/MessageController.java =====
package com.localzero.api.controller;

import com.localzero.api.entity.DirectMessage;
import com.localzero.api.entity.Notification;
import com.localzero.api.entity.Person;
import com.localzero.api.repository.DirectMessageRepository;
import com.localzero.api.service.PersonService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;
import com.localzero.api.repository.NotificationsRepository;
import com.localzero.api.repository.PersonRepository;
import org.springframework.security.core.Authentication;

import java.io.IOException;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Controller
@RequestMapping("/messages")
public class MessageController {

    @Autowired
    private DirectMessageRepository directMessageRepository;  //repository object som Spring Boot skapar varje g√•ng vi kallar directMessageRepository
    @Autowired
    private NotificationsRepository notificationRepo;
    @Autowired
    private PersonRepository personRepo;

    @Autowired
    private SSEController sseController;

    private PersonService personService;

    public MessageController(PersonService personService) {
        this.personService = personService;
    }

    @GetMapping
    public String renderChatPage(Authentication authentication, Model model) {
        String loggedInUserEmail = authentication.getName(); // Get the logged-in user's email

        List<DirectMessage> messages = new ArrayList<>();
        messages.addAll(directMessageRepository.findByReceiverEmail(loggedInUserEmail));
        messages.addAll(directMessageRepository.findBySenderEmail(loggedInUserEmail));

        List<Person> persons = personService.findAll();
        for (Person p : persons)
            System.out.println("Person: " + p);

        model.addAttribute("messages", messages); // Add messages to the model
        model.addAttribute("persons", persons);
        model.addAttribute("user", personService.findByEmail(loggedInUserEmail));

        return "messages"; // Resolves messages.html
    }

    @PostMapping
    @ResponseBody
    public DirectMessage sendMessage(@RequestBody DirectMessage message, Authentication authentication) {
        message.setCreationDatetime(LocalDateTime.now());
        message.setSenderEmail(authentication.getName());
        DirectMessage saved = directMessageRepository.save(message);

        // Notify receiver via SSE
        sseController.sendMessageToReceiver(message.getReceiverEmail(), saved);

        Notification n = new Notification();
        n.setPerson(personRepo.findById(message.getReceiverEmail()).orElseThrow());
        n.setDescription("New Message from " + message.getSenderEmail());
        n.setRead(false);
        n.setCreationDatetime(LocalDateTime.now()); //Vet inte om det beh√∂vs riktigt
        notificationRepo.save(n);

        return saved;
    }

    @PostMapping(value = "/image", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    @ResponseBody
    public DirectMessage sendImageMessage(
            @RequestParam("senderEmail") String senderEmail,
            @RequestParam("receiverEmail") String receiverEmail,
            @RequestParam("file") MultipartFile file) throws IOException {

        DirectMessage message = new DirectMessage();
        message.setSenderEmail(senderEmail);
        message.setReceiverEmail(receiverEmail);
        message.setCreationDatetime(LocalDateTime.now());
        message.setContent("image");
        message.setImageData(file.getBytes());

        DirectMessage saved = directMessageRepository.save(message);

        Notification n = new Notification();
        n.setPerson(personRepo.findById(message.getReceiverEmail()).orElseThrow());
        n.setDescription("New Message from " + message.getSenderEmail());
        n.setRead(false);
        n.setCreationDatetime(LocalDateTime.now()); //Vet inte om det beh√∂vs riktigt, men kanske f√∂r att sortera notifications!!
        notificationRepo.save(n);
        return saved;
    }

    @GetMapping("/image/{id}")
    @ResponseBody
    public ResponseEntity<byte[]> getImage(@PathVariable long id) {  //Skickar tillbaka bildens inneh√•ll som bytes
        DirectMessage message = directMessageRepository.findById(id).orElseThrow();
        return ResponseEntity.ok().contentType(MediaType.IMAGE_JPEG).body(message.getImageData());
    }

    @GetMapping(value = "/{email}")
    @ResponseBody
    public List<DirectMessage> getMessages(@PathVariable String email, Authentication authentication) { //@RequestParam f√•r d√• users mail. Frontend viktigt att best√§mma users mail p√• r√§tt s√§tt! S√• att denna metod kan hitta r√§tt
        String loggedInUserEmail = authentication.getName();

        List<DirectMessage> conversation = directMessageRepository.findConversationBetween(loggedInUserEmail, email);

        if (conversation.isEmpty()) {
            DirectMessage initialMessage = new DirectMessage();
            initialMessage.setSenderEmail(loggedInUserEmail);
            initialMessage.setReceiverEmail(email);
            initialMessage.setContent("Conversation started");
            initialMessage.setCreationDatetime(LocalDateTime.now());
            directMessageRepository.save(initialMessage);
            conversation.add(initialMessage);
        }

        return conversation;
    }
}

===== ./java/com/localzero/api/controller/NotificationController.java =====
package com.localzero.api.controller;

import com.localzero.api.entity.Notification;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;
import com.localzero.api.repository.NotificationsRepository;
import java.util.List;

@RestController
@RequestMapping("/notifications")
public class NotificationController {

    @Autowired
    private NotificationsRepository notificationsRepository;

    @GetMapping
    public List<Notification> getUnread (@RequestParam String email) {

        return notificationsRepository.findByPersonEmailAndIsReadFalse(email);


    }

    @PutMapping ("/{id}/read")
    public void markAsRead(@PathVariable long id) {
        Notification n = notificationsRepository.findById(id).orElseThrow();
        n.setRead(true);
        notificationsRepository.save(n);
    }

}


===== ./java/com/localzero/api/controller/PostController.java =====
package com.localzero.api.controller;


import com.localzero.api.service.InitiativeService;
import com.localzero.api.service.PostService;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import com.localzero.api.template.PostCreator;

@Controller
public class PostController {
    private final PostService postService;
    private final PostCreator pCreator;
    private final InitiativeService inservice;

    public PostController(PostService postService, PostCreator pCreator, InitiativeService inservice) {
        this.postService = postService;
        this.pCreator = pCreator;
        this.inservice = inservice;

    }

    @GetMapping("/create-post")
    public String ShowCreatedPostFrom(Model model, @AuthenticationPrincipal UserDetails currentUser) {
        if(currentUser != null){
            model.addAttribute("initiatives",inservice.getByParticipant(currentUser.getUsername()));
        }else {
            model.addAttribute("initiatives",inservice.getAll());

        }
        return "create-post";
    }

    @PostMapping("/create-post")
    public String createPost(@RequestParam String content,@RequestParam(required = false) Long initiativeId ,@AuthenticationPrincipal UserDetails currentUser) {
        if (currentUser == null) {
            return "redirect:/login";
        }
        pCreator.create(currentUser.getUsername(), content, initiativeId);

        if(initiativeId != null){
            return "redirect:/initiatives/"+initiativeId;
        }

        return "redirect:/feed";
    }


    @PostMapping("/posts/{id}/like")
    public String likePost(@PathVariable long id,
                           @RequestParam String source,
                           @AuthenticationPrincipal UserDetails currentUser) {
        if (currentUser == null) {
            return "redirect:/login";
        }

        postService.incrementLikes(id);

        if ("feed".equals(source)) {
            return "redirect:/feed";
        } else {
            String email = currentUser.getUsername();
            return "redirect:/profile/" + email;
        }
    }

}


===== ./java/com/localzero/api/controller/ProfileController.java =====
package com.localzero.api.controller;

import com.localzero.api.entity.Community;
import com.localzero.api.entity.Person;
import com.localzero.api.entity.Post;
import com.localzero.api.repository.CommunityRepository;
import com.localzero.api.service.PersonService;
import com.localzero.api.service.PostService;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;

import java.util.HashSet;
import java.util.List;
import java.util.Optional;
import java.util.Set;

@Controller
@RequestMapping("/profile")
public class ProfileController {
    private final PersonService personService;
    private final PostService postService;
    private final CommunityRepository communityRepository;

    public ProfileController(PersonService personService, PostService postService, CommunityRepository communityRepository) {
        this.personService = personService;
        this.postService = postService;
        this.communityRepository = communityRepository;
    }

    @GetMapping
    public String myProfile(Model model, @AuthenticationPrincipal UserDetails currentUser) {
        if (currentUser == null) {
            return "redirect:/login";
        }

        String email = currentUser.getUsername();
        Person user = personService.findByEmail(email);
        List<Post> posts = postService.getPostsByAuthorEmail(email);

        model.addAttribute("user", user);
        model.addAttribute("posts", posts);
        model.addAttribute("allCommunities", communityRepository.findAll());
        model.addAttribute("source", "profile");
        return "profile";
    }

    @GetMapping("/{email}")
    public String OtherProfile(@PathVariable String email, Model model) {
        Optional<Person> optionalUser = personService.findOptionalByEmail(email);

        if (optionalUser.isEmpty()) {
            model.addAttribute("message", "Anv√§ndaren med e-post '" + email + "' hittades inte.");
            return "user-not-found";
        }
        Person user = optionalUser.get();
        List<Post> posts = postService.getPostsByAuthorEmail(email);
        model.addAttribute("user", user);
        model.addAttribute("posts", posts);
        model.addAttribute("allCommunities", communityRepository.findAll());
        model.addAttribute("source", "profile");
        return "profile";
    }

    @PostMapping("/communities")
    public String updateCommunities(@RequestParam List<Long> communityIds, Authentication authentication) {
        String email = authentication.getName();
        Person user = personService.findByEmail(email);
        Set<Community> selected = new HashSet<>(communityRepository.findAllById(communityIds));
        user.setCommunities(selected);
        personService.save(user);
        return "redirect:/profile";
    }

}



===== ./java/com/localzero/api/controller/RegistrationController.java =====
package com.localzero.api.controller;

/**
 * @author: Andr√©
 */

import com.localzero.api.entity.Person;
import com.localzero.api.entity.UserRoleAssignment;
import com.localzero.api.enumeration.UserRole;
import com.localzero.api.repository.PersonRepository;
import lombok.Data;
import lombok.SneakyThrows;
import org.antlr.v4.runtime.misc.LogManager;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.util.List;

@Controller
public class RegistrationController {

    @Autowired
    private PersonRepository personRepository;

    @GetMapping("/register")
    public String showRegistrationForm(Model model){
        return "register";
    }

//    @PostMapping( "/register")
//    public Person createPerson(@RequestBody Person person) {
//        // L√∂senord ej krypterade, Spring Security beh√∂ver d√§rf√∂r {noop} prefix
//        person.setPassword("{noop}" + person.getPassword());
//        //Save sparar personen till databasen (blir en insert into person osv automatiskt)
//        return personRepository.save(person);
//    }


    // Denna metod anv√§nds f√∂r att hantera registrering av nya anv√§ndare
    @SneakyThrows
    @PostMapping("/register")
    public String handleRegister(@RequestBody RegistrationRequest rq) {
        try {
            Person person = new Person();
            person.setName(rq.getName());
            person.setEmail(rq.getEmail());
            person.setPassword("{noop}" + rq.getPassword()); // L√§gger till {noop} prefix f√∂r att undvika kryptering
            if (person.getProfilePic() != null && person.getProfilePic().length == 0) {
                person.setProfilePic(null);
            }
            personRepository.save(person);
            System.out.println("Person saved!!!!!!!!");
            return "redirect:/login"; // Omregistrering lyckades, omdirigera till inloggning
        } catch (Exception e) {
            System.out.println("Redirect failed!!!!!!!!");
            e.printStackTrace();
            return "error"; // Om n√•got g√•r fel, returnera ett felmeddelande
        }
    }
}

@Data
class RegistrationRequest {
    private String name;
    private String email;
    private String password;
    private byte[] profilePicture;
    private List<UserRole> roles;
}


===== ./java/com/localzero/api/controller/SSEController.java =====
package com.localzero.api.controller;

import org.springframework.web.bind.annotation.*;
import org.springframework.web.servlet.mvc.method.annotation.SseEmitter;
import java.util.concurrent.*;

@RestController
@RequestMapping("/sse")
public class SSEController {

    private final ConcurrentMap<String, SseEmitter> emitters = new ConcurrentHashMap<>();

    @GetMapping("/messages/{email}")
    public SseEmitter streamMessages(@PathVariable String email) {
        SseEmitter emitter = new SseEmitter(Long.MAX_VALUE);
        emitters.put(email, emitter);
        emitter.onCompletion(() -> emitters.remove(email));
        emitter.onTimeout(() -> emitters.remove(email));
        return emitter;
    }

    // Call this method when a new message is sent
    public void sendMessageToReceiver(String receiverEmail, Object message) {
        SseEmitter emitter = emitters.get(receiverEmail);
        if (emitter != null) {
            try {
                emitter.send(message);
            } catch (Exception e) {
                emitters.remove(receiverEmail);
            }
        }
    }
}

===== ./java/com/localzero/api/controller/UserRoleController.java =====
package com.localzero.api.controller;


import com.localzero.api.entity.Person;
import com.localzero.api.enumeration.UserRole;
import com.localzero.api.entity.UserRoleAssignment;
import com.localzero.api.repository.PersonRepository;
import com.localzero.api.repository.UserRoleAssignmentRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;
import java.util.List;

@RestController
@RequestMapping("/roles")
public class UserRoleController {

    @Autowired
    private UserRoleAssignmentRepository roleRepo;
    @Autowired
    private PersonRepository personRepo;

    @PostMapping
    public UserRoleAssignment assignRole(@RequestParam String email, @RequestParam UserRole role) {

        Person p = personRepo.findById(email).orElseThrow();

        UserRoleAssignment assignment = new UserRoleAssignment();
        assignment.setPerson(p);
        assignment.setRole(role);
        return roleRepo.save(assignment);
        
    }

    @GetMapping
    public List<UserRoleAssignment> getRoles(@RequestParam String email) {
        return roleRepo.findByPersonEmail(email);
    }

}


===== ./java/com/localzero/api/entity/Community.java =====
package com.localzero.api.entity;

/**
 * @author: Andr√© , Emil
 */

import jakarta.persistence.*;
import lombok.Data;

import java.io.Serializable;

@Entity
@Data
//@IdClass(Community.class)
public class Community {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;


    @Column(name = "member_email", nullable = false)
    private String memberEmail;

}
/*
@Data
class CommunityId implements Serializable {
    private Long id;
    private String memberEmail;
}

 */

===== ./java/com/localzero/api/entity/DirectMessage.java =====
package com.localzero.api.entity;

/**
 * @author: Adrian , Emil
 */

import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.Data;

import java.time.LocalDateTime;

@Entity
@Data
//@IdClass(DirectMessageId.class)
public class DirectMessage {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;


    @Column(name = "sender_email", nullable = false)
    private String senderEmail;


    @Column(name = "receiver_email", nullable = false)
    private String receiverEmail;

    @ManyToOne
    @JoinColumn(name = "sender_email", referencedColumnName = "email", insertable = false, updatable = false)
    @JsonIgnore
    private Person sender;

    @ManyToOne
    @JoinColumn(name = "receiver_email", referencedColumnName = "email", insertable = false, updatable = false)
    @JsonIgnore
    private Person receiver;

    @Column(name = "content", nullable = false)
    private String content;

    @Column(name = "creation_datetime", nullable = false)
    private LocalDateTime creationDatetime;

    @Lob
    @Column(name = "image_data")
    private byte[] imageData;
}
/*
@Data
class DirectMessageId implements Serializable {
    private String senderEmail;
    private String receiverEmail;
}

 */


===== ./java/com/localzero/api/entity/EcoAction.java =====
package com.localzero.api.entity;
import jakarta.persistence.*;
import lombok.Data;

/**
 * @author: Mahyar, Emil
 */

@Entity
@Data
@Table(name = "eco_action")
public class EcoAction {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "author_email",nullable = false)
    private String authorEmail;

    /*
    @Id
    @Column(name = "author_email")
    private String authorEmail;

     */

    @Column(name = "community_id",nullable = false)
    private Long communityId;

    private String content;

    @Column(name = "carbon_savings")
    private Float carbonSavings;

    @ManyToOne
    @JoinColumn(name = "community_id", referencedColumnName = "id", insertable = false, updatable = false)
    private Community community;
}


===== ./java/com/localzero/api/entity/Initiative.java =====
package com.localzero.api.entity;

/**
 * @author Andr√©
 * @author Emil
 */

import com.localzero.api.enumeration.InitiativeCategory;
import jakarta.persistence.*;
import lombok.Data;

import java.time.LocalDateTime;
import java.util.HashSet;
import java.util.Set;

@Entity
@Data
public class Initiative {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne
    @JoinColumn(name = "creator_email", referencedColumnName = "email", nullable = false)
    private Person creator;

    @Column(nullable = false)
    private String title;

    @Column(nullable = false,columnDefinition = "TEXT")
    private String description;

    @Column(nullable = false)
    private String location;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private InitiativeCategory category;

    @Column(name = "start_date",nullable = false)
    private LocalDateTime startDate;

    @Column(name = "end_date",nullable = false)
    private LocalDateTime endDate;

    @Column(name = "is_public",nullable = false)
    private boolean isPublic;

    @Column(name = "creation_datetime", nullable = false)
    private LocalDateTime creationDatetime;

    @ManyToMany
    @JoinTable(
            name = "initiative_community",
            joinColumns = @JoinColumn(name = "initiative_id"),
            inverseJoinColumns = @JoinColumn(name = "community_id")
    )
    private Set<Community> communities = new HashSet<>();

    @ManyToOne
    @JoinColumn(name = "communitymember_email", referencedColumnName = "email", nullable = false)
    private Person communityMember;

    @ManyToMany
    @JoinTable(
            name = "initiative_participant",
            joinColumns = @JoinColumn(name = "initiative_id"),
            inverseJoinColumns = @JoinColumn(name = "participant_email")
    )
    private Set<Person> participants = new HashSet<>();

}


===== ./java/com/localzero/api/entity/InitiativeParticipant.java =====
/*
package com.localzero.api.entity;

/**
 * @author Andr√© , Emil
 */

import jakarta.persistence.*;
import lombok.Data;

import java.io.Serializable;
/*
@Entity
@Data
//@IdClass(InitiativeParticipantId.class)
public class InitiativeParticipant {

    @EmbeddedId
    private InitiativeParticipantId initiativeParticipantId = new InitiativeParticipantId();
/*
    @Id
    @Column(name = "initiative_id", nullable = false)
    private Long initiativeId;

 */
/*
    @Id
    @Column(name = "participant_email", nullable = false)
    private String participantEmail;

 */
/*
    @ManyToOne
    @MapsId("initiativeId")
    @JoinColumn(name = "initiative_id", referencedColumnName = "id", insertable = false, updatable = false)
    private Initiative initiative;

    @ManyToOne
    @MapsId("participantEmail")
    @JoinColumn(name = "participant_email", referencedColumnName = "email", insertable = false, updatable = false)
    private Person participant;
}
/*
@Data
class InitiativeParticipantId implements Serializable {
    private Long initiativeId;
    private String participantEmail;
}

 */





===== ./java/com/localzero/api/entity/Notification.java =====
package com.localzero.api.entity;

/**
 * @author Adrian Von kr√∂sus Schwenssonmssims üíÄ
 */

import jakarta.persistence.*;
import lombok.Data;

import java.time.LocalDateTime;

    @Entity
    @Data
    public class Notification {

        @Id
        @GeneratedValue(strategy = GenerationType.IDENTITY)
        private Long id;

        @ManyToOne
        @JoinColumn(name = "email", referencedColumnName = "email", nullable = false)
        private Person person;

        @Column(name = "description", nullable = false)
        private String description;

        @Column(name = "creation_datetime", nullable = false)
        private LocalDateTime creationDatetime;

        @Column(name = "is_read")
        private boolean isRead = false;

    }



===== ./java/com/localzero/api/entity/Person.java =====
package com.localzero.api.entity;

/**
 * @author Andr√©
 */

import jakarta.persistence.*;
import lombok.Data;

import java.util.HashSet;
import java.util.Set;

@Entity
@Data
public class Person {

    @Id
    private String email;

    private String name;

    private String password;

    @Lob
    @Basic(fetch = FetchType.LAZY)
    @Column(name = "profile_pic")
    private byte[] profilePic;

    @ManyToMany
    private Set<Community> communities = new HashSet<>();
}

===== ./java/com/localzero/api/entity/Post.java =====
package com.localzero.api.entity;

/**
 * @author Emil
 * @author Mahyar
 */

import jakarta.persistence.*;
import lombok.Data;
import com.localzero.api.template.TimeStampEntry;

import java.time.LocalDateTime;

@Entity
@Data
public class Post implements TimeStampEntry{

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne
    @JoinColumn(name = "initiative_id")
    private Initiative initiative;

    @ManyToOne
    @JoinColumn(name = "author_email", referencedColumnName = "email")
    private Person author;

    private String content;

    @Lob
    private byte[] image;

    private int likesCount;

    @Column(name = "creation_datetime")
    private LocalDateTime creationDatetime;

    @PrePersist
    private void onCreate() {
        creationDatetime = LocalDateTime.now();
        likesCount = 0;
    }

    
}


===== ./java/com/localzero/api/entity/PostComment.java =====
package com.localzero.api.entity;

/**
 * @author Emil
 */

import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.NoArgsConstructor;
import lombok.Data;

import java.io.Serializable;
import java.time.LocalDateTime;

@Entity
@Data
public class PostComment {

    @EmbeddedId
    private PostCommentId id = new PostCommentId();

    @ManyToOne
    @MapsId("postId")
    @JoinColumn(name = "post_id", referencedColumnName = "id", nullable = false)
    private Post post;

    @ManyToOne
    @MapsId("memberEmail")
    @JoinColumn(name = "author_email", referencedColumnName = "email", nullable = false)
    private Person author;

    private String content;

    @Column(nullable = false)
    private LocalDateTime creationDatetime;

}
/*
@AllArgsConstructor
@NoArgsConstructor

 */
@Data
class PostCommentId implements Serializable {
    private Long postId;
    private String memberEmail;
}

===== ./java/com/localzero/api/entity/UserRoleAssignment.java =====
package com.localzero.api.entity;

import jakarta.persistence.Entity;
import jakarta.persistence.*;
import lombok.Data;
import com.localzero.api.enumeration.UserRole;

@Entity
@Data
public class UserRoleAssignment {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(optional = false)
    @JoinColumn(name = "email", referencedColumnName = "email")
    private Person person;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private UserRole role;

}


===== ./java/com/localzero/api/enumeration/InitiativeCategory.java =====
package com.localzero.api.enumeration;

public enum InitiativeCategory {
    TOOL_SHARING,
    FOOD_SWAP,
    GARDENING,
    RECYCLING,
    RIDE_SHARING,
    ENVIRONMENT
}


===== ./java/com/localzero/api/enumeration/UserRole.java =====
package com.localzero.api.enumeration;

public enum UserRole {

    RESIDENT,
    ORGANIZER,
    ADMIN
}


===== ./java/com/localzero/api/LocalZeroApplication.java =====
package com.localzero.api;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class LocalZeroApplication {

    public static void main(String[] args) {
        SpringApplication.run(LocalZeroApplication.class, args);
    }
}


===== ./java/com/localzero/api/repository/CommunityRepository.java =====
package com.localzero.api.repository;

import com.localzero.api.entity.Community;
import org.springframework.data.jpa.repository.JpaRepository;

public interface CommunityRepository extends JpaRepository<Community,Long> {
}


===== ./java/com/localzero/api/repository/DirectMessageRepository.java =====
package com.localzero.api.repository;

import com.localzero.api.entity.DirectMessage;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;

import java.util.List;

public interface DirectMessageRepository extends JpaRepository<DirectMessage, Long> {

    @Query("""
        SELECT dm FROM DirectMessage dm
        WHERE (dm.senderEmail = :user1 AND dm.receiverEmail = :user2)
           OR (dm.senderEmail = :user2 AND dm.receiverEmail = :user1) 
        ORDER BY dm.creationDatetime
    """)
    //OR f√∂r att se b√•da Conversations
    List<DirectMessage> findConversationBetween(String user1, String user2);

    List<DirectMessage> findByReceiverEmail(String receiverEmail);

    List<DirectMessage> findBySenderEmail(String senderEmail);

}


===== ./java/com/localzero/api/repository/InitiativeRepository.java =====
package com.localzero.api.repository;

import com.localzero.api.entity.Community;
import com.localzero.api.entity.Initiative;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

import java.util.List;
import java.util.Set;

public interface InitiativeRepository extends JpaRepository<Initiative,Long> {
    List<Initiative> findByCreatorEmail(String email);
    @Query("""
        SELECT i FROM Initiative i
        JOIN i.participants p
        WHERE p.email = :email
    """)
    List<Initiative> findByParticipantEmail(@Param("email") String email);
    List<Initiative> findByIsPublicTrueOrCommunitiesContaining(Community community);
    List<Initiative> findByIsPublicTrue();

    List<Initiative> findByIsPublicTrueOrCommunitiesIn(Set<Community> communities);

}


===== ./java/com/localzero/api/repository/NotificationsRepository.java =====
package com.localzero.api.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import com.localzero.api.entity.Notification;
import java.util.List;


public interface NotificationsRepository extends JpaRepository<Notification, Long> {

    List<Notification>findByPersonEmailAndIsReadFalse(String email);
}



===== ./java/com/localzero/api/repository/PersonRepository.java =====
package com.localzero.api.repository;
import com.localzero.api.entity.Person;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;
import java.util.Optional;

public interface PersonRepository extends JpaRepository<Person,String> {
    Optional<Person> findByEmail(String email);
    List<Person> findAll();
    List<Person> findByEmailNot(String email);
}


===== ./java/com/localzero/api/repository/PostRepository.java =====
package com.localzero.api.repository;

import com.localzero.api.entity.Post;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface PostRepository extends JpaRepository<Post, Long> {
    List<Post> findByAuthorEmailOrderByCreationDatetimeDesc(String authorEmail);

    List<Post> findByInitiativeIsNullOrderByCreationDatetimeDesc();

    List<Post> findByInitiativeIdOrderByCreationDatetimeDesc(Long initiativeId);
}


===== ./java/com/localzero/api/repository/UserRoleAssignmentRepository.java =====
package com.localzero.api.repository;

import com.localzero.api.entity.UserRoleAssignment;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface UserRoleAssignmentRepository extends JpaRepository<UserRoleAssignment, Long> {
    List<UserRoleAssignment> findByPersonEmail(String email);
}

===== ./java/com/localzero/api/security/SecurityConfiguration.java =====
package com.localzero.api.security;

import com.localzero.api.service.PersonService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationProvider;
import org.springframework.security.authentication.dao.DaoAuthenticationProvider;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.crypto.password.NoOpPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
@EnableWebSecurity
public class SecurityConfiguration {

    @Autowired
    private PersonService personService;

    @Bean
    public UserDetailsService userDetailsService() {
        return personService;
    }

    @Bean
    public AuthenticationProvider authenticationProvider() {
        DaoAuthenticationProvider authProvider = new DaoAuthenticationProvider();
        authProvider.setUserDetailsService(personService);
        return authProvider;
    }

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity httpSecurity) throws Exception {
        return httpSecurity
                .csrf(AbstractHttpConfigurer::disable)
                .formLogin(httpForm -> {
                    httpForm
                            .loginPage("/login")
                            .usernameParameter("email")
                            .permitAll();
                    httpForm.defaultSuccessUrl("/feed", true); // Redirect to /feed after login
                })
                .authorizeHttpRequests(registry -> {
                    registry
                            .requestMatchers("/register", "/css/**", "/js/**").permitAll()
                            .anyRequest().authenticated();
                })
                .build();
    }
}


===== ./java/com/localzero/api/service/InitiativeService.java =====
package com.localzero.api.service;

import com.localzero.api.entity.Community;
import com.localzero.api.entity.Initiative;
import com.localzero.api.entity.Person;
import com.localzero.api.repository.InitiativeRepository;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

@Service
public class InitiativeService {
    private final InitiativeRepository ir;
    private final PersonService personService;

    public InitiativeService(InitiativeRepository ir, PersonService personService){
        this.ir = ir;
        this.personService = personService;
    }

    public List<Initiative> getAll(){
        return ir.findAll();
    }

    public List<Initiative> getByParticipant(String email){
        return ir.findByParticipantEmail(email);
    }
    public Initiative getById(Long id){
        return ir.findById(id).orElseThrow();
    }

    public List<Initiative> getAllPublic() {
        return ir.findByIsPublicTrue();
    }

    public List<Initiative> getPublicOrByCommunity(Community community) {
        return ir.findByIsPublicTrueOrCommunitiesContaining(community);
    }

    public List<Initiative> getPublicOrByCommunities(Set<Community> communities) {
        return ir.findByIsPublicTrueOrCommunitiesIn(communities);
    }

    public List<Initiative> getVisibleForUser(Person person) {
        Set<Community> communities = person.getCommunities();
        String email = person.getEmail();

        Set<Initiative> all = new HashSet<>();
        all.addAll(ir.findByIsPublicTrueOrCommunitiesIn(communities));
        all.addAll(ir.findByCreatorEmail(email));

        return new ArrayList<>(all);
    }

    public void addParticipant(Long initiativeId, String email) {
        Initiative initiative = ir.findById(initiativeId).orElseThrow();
        Person person = personService.findByEmail(email);
        initiative.getParticipants().add(person);
        ir.save(initiative);
    }

}


===== ./java/com/localzero/api/service/PersonService.java =====
package com.localzero.api.service;

import com.localzero.api.entity.Person;
import com.localzero.api.repository.PersonRepository;
import lombok.AllArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

import java.util.Optional;
import java.util.List;

@Service
@AllArgsConstructor
public class PersonService implements UserDetailsService {

    @Autowired
    private final PersonRepository personRepository;

    @Override
    public UserDetails loadUserByUsername(String email) throws UsernameNotFoundException {
        System.out.println("Loading user by email: " + email);
        Optional<Person> person = personRepository.findByEmail(email);
        if (person.isPresent()) {
            var personObj = person.get();
            return User.builder().
                    username(personObj.getEmail()).
                    password(personObj.getPassword()).
                    build();
        } else {
            throw new UsernameNotFoundException("User not found with email: " + email);
        }
    }

    public Person findByEmail(String email) {
        return personRepository.findByEmail(email).orElseThrow(() -> new RuntimeException("User not found"));
    }

    public List<Person> findAll() {
        return personRepository.findAll();
    }

    public Optional<Person> findOptionalByEmail(String email) {
        return personRepository.findById(email);
    }

    public void save(Person person) {
        personRepository.save(person);
    }
}


===== ./java/com/localzero/api/service/PostService.java =====
package com.localzero.api.service;

import com.localzero.api.entity.Post;
import com.localzero.api.repository.PostRepository;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class PostService {

    private final PostRepository postRepository;

    public PostService(PostRepository postRepository) {
        this.postRepository = postRepository;
    }

    public List<Post> getPostsByAuthorEmail(String email) {
        return postRepository.findByAuthorEmailOrderByCreationDatetimeDesc(email);
    }

    public Post save(Post post) {
        return postRepository.save(post);
    }

    public List<Post> getAllStandalonePosts() {
        return postRepository.findByInitiativeIsNullOrderByCreationDatetimeDesc();
    }

    public List<Post> getPostsByInitiativeId(Long initiativeId) {
        return postRepository.findByInitiativeIdOrderByCreationDatetimeDesc(initiativeId);
    }

    public void incrementLikes(long postId) {
        Post post = postRepository.findById(postId).orElseThrow();
        post.setLikesCount(post.getLikesCount() + 1);
        postRepository.save(post);
    }
}


===== ./java/com/localzero/api/template/AbstractCreator.java =====
package com.localzero.api.template;

import com.localzero.api.entity.Person;
import com.localzero.api.entity.Post;
import com.localzero.api.template.TimeStampEntry;

import java.time.LocalDateTime;

public abstract class AbstractCreator<T extends TimeStampEntry> {

    public final T create(String email, String content){
        Person user = loadUser(email);
        T entity = build(user,content);
        setTimestamps(entity);
        return persist(entity);
    }

    protected abstract Person loadUser(String email);
    protected abstract T build(Person user,String content);
    protected abstract void setTimestamps(T entity);
    protected abstract T persist(T entity);

}


===== ./java/com/localzero/api/template/AbstractInitiativeCreator.java =====
package com.localzero.api.template;

import com.localzero.api.entity.Initiative;
import com.localzero.api.entity.Person;

import java.time.LocalDateTime;

public abstract class AbstractInitiativeCreator {
    public final Initiative create(String email, Initiative initiative){
        Person user = loadUser(email);
        initiativedetailer(user,initiative);
        initiative.setCreationDatetime(LocalDateTime.now());
        return save(initiative);
    }

    protected abstract Person loadUser(String email);
    protected abstract  void initiativedetailer(Person user, Initiative initiative);
    protected abstract Initiative save(Initiative initiative);
}


===== ./java/com/localzero/api/template/InitiativeCreator.java =====
package com.localzero.api.template;

import com.localzero.api.entity.Initiative;
import com.localzero.api.entity.Person;
import com.localzero.api.repository.InitiativeRepository;
import com.localzero.api.service.PersonService;
import org.springframework.stereotype.Service;

@Service
public class InitiativeCreator extends AbstractInitiativeCreator {

    private final InitiativeRepository ir;
    private final PersonService ps;

    public InitiativeCreator(InitiativeRepository ir, PersonService ps){
        this.ir = ir;
        this.ps = ps;
    }

    @Override
    protected Person loadUser(String email) {
        return ps.findByEmail(email);
    }

    @Override
    protected void initiativedetailer(Person user, Initiative initiative) {
        initiative.setCreator(user);
        initiative.setCommunityMember(user);
        initiative.getParticipants().add(user);
    }

    @Override
    protected Initiative save(Initiative initiative) {
        Initiative saved = ir.save(initiative);
        System.out.println(" SPARAT: ID=" + saved.getId() + " - " + saved.getTitle());
        return saved;
    }
}



===== ./java/com/localzero/api/template/PostCreator.java =====
package com.localzero.api.template;

import com.localzero.api.entity.Initiative;
import com.localzero.api.entity.Person;
import com.localzero.api.entity.Post;
import com.localzero.api.repository.InitiativeRepository;
import com.localzero.api.repository.PostRepository;
import com.localzero.api.service.PersonService;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;

@Service
public class PostCreator extends AbstractCreator<Post> {

    private final PostRepository postRepo;
    private final PersonService personService;
    private final InitiativeRepository initiativeRepository;

    public PostCreator(PostRepository postRepo, PersonService personService, InitiativeRepository initiativeRepository){
        this.postRepo = postRepo;
        this.personService = personService;
        this.initiativeRepository = initiativeRepository;
    }

    @Override
    protected Person loadUser(String email) {
        return personService.findByEmail(email);
    }

    @Override
    protected Post build(Person user,String content) {
        Post post = new Post();
        post.setAuthor(user);
        post.setContent(content);
        post.setLikesCount(0);
        return post;
    }

    public Post create(String email, String content,Long initiativeId){
        Post post = super.create(email,content);
        if (initiativeId != null){
            Initiative initiative = initiativeRepository.findById(initiativeId).orElseThrow(()->new IllegalArgumentException("The initiative does not exist!"));
            post.setInitiative(initiative);
        }
        return postRepo.save(post);
    }

    @Override
    protected void setTimestamps(Post entity) {
        entity.setCreationDatetime(LocalDateTime.now());
    }

    @Override
    protected Post persist(Post entity) {
        return postRepo.save(entity);
    }


}


===== ./java/com/localzero/api/template/TimeStampEntry.java =====
package com.localzero.api.template;

import java.time.LocalDateTime;

public interface TimeStampEntry {
    void setCreationDatetime(LocalDateTime dateTime);
}


===== ./resources/application-secrets.properties =====
spring.datasource.password=hx408oft
spring.datasource.username=ac9996

===== ./resources/application.properties =====
spring.application.name=LocalZero
spring.config.import=optional:application-secrets.properties
spring.datasource.url=jdbc:postgresql://pgserver.mau.se:5432/localzerooo
spring.datasource.username=${spring.datasource.username}
spring.datasource.password=${spring.datasource.password}
spring.datasource.hikari.maximum-pool-size=2
spring.jpa.hibernate.ddl-auto= create-drop
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true
logging.level.org.hibernate.type.descriptor.sql=TRACE
spring.thymeleaf.prefix=classpath:/templates/
spring.thymeleaf.suffix=.html



===== ./resources/static/css/dm.css =====
.new-chat-btn {
    margin: 10px 20px;
    padding: 10px 20px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.new-chat-dialog {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    z-index: 1000;
    max-height: 80vh;
    overflow-y: scroll;
}

.dialog-backdrop {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 999;
}

.person-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
}

.person-item:hover {
    background-color: #f5f5f5;
}

.messages-layout {
    display: flex;
    height: calc(100vh - 60px); /* Full height minus navbar */
    overflow: hidden; /* Prevent layout scrolling */
}

.dm-container {
    width: 30%;
    border-right: 1px solid #ddd;
    overflow-y: scroll;
    padding: 20px;
    background: rgba(255, 255, 255, 0.9);
}

.chat-container {
    width: 70%;
    overflow-y: scroll;
    padding: 20px;
    background: rgba(255, 255, 255, 0.9);
}

/* Custom scrollbar styling */
.dm-container::-webkit-scrollbar,
.chat-container::-webkit-scrollbar {
    width: 8px;
}

.dm-container::-webkit-scrollbar-thumb,
.chat-container::-webkit-scrollbar-thumb {
    background-color: #888;
    border-radius: 4px;
}

.dm-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
}

.dm-item:hover {
    background-color: #f5f5f5;
}



===== ./resources/static/css/feed.css =====
body{
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI',sans-serif;
    background-image: url("https://www.psdstack.com/wp-content/uploads/2019/08/copyright-free-images-750x420.jpg");
    background-repeat: no-repeat;
    background-size: cover;
    background-position: center;
    min-height: 100vh;
}

.feed-wrapper{
    max-width: 800px;
    margin: 2rem auto;
    padding: 1rem;
    background-color: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 15px;
    backdrop-filter: blur(15px);
    box-shadow: 0 0 20px rgba(0,0,0,0.2);
}

.feed-post{
    background: rgba(255,255,255,0.15);
    border-radius: 10px;
    margin-bottom: 1rem;
    padding: 1rem;
    color: black;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

.feed-post-header{
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    color: #333;
}

.feed-post-content{
    font-size: 1rem;
    line-height: 1.4;
    color: #111;
}

.feed-post img{
    max-width: 100%;
    border-radius: 8px;
    margin-top: 0.5rem;
}

.feed-actions{
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.feed-actions button{
    background-color: #ffffffcc;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s;
}

.feed-actions button:hover{
    background-color: white;
}

.likes-count{
    font-size: 0.9rem;
    color: #222;
}

.navbar{
    display: flex;
    justify-content: space-between;
    background-color: #2c3e50;
    padding: 1rem 2rem;
    color: white;
}
.navbar a{
    color: white;
    text-decoration: none;
    font-weight: bold;
    margin-left: 1rem;
}
.navbar a:hover{
    text-decoration: underline;
}



===== ./resources/static/css/initiative.css =====
textarea, input[type="text"], input[type="datetime-local"], select {
    border: 2px solid #ffb6c1;
    border-radius: 10px;
    padding: 10px;
    font-size: 16px;
    width: 100%;
    margin-bottom: 12px;
    background-color: rgba(255, 255, 255, 0.8);
}

textarea:focus, input:focus, select:focus {
    outline: none;
    border-color: #ff77b9;
    box-shadow: 0 0 5px #ff7bbe;
}

button {
    background-color: #fd80bf;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

button:hover {
    background-color: #ff7bbe;
}

.create-initiative-container {
    border: 2px solid #ffcce5;
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    backdrop-filter: blur(15px);
    padding: 2rem;
    max-width: 500px;
    margin: 2rem auto;
    box-shadow: 0 0 25px rgba(255, 182, 193, 0.4);
}

.create-initiative-container h2 {
    text-align: center;
    color: #333;
    margin-bottom: 1.5rem;
    font-size: 1.5rem;
}


===== ./resources/static/css/login.css =====
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', sans-serif;
}

body {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background-image: url("https://www.psdstack.com/wp-content/uploads/2019/08/copyright-free-images-750x420.jpg");
    background-repeat: no-repeat;
    background-position: center;
    background-size: cover;
}

section {
    background-color: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 15px;
    backdrop-filter: blur(15px);
    padding: 2rem;
    width: 350px;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
}

.form-container h1 {
    color: black;
    text-align: center;
    margin-bottom: 1rem;
}

.input-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
}

.input-group label {
    color: black;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.input-group input {
    padding: 0.5rem;
    border: none;
    border-radius: 8px;
    outline: none;
}

button {
    width: 100%;
    padding: 0.6rem;
    border: none;
    border-radius: 8px;
    background-color: #ffffffcc;
    font-weight: bold;
    cursor: pointer;
    transition: 0.3s;
}



button:hover {
    background-color: white;
}


===== ./resources/static/css/main.css =====
{
    margin: 0
;
    padding: 0
;
    box-sizing: border-box
;
    font-family: 'Segoe UI', sans-serif
;
}

* {
    font-family: 'Segoe UI', sans-serif;
}

body {
    min-height: 100vh;
    padding-top: 70px;
    background-image: url("https://www.psdstack.com/wp-content/uploads/2019/08/copyright-free-images-750x420.jpg");
    background-repeat: no-repeat;
    background-position: center;
    background-size: cover;
    font-family: 'Segoe UI', sans-serif;
}

.navbar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1000;
    display: flex;
    flex-wrap: wrap; /* M√∂jligg√∂r radbrytning */
    justify-content: center; /* Centrera inneh√•ll i flera rader */
    gap: 1rem;
    background-color: #2c3e50;
    padding: 1rem 2rem;
    color: white;
}

.navbar a {
    color: white;
    text-decoration: none;
    font-weight: bold;
    margin-left: 0.5rem;
}

.navbar a:hover {
    text-decoration: underline;
}

.feed-wrapper {
    max-width: 800px;
    margin: 2rem auto;
    padding: 1rem;
    background-color: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 15px;
    backdrop-filter: blur(15px);
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
}

.chat-message {
    margin-bottom: 15px;
    padding: 10px;
    background: #f1f1f1;
    border-radius: 6px;
}

.messages-layout {
    display: flex;
    height: calc(100vh - 60px); /* Full height minus navbar */
    overflow: hidden; /* Prevent layout scrolling */
}

.dm-container {
    width: 30%;
    border-right: 1px solid #ddd;
    overflow-y: scroll;
    padding: 20px;
    background: rgba(255, 255, 255, 0.9);
}

.chat-container {
    width: 70%;
    overflow-y: scroll;
    padding: 20px;
    background: rgba(255, 255, 255, 0.9);
}

/* Custom scrollbar styling */
.dm-container::-webkit-scrollbar,
.chat-container::-webkit-scrollbar {
    width: 8px;
}

.dm-container::-webkit-scrollbar-thumb,
.chat-container::-webkit-scrollbar-thumb {
    background-color: #888;
    border-radius: 4px;
}

.dm-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
}

.dm-item:hover {
    background-color: #f5f5f5;
}

.like-button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2rem;
    padding: 0;
}

.like-button:hover {
    tansform: scale(1.1);
}

.post-footer {
    text-align: right;
    font-size: 0.8rem;
    color: #555;
    margin-top: 0.5rem;
}

.feed-post {
    background: rgba(255, 255, 255, 0.15);
    border-radius: 10px;
    margin-bottom: 1rem;
    padding: 1rem;
    color: black;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

.feed-post-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    color: #000000;
}

.feed-post-content {
    font-size: 1rem;
    line-height: 1.4;
    color: #000000;
}

.feed-post img {
    max-width: 100%;
    border-radius: 8px;
    margin-top: 0.5rem;
}

.feed-actions {
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.feed-actions button {
    background-color: #ffffffcc;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s;
}

.feed-actions button:hover {
    background-color: white;
}

.likes-count {
    font-size: 0.9rem;
    color: #222;
}

.form-container,
.create-initiative-container {
    background-color: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 15px;
    backdrop-filter: blur(15px);
    padding: 2rem;
    max-width: 350px;
    margin: 2rem auto;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
}

.form-container h1,
.create-initiative-container h1 {
    text-align: center;
    margin-bottom: 1rem;
    color: black;
}

.input-group,
.create-initiative-container .input-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
}

.input-group label,
.create-initiative-container .input-group label {
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: black;
}

.input-group input,
.create-initiative-container .input-group input,
.create-initiative-container .input-group textarea,
textarea {
    padding: 0.5rem;
    border: none;
    border-radius: 8px;
    outline: none;
    resize: vertical;
}

button {
    width: 100%;
    padding: 0.6rem;
    border: none;
    border-radius: 8px;
    background-color: #ffffffcc;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s;
}

button:hover {
    background-color: white;
}

.profile-container {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 2rem;
    margin-top: 3rem;
    flex-wrap: wrap;
    padding: 0 2rem;
}

.profile-card {
    background-color: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.4);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 2rem 3rem;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.25);
    width: 100%;
    max-width: 350px;
    color: #000000;
}


.profile-card h1 {
    margin-top: 0;
    font-size: 1.8rem;
    color: #000000;
}

.profile-card p {
    font-size: 1rem;
    margin: 0.5rem 0;
    color: #000000;
}

.profile-card strong {
    color: #222;
}

.user-posts {
    flex: 1;
    max-width: 800px;
    min-width: 300px;
}

.user-posts h2 {
    color: #222;
    margin-bottom: 1rem;
}

.post-ball {
    border-radius: 15px;
    background-color: rgba(141, 68, 68, 0.6);
    padding: 4px 10px;
    font-size: 0.9em;
}

.initiative-islands {
    display: flex;
    justify-content: space-between;
    gap: 2rem;
    flex-wrap: wrap;
}

.card-box {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 16px;
    padding: 1.5rem;
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    color: black;
    min-width: 300px;
}

.initiative-left-island {
    flex: 2;
}

.initiative-right-island {
    flex: 1;
    align-self: flex-start;
}

.participant-card {
    border-top: 1px solid currentColor;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
}

.feed-wrapper-container{
    display: flex;
    justify-content: space-between;
    gap: 2rem;
    padding: 2rem;
    flex-wrap: wrap;
}
.initiative-info-row {
    display: flex;
    justify-content: space-between;
    gap: 2rem;
    flex-wrap: wrap;
}

.initiative-details,
.initiative-participants {
    flex: 1;
    min-width: 250px;
}
.post-form-wrapper{
    align-self: flex-start;
    max-width: 400px;
    width: 100%;
    height: auto;
}

===== ./resources/static/css/post.css =====
textarea, select {
    border: 2px solid #ffb6c1;
    border-radius: 10px;
    padding: 10px;
    font-size: 16px;
    width: 100%;
    margin-bottom: 12px;
}

textarea:focus, select:focus {
    outline: none;
    border-color: #ff77b9;
    box-shadow: 0 0 5px #ff7bbe;
}

button {
    background-color: #fd80bf;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
}

button:hover {
    background-color: rgba(255, 123, 194, 0.99);
}

.flex-row {
    display: flex;
    align-items: center;
    gap: 10px;
}

.form-container {
    border: 2px solid #ffcce5;
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    backdrop-filter: blur(15px);
    padding: 2rem;
    max-width: 500px;
    margin: 2rem auto;
    box-shadow: 0 0 25px rgba(255, 182, 193, 0.4);
}

===== ./resources/static/css/profile.css =====
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f4f6f8;
    margin: 0;
    padding: 0;
}

.navbar{
    display: flex;
    justify-content: space-between;
    background-color: #2c3e50;
    padding: 1rem 2rem;
    color: white;
}

.navbar a{
    color: white;
    text-decoration: none;
    font-weight: bold;
    margin-left: 1rem;
}

.navbar a:hover{
    text-decoration: underline;
}

.profile-container {
    display: flex;
    justify-content: center;
    margin-top: 3rem;
}


.profile-card {
    background-color: #ffffff;
    border-radius: 12px;
    padding: 2rem 3rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: 350px;
}

.profile-card h1 {
    margin-top: 0;
    font-size: 2rem;
    color: #333;
}

.profile-card p {
    font-size: 1rem;
    margin: 0.5rem 0;
    color: #555;
}

.profile-card strong {
    color: #222;
}


@media (max-width: 350px) {
    .profile-card {
        padding: 1.5rem;
    }

    .profile-card h1 {
        font-size: 1.5rem;
    }
}

===== ./resources/static/js/dm.js =====
const baseURL = 'http://localhost:8080';

function openNewChatDialog() {
    document.getElementById('dialogBackdrop').style.display = 'block';
    document.getElementById('newChatDialog').style.display = 'block';
}

function closeNewChatDialog() {
    document.getElementById('dialogBackdrop').style.display = 'none';
    document.getElementById('newChatDialog').style.display = 'none';
}

function startChat(email) {
    closeNewChatDialog();

    fetch(baseURL + '/messages/' + email)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log("Chat started with " + email, data);

            const chatArea = document.querySelector('.chat-container .chat-area');
            if (!chatArea) return;
            chatArea.innerHTML = ''; // Clear previous messages

            data.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = 'chat-message';
                msgDiv.innerHTML = `<strong>${msg.senderEmail}:</strong> ${msg.content} <br><small>${msg.creationDatetime}</small>`;
                chatArea.appendChild(msgDiv);
            });

            // Set receiver email for sendMessage
            const sendBtn = document.querySelector('.chat-container .chat-input button');
            if (sendBtn) sendBtn.setAttribute('data-receiver-email', email);

            //Make receiver subscribe to messages
            subscribeToMessages(clientEmail, email);
        })
        .catch(error => {
            console.error('Error starting chat:', error);
        });
}

function sendMessage() {
    const sendBtn = document.querySelector('.chat-container .chat-input button');
    const receiverEmail = sendBtn.getAttribute('data-receiver-email');
    const chatInput = document.getElementById('text-input');
    console.log('Attempt sending: ' + chatInput.value);
    const message = chatInput.value;

    if (!message) {
        alert("Please enter a message");
        return;
    }

    const data = {
        receiverEmail: receiverEmail,
        content: message
    };

    fetch(baseURL + '/messages', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log("Message sent:", data);
            chatInput.value = '';
            startChat(receiverEmail);
        })
        .catch(error => {
            console.error('Error sending message:', error);
        });
}


let sseSource = null;
function subscribeToMessages(clientEmail, receiverEmail) {
    if (sseSource) sseSource.close();
    sseSource = new EventSource('/sse/messages/' + clientEmail);
    console.log(clientEmail + ' subscribed to messages');
    sseSource.onmessage = function(event) {
        const msg = JSON.parse(event.data);
        startChat(receiverEmail);
    };

    sseSource.onerror = function() {
        console.error('Error subscribing to messages');
        sseSource.close();
    };
}

const clientEmail = document.getElementById('clientEmail').value;
document.getElementById('dialogBackdrop').onclick = closeNewChatDialog;


===== ./resources/static/js/register.js =====
const baseURL = 'http://localhost:8080';

document.getElementById("submit").addEventListener('click', (event) => {
    event.preventDefault(); // Prevent default form submission
    submitForm();
});

function submitForm() {
    console.log("Submit button clicked");

    const data = {
        name: document.getElementById('name').value,
        email: document.getElementById('email').value,
        password: document.getElementById('password').value,
        profilePicture: document.getElementById('profilePicture').value
    };

    if (!data.name || !data.email || !data.password) {
        alert("Please fill in all fields");
        return;
    }

    console.log(data);

    const jsonData = JSON.stringify(data);
    fetch(baseURL + '/register', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: jsonData
    })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            }
        })
}

===== ./resources/static/js/script.js =====


===== ./resources/templates/create-initiative.html =====
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Initiative Creator</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/initiative.css">
</head>
<body>
<div th:replace="fragments :: navbar"></div>

<div class="create-initiative-container">
    <h2>Create an Initiative!</h2>
    <form th:action="@{/initiatives/create}" method="post">
        <label for="title">Title: </label><br>
        <input type="text" name="title" id="title" required><br><br>

        <label for="description">Description:</label><br>
        <textarea name="description"  id="description" required></textarea><br><br>

        <label for="location">Location:</label><br>
        <input type="text" name="location" id="location" required><br><br>

        <label for="startDate">Start Date and time:</label><br>
        <input type="datetime-local" name="startDate" id="startDate" required><br><br>

        <label for="endDate">End Date and time:</label><br>
        <input type="datetime-local" name="endDate" id="endDate" required><br><br>

        <label for="category">Category:</label><br>
        <select name="category" id="category" required>
            <option th:each="cat : ${categories}"
                    th:value="${cat}"
                    th:text="${cat}"
            ></option>
        </select><br><br>

        <label for="isPublic">Public Initiative?</label>
        <input type="checkbox" name="isPublic" id="isPublic" value="true"><br><br>

        <label for="communities">Select Communities:</label><br>
        <select name="communityIds" id="communities" multiple size="3">
            <option th:each="c : ${allCommunities}"
                    th:value="${c.id}"
                    th:text="${c.memberEmail}">
            </option>
        </select><br><br>

        <button type="submit">Create Initiative</button>
    </form>
</div>
</body>
</html>


===== ./resources/templates/create-post.html =====
<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Create Post</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/post.css">
</head>
<body>

<div th:replace="fragments :: navbar"></div>

<div class="form-container">
    <h1> Create new post</h1>

    <form th:action="@{/create-post}" method="post">
        <textarea name="content" placeholder="Write your post here" required></textarea>


        <label for="initiativeId">Choose Initiative (Optional):</label>
        <select name="initiativeId" id="initiativeId">
            <option value="">-Public-</option>
            <option th:each="i : ${initiatives}" th:value="${i.id}" th:text="${i.title}"></option>
        </select>
        <button type="submit">Publish</button>
    </form>
</div>

</body>
</html>

===== ./resources/templates/feed.html =====
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LocalZero - Feed</title>
    <link rel="stylesheet" href="/css/main.css">
</head>

<body>

<div th:replace="~{fragments :: navbar}"></div>

<div class="feed-wrapper">
    <div th:each="post : ${posts}">
        <div th:replace="~{fragments :: post(post=${post})}"></div>
    </div>
</div>

</body>
</html>


===== ./resources/templates/fragments.html =====
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>

<div th:fragment="navbar">
    <nav class="navbar">
        <a href="/profile">Profile</a>
        <a href="/messages">Direct Messages</a>
        <a href="/initiatives/feed">Initiatives</a>
        <a href="/feed">Feed</a>
        <a href="/initiatives/new">Create initiative</a>
        <a href="/create-post">Create post</a>
        <a href="/logout">Log Out</a>
    </nav>
</div>

<div th:fragment="profile(user, posts)">
    <div class="profile-container">
        <div class="profile-card">
            <h1 th:text="'Hello,' + ${user.name} + '!'">Hello, User!</h1>
            <p><strong>Email</strong> <span th:text="${user.email}">mail@example.com</span></p>

            <form th:action="@{/profile/communities}" method="post">
                <label>Your Communities:</label><br>
                <div th:each="c : ${allCommunities}">
                    <label>
                        <input type="checkbox"
                               name="communityIds"
                               th:value="${c.id}"
                               th:checked="${user.communities.contains(c)}" />
                        <span th:text="${c.memberEmail}"></span>
                    </label><br>
                </div>
                <br>
                <button type="submit">Update Communities</button>
            </form>
        </div>

        <div class="user-posts">
            <h2>Your posts</h2>

            <div th:if="${#lists.isEmpty(posts)}">
                <p>You have not posts yet!</p>
            </div>
            <div th:each="post : ${posts}">
                <div th:replace="~{fragments :: post(post=${post})}"></div>
            </div>
        </div>
    </div>
</div>

<div th:fragment="post(post)">
    <div class="feed-post">
        <div class="feed-post-header">
            <span th:if="${post != null and post.author != null}" th:text="${post.author.name}"></span>
            <span th:unless="${post != null and post.author != null}">Unknown user</span>

            <div class="post-ball">
            <span th:if="${post.initiative != null}" th:text="' #' + ${post.initiative.title}"></span>
            </div>
        </div>

        <div class="feed-post-content" th:text="${post.content}">Post Content</div>

        <div class="feed-actions">
            <form th:action="@{/posts/{id}/like(id=${post.id})}" method="post" style="display:inline;">
                <input type ="hidden" name="source" th:value="${source}"/>
                <button type="submit" class="like-button">‚ù§Ô∏è</button>
                <span th:text="${post.likesCount}">0</span>
            </form>
        </div>

        <div class="post-footer">
            <span th:text="${#temporals.format(post.creationDatetime, 'yyyy-MM-dd HH:mm')}"></span>
        </div>
    </div>
</div>

<div th:fragment="chat">
    <div class="chat-area">
        <!-- Chat messages will go here -->
    </div>
    <div class="chat-input">
        <textarea id="text-input" placeholder="Type a message..."></textarea>
        <button onclick="sendMessage()" data-receiver-email="">Send</button>
    </div>
</div>

</body>
</html>


===== ./resources/templates/initiative-feed.html =====
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LocalZero - Initiative Feed</title>
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>

<div th:replace="~{fragments :: navbar}"></div>

<div class="feed-wrapper">
    <h1>All visible initiatives:</h1>

    <div th:each="i : ${initiatives}">
        <a th:href="@{'/initiatives/' + ${i.id}}" style="text-decoration: none;">
            <div class="feed-post">

                <p th:if="${joinedInitiativeIds.contains(i.id)}" style="color: green; font-weight: bold">
                    You belong to this initiative
                </p>
                <div class="feed-post-header">
                    <strong th:text="${i.title}">Titel</strong>
                    <span th:text="${#temporals.format(i.creationDatetime, 'yyyy-MM-dd HH:mm')}"></span>
                </div>
                <div class="feed-post-content">
                    <p th:text="'Location: ' + ${i.location}"></p>
                    <p th:text="${i.description}"></p>
                    <p><strong>Category:</strong> <span th:text="${i.category}"></span></p>
                    <p><strong>Start:</strong> <span
                            th:text="${#temporals.format(i.startDate, 'yyyy-MM-dd HH:mm')}"></span>
                    </p>
                    <p><strong>End:</strong> <span th:text="${#temporals.format(i.endDate, 'yyyy-MM-dd HH:mm')}"></span>
                    </p>
                    <p><strong>Communities:</strong></p>
                    <ul>
                        <li th:each="c : ${i.communities}" th:text="${c.name}"></li>
                    </ul>
                </div>
            </div>
        </a>
    </div>
</div>

</body>
</html>

===== ./resources/templates/initiative-view.html =====
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title th:text="${initiative.title}">Initiative Details</title>
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>

<!-- ‚úÖ NAVBAR -->
<div th:replace="~{fragments :: navbar}"></div>

<!-- üß± FLEX-CONTAINER f√∂r b√•da feed-wrappers -->
<div class="feed-wrapper-container">

    <div class="feed-wrapper" style="flex: 2;">
        <div class="card-box">

            <!-- RAD 1: Initiative + Participants sida vid sida -->
            <div class="initiative-info-row">
                <!-- Initiative Info -->
                <div class="initiative-details">
                    <h2 th:text="${initiative.title}">Initiative Title</h2>
                    <p th:text="${initiative.description}">Description</p>
                    <p><strong>Location:</strong> <span th:text="${initiative.location}">Location</span></p>
                    <p><strong>Category:</strong> <span th:text="${initiative.category}">Category</span></p>
                    <p><strong>Start:</strong> <span th:text="${#temporals.format(initiative.startDate, 'yyyy-MM-dd HH:mm')}"></span></p>
                    <p><strong>End:</strong> <span th:text="${#temporals.format(initiative.endDate, 'yyyy-MM-dd HH:mm')}"></span></p>

                    <div th:if="${isParticipant}">
                        <p style="color: green;">You're in this initiative</p>
                    </div>
                    <form th:if="${!isParticipant}" th:action="@{'/initiatives/' + ${initiative.id} + '/join'}" method="post">
                        <button type="submit">Join Initiative</button>
                    </form>
                </div>

                <!-- Participants -->
                <div class="initiative-participants">
                    <h3>Participants (<span th:text="${#lists.size(initiative.participants)}">0</span>)</h3>
                    <ul>
                        <li th:each="p : ${initiative.participants}" class="participant-card">
                            <span th:text="${p.name}">Participant Name</span><br/>
                            <small>Role: Participant</small>
                        </li>
                    </ul>
                </div>
            </div>

            <!-- RAD 2: Posts -->
            <div class="initiative-posts" style="margin-top: 2rem;">
                <h3>Posts</h3>
                <div th:if="${posts.isEmpty()}">
                    <p>No posts yet.</p>
                </div>
                <div th:each="post : ${posts}" style="margin-bottom: 1.5rem;">
                    <div style="border-top: 1px solid currentColor; padding-top: 1rem;">
                        <p><strong th:text="${post.author.name}">Author</strong></p>
                        <p th:text="${post.content}">Post content</p>
                        <p style="font-size: 0.9rem; font-weight: bold;" th:text="${#temporals.format(post.creationDatetime, 'yyyy-MM-dd HH:mm')}"></p>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- üü¶ H√ñGER FEED-WRAPPER (Add a new post) -->
    <div class="feed-wrapper post-form-wrapper" style="flex: 1;">
        <div class="card-box">
            <h3>Add a new post</h3>
            <form th:action="@{/create-post}" method="post">
                <input type="hidden" name="initiativeId" th:value="${initiative.id}" />
                <textarea name="content" placeholder="Write your update..." rows="6" required
                          style="width: 100%; margin-bottom: 1rem;"></textarea>
                <button type="submit">Post</button>
            </form>
        </div>
    </div>

</div>

</body>
</html>


===== ./resources/templates/login.html =====
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LocalZero - Login</title>
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<section class="form-container">
<h1>Login</h1>
<form th:action="@{/login}" method="post">
    <div class="input-group">
        <label for="email">Email:</label>
        <input type="text" id="email" name="email" required>
    </div>
    <div class="input-group">
        <label for="password">Password:</label>
        <input type="password" id="password" name="password" required>
    </div>
    <button type="submit">Login</button>
    <p>Don't have an account? <a th:href="@{/register}" style="color: #90cdf4">Register here</a></p>

</form>
</section>
</body>
</html>

===== ./resources/templates/messages.html =====
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LocalZero - Direct Messages</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/dm.css">
    <script src="/js/dm.js" defer></script>
</head>
<body>

<div th:replace="~{fragments :: navbar}"></div>

<div class="messages-layout">
    <div class="dm-container">
        <div id="clientInfo">
            <strong th:text="${user.name}">User Name placeholder</strong>
            (<span th:text="${user.email}">user@example.com placeholder</span>)
            <input type="hidden" id="clientEmail" th:value="${user.email}" />
        </div>
        <h1>Direct Messages</h1>
        <button class="new-chat-btn" onclick="openNewChatDialog()">New Chat</button>
        <div class="dm-list">
            <!-- existing dm-list content -->
        </div>
    </div>

    <div class="chat-container">
        <div th:replace="~{fragments :: chat}"></div>
    </div>
</div>

<div class="dialog-backdrop" id="dialogBackdrop"></div>
<div class="new-chat-dialog" id="newChatDialog">
    <h2>Who do you want to chat with?</h2>
    <div th:if="${persons != null}">
        <div th:each="person : ${persons}"
             th:if="${person.email} != ${user.email}"
             class="person-item"
             th:attr="onclick='startChat(\'' + ${person.email} + '\')'">
            <span th:text="${person?.name}">Person Name</span>
        </div>
    </div>
</div>
</body>
</html>

===== ./resources/templates/profile.html =====
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LocalZero - Profile</title>
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>

<div th:replace="~{fragments :: navbar}"></div>
<div th:replace="~{fragments :: profile(user=${user}, posts=${posts})}"></div>



</body>
</html>

===== ./resources/templates/register.html =====
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>LocalZero - Register</title>
    <link rel="stylesheet" href="/css/main.css">
    <script src="/js/register.js" defer></script>
</head>
<body>
<section>
<form class="form-container" method="post">
    <h1>Register</h1>
    <div class="input-group">
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" required>
    </div>
    <div class="input-group">
        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required>
    </div>
    <div class="input-group">
        <label for="password">Password:</label>
        <input type="password" id="password" name="password" required>
    </div>
    <div class="input-group">
        <label for="profilePicture">Profile Picture :</label>
        <input type="file" id="profilePicture" name="profilePicture" accept="image/*" onchange="previewFile(this)" required>
    </div>
    <button id= "submit" type="button">Register</button>
</form>
</section>
</body>
</html>

===== ./resources/templates/user-not-found.html =====

<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Anv√§ndare ej hittad</title>
    <link rel="stylesheet" href="/css/profileStyle.css">
</head>
<body>

<!-- Navbar -->
<div th:replace="fragments :: navbar"></div>

<!-- Felmeddelande -->
<div class="error-container">
    <h1>Oj!</h1>
    <p th:text="${message}">Anv√§ndaren hittades inte.</p>
    <a href="/feed">Tillbaka till fl√∂det</a>
</div>

</body>
</html>


===== ./java/com/localzero/api/config/DataInitializer.java =====
package com.localzero.api.config;

import com.localzero.api.entity.*;
import com.localzero.api.enumeration.InitiativeCategory;
import com.localzero.api.repository.*;
import jakarta.annotation.PostConstruct;
import lombok.RequiredArgsConstructor;
import org.springframework.context.annotation.Configuration;

import java.time.LocalDateTime;
import java.util.Set;

@Configuration
@RequiredArgsConstructor
public class DataInitializer {

    private final PersonRepository personRepository;
    private final InitiativeRepository initiativeRepository;
    private final PostRepository postRepository;
    private final CommunityRepository communityRepository;

    @PostConstruct
    public void initData() {
        Community c1 = new Community();
        c1.setMemberEmail("Lund");
        communityRepository.save(c1);

        Community c2 = new Community();
        c2.setMemberEmail("Stockholm");
        communityRepository.save(c2);

        Community c3 = new Community();
        c3.setMemberEmail("G√∂teborg");
        communityRepository.save(c3);

        Person p1 = new Person();
        p1.setEmail("alice@example.com");
        p1.setName("Alice");
        p1.setPassword("{noop}pass");
        p1.setCommunities(Set.of(c1));
        personRepository.save(p1);

        Person p2 = new Person();
        p2.setEmail("bob@example.com");
        p2.setName("Bob");
        p2.setPassword("{noop}pass");
        p1.setCommunities(Set.of(c1));
        personRepository.save(p2);

        Person p3 = new Person();
        p3.setEmail("charlie@example.com");
        p3.setName("Charlie");
        p3.setPassword("{noop}pass");
        p1.setCommunities(Set.of(c2));
        personRepository.save(p3);

        Initiative i1 = new Initiative();
        i1.setTitle("Cykelverkstad");
        i1.setDescription("Laga cyklar");
        i1.setCategory(InitiativeCategory.TOOL_SHARING);
        i1.setLocation("Lund");
        i1.setStartDate(LocalDateTime.now().plusDays(1));
        i1.setEndDate(LocalDateTime.now().plusDays(3));
        i1.setPublic(true);
        i1.setCreator(p2);
        i1.setCommunityMember(p2);
        i1.setCreationDatetime(LocalDateTime.now());
        i1.setCommunities(Set.of(c1));
        i1.getParticipants().add(p2);
        initiativeRepository.save(i1);

        Initiative i2 = new Initiative();
        i2.setTitle("Kompostering i kvarteret");
        i2.setDescription("Skapa ett kompostsystem i tr√§dg√•rden");
        i2.setCategory(InitiativeCategory.RECYCLING);
        i2.setLocation("Malm√∂");
        i2.setStartDate(LocalDateTime.now().plusDays(2));
        i2.setEndDate(LocalDateTime.now().plusDays(5));
        i2.setPublic(true);
        i2.setCreator(p1);
        i2.setCommunityMember(p1);
        i2.setCreationDatetime(LocalDateTime.now());
        i2.setCommunities(Set.of(c1));
        i2.getParticipants().add(p1);
        initiativeRepository.save(i2);

        Post post1 = new Post();
        post1.setAuthor(p1);
        post1.setInitiative(i2);
        post1.setContent("Vi har f√•tt hem nya k√§rl!");
        post1.setCreationDatetime(LocalDateTime.now());
        post1.setLikesCount(0);
        postRepository.save(post1);

        Post post2 = new Post();
        post2.setAuthor(p2);
        post2.setInitiative(i1);
        post2.setContent("Cykelverkstad startar imorgon!");
        post2.setCreationDatetime(LocalDateTime.now());
        post2.setLikesCount(0);
        postRepository.save(post2);

        Post standalone = new Post();
        standalone.setAuthor(p3);
        standalone.setContent("N√•gon som vill sam√•ka till eko-marknaden?");
        standalone.setCreationDatetime(LocalDateTime.now());
        standalone.setLikesCount(0);
        postRepository.save(standalone);
    }
}

===== ./java/com/localzero/api/controller/CommentController.java =====
package com.localzero.api.controller;

import com.localzero.api.entity.Person;
import com.localzero.api.entity.Post;
import com.localzero.api.entity.PostComment;
import com.localzero.api.repository.PostCommentRepository;
import com.localzero.api.repository.PostRepository;
import com.localzero.api.service.PersonService;
import lombok.AllArgsConstructor;
import org.springframework.security.core.Authentication;
import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;

import java.time.LocalDateTime;

@Controller
@AllArgsConstructor
public class CommentController {

    private final PostRepository postRepo;
    private final PersonService personService;
    private final PostCommentRepository commentRepo;

    @PostMapping("/comments")
    public String addComment(@RequestParam Long postId,
                             @RequestParam String content,
                             Authentication auth) {
        String email = auth.getName();
        Person author = personService.findByEmail(email);
        Post post = postRepo.findById(postId).orElseThrow();

        PostComment comment = new PostComment();
        comment.setPost(post);
        comment.setAuthor(author);
        comment.setContent(content);
        comment.setCreationDatetime(LocalDateTime.now());

        commentRepo.save(comment);
        return "redirect:/feed";
    }
}


===== ./java/com/localzero/api/controller/FeedController.java =====
package com.localzero.api.controller;

import com.localzero.api.entity.Initiative;
import com.localzero.api.entity.Person;
import com.localzero.api.entity.Post;
import com.localzero.api.service.InitiativeService;
import com.localzero.api.service.PersonService;
import com.localzero.api.service.PostService;
import lombok.AllArgsConstructor;
import org.springframework.security.core.Authentication;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.GetMapping;


import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

@Controller
@AllArgsConstructor
public class FeedController {

    private final PersonService personService;
    private final PostService postService;
    private final InitiativeService initiativeService;

    @GetMapping("/feed")
    public String showFeed(Authentication authentication, Model model) {
        String email = authentication.getName();
        Person person = personService.findByEmail(email);

        List<Initiative> myInitiatives = initiativeService.getByParticipant(email);

        List<Post> postsFromMyInitiatives = new ArrayList<>();
        for (Initiative initiative : myInitiatives) {
            postsFromMyInitiatives.addAll(postService.getPostsByInitiativeId(initiative.getId()));
        }

        List<Post> allStandalonePosts = postService.getAllStandalonePosts();

        Set<Long> myInitiativeIds = new HashSet<>();
        for (Initiative i : myInitiatives) {
            myInitiativeIds.add(i.getId());
        }

        List<Initiative> visibleInitiatives = initiativeService.getPublicOrByCommunities(person.getCommunities());


        List<Post> postsFromVisibleInitiatives = new ArrayList<>();
        for (Initiative initiative : visibleInitiatives) {
            if (!myInitiativeIds.contains(initiative.getId())) {
                postsFromVisibleInitiatives.addAll(postService.getPostsByInitiativeId(initiative.getId()));
            }
        }

        List<Post> combinedPosts = new ArrayList<>();
        combinedPosts.addAll(postsFromMyInitiatives);
        combinedPosts.addAll(postsFromVisibleInitiatives);
        combinedPosts.addAll(allStandalonePosts);
        combinedPosts.sort((a, b) -> b.getCreationDatetime().compareTo(a.getCreationDatetime()));

        System.out.println("==== FEED DEBUG ====");
        System.out.println("Anv√§ndare: " + email);
        System.out.println("Deltar i initiativ: " + myInitiatives.size());
        for (Initiative i : myInitiatives) {
            System.out.println(" ‚Üí " + i.getTitle());
        }
        System.out.println("Totalt antal inl√§gg i feed: " + combinedPosts.size());
        for (Post p : combinedPosts) {
            System.out.println(" - " + p.getContent() + " | av: " + p.getAuthor().getEmail() +
                    " | initiativ: " + (p.getInitiative() != null ? p.getInitiative().getTitle() : "Enskild"));
        }

        model.addAttribute("name", person.getName());
        model.addAttribute("posts", combinedPosts);
        model.addAttribute("source", "feed");

        return "feed";
    }
}

===== ./java/com/localzero/api/controller/IndexController.java =====
package com.localzero.api.controller;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;

@Controller
public class IndexController {
    @GetMapping("/") public String toDefaultPath(){
        return "feed";
    }
}


===== ./java/com/localzero/api/controller/InitiativeController.java =====
package com.localzero.api.controller;

import com.localzero.api.entity.*;
import com.localzero.api.enumeration.InitiativeCategory;
import com.localzero.api.enumeration.UserRole;
import com.localzero.api.repository.*;
import com.localzero.api.service.InitiativeService;
import com.localzero.api.template.InitiativeCreator;
import lombok.RequiredArgsConstructor;
import org.springframework.http.HttpStatus;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.server.ResponseStatusException;

import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;

@Controller
@RequestMapping("/initiatives")
@RequiredArgsConstructor
public class InitiativeController {

    private final InitiativeCreator ic;
    private final InitiativeRepository initiativeRepository;
    private final PersonRepository personRepository;
    private final CommunityRepository communityRepository;
    private final InitiativeService initiativeService;
    private final PostRepository postRepository;
    private final InitiativeParticipantRepository initiativeParticipantRepository;

    @PostMapping("/create")
    public String createInitiative(@RequestParam String title,
                                   @RequestParam String description,
                                   @RequestParam String location,
                                   @RequestParam String startDate,
                                   @RequestParam String endDate,
                                   @RequestParam InitiativeCategory category,
                                   @RequestParam(required = false, defaultValue = "false") boolean isPublic,
                                   @RequestParam(required = false) List<Long> communityIds,
                                   @AuthenticationPrincipal UserDetails user) {

        Initiative initiative = new Initiative();
        initiative.setTitle(title);
        initiative.setDescription(description);
        initiative.setLocation(location);
        initiative.setStartDate(LocalDateTime.parse(startDate));
        initiative.setEndDate(LocalDateTime.parse(endDate));
        initiative.setCategory(category);
        initiative.setPublic(isPublic);

        Person creator = personRepository.findByEmail(user.getUsername()).orElseThrow();
        initiative.setCreator(creator);
        initiative.setCommunityMember(creator);

        Set<Community> selectedCommunities = (communityIds != null)
                ? new HashSet<>(communityRepository.findAllById(communityIds))
                : new HashSet<>();
        initiative.setCommunities(selectedCommunities);

        ic.create(user.getUsername(), initiative);

        InitiativeParticipant admin = new InitiativeParticipant();
        admin.setInitiative(initiative);
        admin.setPerson(creator);
        admin.setRole(UserRole.ADMIN);
        admin.setJoinedAt(LocalDateTime.now());

        initiativeParticipantRepository.save(admin);

        return "redirect:/feed";
    }

    @GetMapping("/feed")
    public String showInitiatives(Model model, @AuthenticationPrincipal UserDetails currentUser) {
        Person person = personRepository.findByEmail(currentUser.getUsername()).orElseThrow();
        List<Initiative> initiatives = initiativeService.getVisibleForUser(person);
        initiatives = initiatives.stream().filter(Objects::nonNull).toList();
        List<Initiative> myInitiatives = initiativeService.getByParticipant(person.getEmail());

        Set<Long> joinedInitiativeIds = myInitiatives.stream().map(Initiative::getId).collect(Collectors.toSet());

        model.addAttribute("initiatives", initiatives);
        model.addAttribute("joinedInitiativeIds", joinedInitiativeIds);

        return "initiative-feed";
    }

    @GetMapping("/new")
    public String showCreateInitiativeForm(Model model) {
        model.addAttribute("categories", InitiativeCategory.values());
        model.addAttribute("allCommunities", communityRepository.findAll());
        return "create-initiative";
    }

    @GetMapping("/{id}")
    public String showEditInitiativeForm(@PathVariable Long id, Model model,
                                         @AuthenticationPrincipal UserDetails currentUser) {
        Initiative initiative = initiativeService.getById(id);
        Person person = personRepository.findByEmail(currentUser.getUsername()).orElseThrow();
        boolean isParticipant = initiative.getParticipants().stream()
                .anyMatch(p -> p.getEmail().equals(person.getEmail()));

        model.addAttribute("initiative", initiative);
        model.addAttribute("isParticipant", isParticipant);
        List<InitiativeParticipant> participantsWithRoles =
                initiativeParticipantRepository.findByInitiativeId(initiative.getId());

        String myRole = participantsWithRoles.stream()
                .filter(p -> p.getPerson().getEmail().equals(person.getEmail()))
                .map(p -> p.getRole().name())
                .findFirst().orElse("UNKNOWN");

        model.addAttribute("participantsWithRoles", participantsWithRoles);
        model.addAttribute("myRole", myRole);

        List<Post> posts = postRepository.findByInitiativeIdOrderByCreationDatetimeDesc(initiative.getId());
        model.addAttribute("posts", posts);

        return "initiative-view";
    }

    @PostMapping("/{id}/join")
    public String joinInitiative(@PathVariable Long id, @AuthenticationPrincipal UserDetails currentUser) {
        initiativeService.addParticipant(id, currentUser.getUsername());
        return "redirect:/initiatives/" + id;
    }

    @PostMapping("/{id}/leave")
    public String leaveInitiative(@PathVariable Long id,
                                  @AuthenticationPrincipal UserDetails currentUser) {
        String email = currentUser.getUsername();

        InitiativeParticipant me = initiativeParticipantRepository
                .findByInitiativeIdAndPersonEmail(id, email)
                .orElseThrow(() -> new ResponseStatusException(HttpStatus.BAD_REQUEST, "You are not part of this initiative."));

        Initiative initiative = initiativeRepository.findById(id)
                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND));

        if (initiative.getCreator().getEmail().equals(email)) {
            throw new ResponseStatusException(HttpStatus.FORBIDDEN, "The creator cannot leave the initiative.");
        }

        initiativeParticipantRepository.delete(me);
        return "redirect:/feed";
    }

    @PostMapping("/{id}/roles")
    public String updateRole(@PathVariable Long id,
                             @RequestParam String targetEmail,
                             @RequestParam String newRole,
                             @AuthenticationPrincipal UserDetails currentUser) {
        Person current = personRepository.findByEmail(currentUser.getUsername()).orElseThrow();

        InitiativeParticipant admin = initiativeParticipantRepository
                .findByInitiativeIdAndPersonEmail(id, current.getEmail())
                .orElseThrow(() -> new ResponseStatusException(HttpStatus.FORBIDDEN));

        Initiative initiative = initiativeRepository.findById(id)
                .orElseThrow(() -> new ResponseStatusException(HttpStatus.NOT_FOUND));

        if (!initiative.getCreator().getEmail().equals(current.getEmail()) && admin.getRole() != UserRole.ADMIN) {
            throw new ResponseStatusException(HttpStatus.FORBIDDEN);
        }

        if (initiative.getCreator().getEmail().equals(targetEmail)) {
            throw new ResponseStatusException(HttpStatus.FORBIDDEN, "Cannot change role of the creator.");
        }

        InitiativeParticipant target = initiativeParticipantRepository
                .findByInitiativeIdAndPersonEmail(id, targetEmail)
                .orElseThrow(() -> new ResponseStatusException(HttpStatus.BAD_REQUEST));

        try {
            UserRole parsedRole = UserRole.valueOf(newRole);
            target.setRole(parsedRole);
            initiativeParticipantRepository.save(target);
        } catch (IllegalArgumentException e) {
            throw new ResponseStatusException(HttpStatus.BAD_REQUEST, "Invalid role");
        }

        return "redirect:/initiatives/" + id;
    }
}


===== ./java/com/localzero/api/controller/LoginController.java =====
package com.localzero.api.controller;

/**
 * @author: Andr√©
 */

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;

@Controller
public class LoginController {

    @GetMapping("/login")
    public String login() {
        return "login";
    }
/*
    @GetMapping("/register")
    public String register() {
        return "register";
    }

 */
}


===== ./java/com/localzero/api/controller/MessageController.java =====
package com.localzero.api.controller;

import com.localzero.api.entity.DirectMessage;
import com.localzero.api.entity.Notification;
import com.localzero.api.entity.Person;
import com.localzero.api.repository.DirectMessageRepository;
import com.localzero.api.service.PersonService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;
import com.localzero.api.repository.NotificationsRepository;
import com.localzero.api.repository.PersonRepository;
import org.springframework.security.core.Authentication;

import java.io.IOException;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Controller
@RequestMapping("/messages")
public class MessageController {

    @Autowired
    private DirectMessageRepository directMessageRepository;  //repository object som Spring Boot skapar varje g√•ng vi kallar directMessageRepository
    @Autowired
    private NotificationsRepository notificationRepo;
    @Autowired
    private PersonRepository personRepo;

    @Autowired
    private SSEController sseController;

    private PersonService personService;

    public MessageController(PersonService personService) {
        this.personService = personService;
    }

    @GetMapping
    public String renderChatPage(Authentication authentication, Model model) {
        String loggedInUserEmail = authentication.getName(); // Get the logged-in user's email

        List<DirectMessage> messages = new ArrayList<>();
        messages.addAll(directMessageRepository.findByReceiverEmail(loggedInUserEmail));
        messages.addAll(directMessageRepository.findBySenderEmail(loggedInUserEmail));

        List<Person> persons = personService.findAll();
        for (Person p : persons)
            System.out.println("Person: " + p);

        model.addAttribute("messages", messages); // Add messages to the model
        model.addAttribute("persons", persons);
        model.addAttribute("user", personService.findByEmail(loggedInUserEmail));

        return "messages"; // Resolves messages.html
    }

    @PostMapping
    @ResponseBody
    public DirectMessage sendMessage(@RequestBody DirectMessage message, Authentication authentication) {
        message.setCreationDatetime(LocalDateTime.now());
        message.setSenderEmail(authentication.getName());
        DirectMessage saved = directMessageRepository.save(message);

        // Notify receiver via SSE
        sseController.sendMessageToReceiver(message.getReceiverEmail(), saved);

        Notification n = new Notification();
        n.setPerson(personRepo.findById(message.getReceiverEmail()).orElseThrow());
        n.setDescription("New Message from " + message.getSenderEmail());
        n.setRead(false);
        n.setCreationDatetime(LocalDateTime.now()); //Vet inte om det beh√∂vs riktigt
        notificationRepo.save(n);

        return saved;
    }

    @PostMapping(value = "/image", consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    @ResponseBody
    public DirectMessage sendImageMessage(
            @RequestParam("senderEmail") String senderEmail,
            @RequestParam("receiverEmail") String receiverEmail,
            @RequestParam("file") MultipartFile file) throws IOException {

        DirectMessage message = new DirectMessage();
        message.setSenderEmail(senderEmail);
        message.setReceiverEmail(receiverEmail);
        message.setCreationDatetime(LocalDateTime.now());
        message.setContent("image");
        message.setImageData(file.getBytes());

        DirectMessage saved = directMessageRepository.save(message);

        Notification n = new Notification();
        n.setPerson(personRepo.findById(message.getReceiverEmail()).orElseThrow());
        n.setDescription("New Message from " + message.getSenderEmail());
        n.setRead(false);
        n.setCreationDatetime(LocalDateTime.now()); //Vet inte om det beh√∂vs riktigt, men kanske f√∂r att sortera notifications!!
        notificationRepo.save(n);
        return saved;
    }

    @GetMapping("/image/{id}")
    @ResponseBody
    public ResponseEntity<byte[]> getImage(@PathVariable long id) {  //Skickar tillbaka bildens inneh√•ll som bytes
        DirectMessage message = directMessageRepository.findById(id).orElseThrow();
        return ResponseEntity.ok().contentType(MediaType.IMAGE_JPEG).body(message.getImageData());
    }

    @GetMapping(value = "/{email}")
    @ResponseBody
    public List<DirectMessage> getMessages(@PathVariable String email, Authentication authentication) { //@RequestParam f√•r d√• users mail. Frontend viktigt att best√§mma users mail p√• r√§tt s√§tt! S√• att denna metod kan hitta r√§tt
        String loggedInUserEmail = authentication.getName();

        List<DirectMessage> conversation = directMessageRepository.findConversationBetween(loggedInUserEmail, email);

        if (conversation.isEmpty()) {
            DirectMessage initialMessage = new DirectMessage();
            initialMessage.setSenderEmail(loggedInUserEmail);
            initialMessage.setReceiverEmail(email);
            initialMessage.setContent("Conversation started");
            initialMessage.setCreationDatetime(LocalDateTime.now());
            directMessageRepository.save(initialMessage);
            conversation.add(initialMessage);
        }

        return conversation;
    }
}

===== ./java/com/localzero/api/controller/NotificationController.java =====
package com.localzero.api.controller;

import com.localzero.api.entity.Notification;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;
import com.localzero.api.repository.NotificationsRepository;
import java.util.List;

@RestController
@RequestMapping("/notifications")
public class NotificationController {

    @Autowired
    private NotificationsRepository notificationsRepository;

    @GetMapping
    public List<Notification> getUnread (@RequestParam String email) {

        return notificationsRepository.findByPersonEmailAndIsReadFalse(email);


    }

    @PutMapping ("/{id}/read")
    public void markAsRead(@PathVariable long id) {
        Notification n = notificationsRepository.findById(id).orElseThrow();
        n.setRead(true);
        notificationsRepository.save(n);
    }

}


===== ./java/com/localzero/api/controller/PostController.java =====
package com.localzero.api.controller;


import com.localzero.api.service.InitiativeService;
import com.localzero.api.service.PostService;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import com.localzero.api.template.PostCreator;

@Controller
public class PostController {
    private final PostService postService;
    private final PostCreator pCreator;
    private final InitiativeService inservice;

    public PostController(PostService postService, PostCreator pCreator, InitiativeService inservice) {
        this.postService = postService;
        this.pCreator = pCreator;
        this.inservice = inservice;

    }

    @GetMapping("/create-post")
    public String ShowCreatedPostFrom(Model model, @AuthenticationPrincipal UserDetails currentUser) {
        if(currentUser != null){
            model.addAttribute("initiatives",inservice.getByParticipant(currentUser.getUsername()));
        }else {
            model.addAttribute("initiatives",inservice.getAll());

        }
        return "create-post";
    }

    @PostMapping("/create-post")
    public String createPost(@RequestParam String content,@RequestParam(required = false) Long initiativeId ,@AuthenticationPrincipal UserDetails currentUser) {
        if (currentUser == null) {
            return "redirect:/login";
        }
        pCreator.create(currentUser.getUsername(), content, initiativeId);

        if(initiativeId != null){
            return "redirect:/initiatives/"+initiativeId;
        }

        return "redirect:/feed";
    }


    @PostMapping("/posts/{id}/like")
    public String likePost(@PathVariable long id,
                           @RequestParam String source,
                           @AuthenticationPrincipal UserDetails currentUser) {
        if (currentUser == null) {
            return "redirect:/login";
        }

        postService.incrementLikes(id);

        if ("feed".equals(source)) {
            return "redirect:/feed";
        } else {
            String email = currentUser.getUsername();
            return "redirect:/profile/" + email;
        }
    }

}


===== ./java/com/localzero/api/controller/ProfileController.java =====
package com.localzero.api.controller;

import com.localzero.api.entity.Community;
import com.localzero.api.entity.Person;
import com.localzero.api.entity.Post;
import com.localzero.api.repository.CommunityRepository;
import com.localzero.api.service.PersonService;
import com.localzero.api.service.PostService;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.annotation.AuthenticationPrincipal;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;

import java.util.HashSet;
import java.util.List;
import java.util.Optional;
import java.util.Set;

@Controller
@RequestMapping("/profile")
public class ProfileController {
    private final PersonService personService;
    private final PostService postService;
    private final CommunityRepository communityRepository;

    public ProfileController(PersonService personService, PostService postService, CommunityRepository communityRepository) {
        this.personService = personService;
        this.postService = postService;
        this.communityRepository = communityRepository;
    }

    @GetMapping
    public String myProfile(Model model, @AuthenticationPrincipal UserDetails currentUser) {
        if (currentUser == null) {
            return "redirect:/login";
        }

        String email = currentUser.getUsername();
        Person user = personService.findByEmail(email);
        List<Post> posts = postService.getPostsByAuthorEmail(email);

        model.addAttribute("user", user);
        model.addAttribute("posts", posts);
        model.addAttribute("allCommunities", communityRepository.findAll());
        model.addAttribute("source", "profile");
        return "profile";
    }

    @GetMapping("/{email}")
    public String OtherProfile(@PathVariable String email, Model model) {
        Optional<Person> optionalUser = personService.findOptionalByEmail(email);

        if (optionalUser.isEmpty()) {
            model.addAttribute("message", "Anv√§ndaren med e-post '" + email + "' hittades inte.");
            return "user-not-found";
        }
        Person user = optionalUser.get();
        List<Post> posts = postService.getPostsByAuthorEmail(email);
        model.addAttribute("user", user);
        model.addAttribute("posts", posts);
        model.addAttribute("allCommunities", communityRepository.findAll());
        model.addAttribute("source", "profile");
        return "profile";
    }

    @PostMapping("/communities")
    public String updateCommunities(@RequestParam(required = false) List<Long> communityIds,
                                    Authentication authentication) {
        String email = authentication.getName();
        Person user = personService.findByEmail(email);

        Set<Community> selected = (communityIds != null)
                ? new HashSet<>(communityRepository.findAllById(communityIds))
                : new HashSet<>();
        user.setCommunities(selected);
        personService.save(user);
        return "redirect:/profile";
    }

}



===== ./java/com/localzero/api/controller/RegistrationController.java =====
package com.localzero.api.controller;

/**
 * @author: Andr√©
 */

import com.localzero.api.entity.Person;
import com.localzero.api.entity.UserRoleAssignment;
import com.localzero.api.enumeration.UserRole;
import com.localzero.api.repository.PersonRepository;
import lombok.Data;
import lombok.SneakyThrows;
import org.antlr.v4.runtime.misc.LogManager;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.util.List;

@Controller
public class RegistrationController {

    @Autowired
    private PersonRepository personRepository;

    @GetMapping("/register")
    public String showRegistrationForm(Model model){
        return "register";
    }

//    @PostMapping( "/register")
//    public Person createPerson(@RequestBody Person person) {
//        // L√∂senord ej krypterade, Spring Security beh√∂ver d√§rf√∂r {noop} prefix
//        person.setPassword("{noop}" + person.getPassword());
//        //Save sparar personen till databasen (blir en insert into person osv automatiskt)
//        return personRepository.save(person);
//    }


    // Denna metod anv√§nds f√∂r att hantera registrering av nya anv√§ndare
    @SneakyThrows
    @PostMapping("/register")
    public String handleRegister(@RequestBody RegistrationRequest rq) {
        try {
            Person person = new Person();
            person.setName(rq.getName());
            person.setEmail(rq.getEmail());
            person.setPassword("{noop}" + rq.getPassword()); // L√§gger till {noop} prefix f√∂r att undvika kryptering
            if (person.getProfilePic() != null && person.getProfilePic().length == 0) {
                person.setProfilePic(null);
            }
            personRepository.save(person);
            System.out.println("Person saved!!!!!!!!");
            return "redirect:/login"; // Omregistrering lyckades, omdirigera till inloggning
        } catch (Exception e) {
            System.out.println("Redirect failed!!!!!!!!");
            e.printStackTrace();
            return "error"; // Om n√•got g√•r fel, returnera ett felmeddelande
        }
    }
}

@Data
class RegistrationRequest {
    private String name;
    private String email;
    private String password;
    private byte[] profilePicture;
    private List<UserRole> roles;
}


===== ./java/com/localzero/api/controller/SSEController.java =====
package com.localzero.api.controller;

import org.springframework.web.bind.annotation.*;
import org.springframework.web.servlet.mvc.method.annotation.SseEmitter;
import java.util.concurrent.*;

@RestController
@RequestMapping("/sse")
public class SSEController {

    private final ConcurrentMap<String, SseEmitter> emitters = new ConcurrentHashMap<>();

    @GetMapping("/messages/{email}")
    public SseEmitter streamMessages(@PathVariable String email) {
        SseEmitter emitter = new SseEmitter(Long.MAX_VALUE);
        emitters.put(email, emitter);
        emitter.onCompletion(() -> emitters.remove(email));
        emitter.onTimeout(() -> emitters.remove(email));
        return emitter;
    }

    // Call this method when a new message is sent
    public void sendMessageToReceiver(String receiverEmail, Object message) {
        SseEmitter emitter = emitters.get(receiverEmail);
        if (emitter != null) {
            try {
                emitter.send(message);
            } catch (Exception e) {
                emitters.remove(receiverEmail);
            }
        }
    }
}

===== ./java/com/localzero/api/controller/UserRoleController.java =====
package com.localzero.api.controller;


import com.localzero.api.entity.Person;
import com.localzero.api.enumeration.UserRole;
import com.localzero.api.entity.UserRoleAssignment;
import com.localzero.api.repository.PersonRepository;
import com.localzero.api.repository.UserRoleAssignmentRepository;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;
import java.util.List;

@RestController
@RequestMapping("/roles")
public class UserRoleController {

    @Autowired
    private UserRoleAssignmentRepository roleRepo;
    @Autowired
    private PersonRepository personRepo;

    @PostMapping
    public UserRoleAssignment assignRole(@RequestParam String email, @RequestParam UserRole role) {

        Person p = personRepo.findById(email).orElseThrow();

        UserRoleAssignment assignment = new UserRoleAssignment();
        assignment.setPerson(p);
        assignment.setRole(role);
        return roleRepo.save(assignment);
        
    }

    @GetMapping
    public List<UserRoleAssignment> getRoles(@RequestParam String email) {
        return roleRepo.findByPersonEmail(email);
    }

}


===== ./java/com/localzero/api/entity/Community.java =====
package com.localzero.api.entity;

/**
 * @author: Andr√© , Emil
 */

import jakarta.persistence.*;
import lombok.Data;

import java.io.Serializable;

@Entity
@Data
//@IdClass(Community.class)
public class Community {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;


    @Column(name = "member_email", nullable = false)
    private String memberEmail;

}
/*
@Data
class CommunityId implements Serializable {
    private Long id;
    private String memberEmail;
}

 */

===== ./java/com/localzero/api/entity/DirectMessage.java =====
package com.localzero.api.entity;

/**
 * @author: Adrian , Emil
 */

import com.fasterxml.jackson.annotation.JsonIgnore;
import jakarta.persistence.*;
import lombok.Data;

import java.time.LocalDateTime;

@Entity
@Data
//@IdClass(DirectMessageId.class)
public class DirectMessage {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;


    @Column(name = "sender_email", nullable = false)
    private String senderEmail;


    @Column(name = "receiver_email", nullable = false)
    private String receiverEmail;

    @ManyToOne
    @JoinColumn(name = "sender_email", referencedColumnName = "email", insertable = false, updatable = false)
    @JsonIgnore
    private Person sender;

    @ManyToOne
    @JoinColumn(name = "receiver_email", referencedColumnName = "email", insertable = false, updatable = false)
    @JsonIgnore
    private Person receiver;

    @Column(name = "content", nullable = false)
    private String content;

    @Column(name = "creation_datetime", nullable = false)
    private LocalDateTime creationDatetime;

    @Lob
    @Column(name = "image_data")
    private byte[] imageData;
}
/*
@Data
class DirectMessageId implements Serializable {
    private String senderEmail;
    private String receiverEmail;
}

 */


===== ./java/com/localzero/api/entity/EcoAction.java =====
package com.localzero.api.entity;
import jakarta.persistence.*;
import lombok.Data;

/**
 * @author: Mahyar, Emil
 */

@Entity
@Data
@Table(name = "eco_action")
public class EcoAction {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @Column(name = "author_email",nullable = false)
    private String authorEmail;

    /*
    @Id
    @Column(name = "author_email")
    private String authorEmail;

     */

    @Column(name = "community_id",nullable = false)
    private Long communityId;

    private String content;

    @Column(name = "carbon_savings")
    private Float carbonSavings;

    @ManyToOne
    @JoinColumn(name = "community_id", referencedColumnName = "id", insertable = false, updatable = false)
    private Community community;
}


===== ./java/com/localzero/api/entity/Initiative.java =====
package com.localzero.api.entity;

/**
 * @author Andr√©
 * @author Emil
 */

import com.localzero.api.enumeration.InitiativeCategory;
import jakarta.persistence.*;
import lombok.Data;

import java.time.LocalDateTime;
import java.util.HashSet;
import java.util.Set;

@Entity
@Data
public class Initiative {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne
    @JoinColumn(name = "creator_email", referencedColumnName = "email", nullable = false)
    private Person creator;

    @Column(nullable = false)
    private String title;

    @Column(nullable = false,columnDefinition = "TEXT")
    private String description;

    @Column(nullable = false)
    private String location;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private InitiativeCategory category;

    @Column(name = "start_date",nullable = false)
    private LocalDateTime startDate;

    @Column(name = "end_date",nullable = false)
    private LocalDateTime endDate;

    @Column(name = "is_public",nullable = false)
    private boolean isPublic;

    @Column(name = "creation_datetime", nullable = false)
    private LocalDateTime creationDatetime;

    @ManyToMany
    @JoinTable(
            name = "initiative_community",
            joinColumns = @JoinColumn(name = "initiative_id"),
            inverseJoinColumns = @JoinColumn(name = "community_id")
    )
    private Set<Community> communities = new HashSet<>();

    @ManyToOne
    @JoinColumn(name = "communitymember_email", referencedColumnName = "email")
    private Person communityMember;

    @ManyToMany
    @JoinTable(
            name = "initiative_participant",
            joinColumns = @JoinColumn(name = "initiative_id"),
            inverseJoinColumns = @JoinColumn(name = "participant_email")
    )
    private Set<Person> participants = new HashSet<>();

}


===== ./java/com/localzero/api/entity/InitiativeParticipant.java =====
package com.localzero.api.entity;

import com.localzero.api.enumeration.UserRole;
import jakarta.persistence.*;
import lombok.*;

import java.time.LocalDateTime;

@Entity
@Table(name = "initiative_membership")
@Data
@NoArgsConstructor
@AllArgsConstructor
public class InitiativeParticipant {

    @EmbeddedId
    private InitiativeParticipantId id = new InitiativeParticipantId();

    @ManyToOne @MapsId("initiativeId")
    private Initiative initiative;

    @ManyToOne @MapsId("personEmail")
    private Person person;

    @Enumerated(EnumType.STRING)
    private UserRole role;

    private LocalDateTime joinedAt;
}





===== ./java/com/localzero/api/entity/InitiativeParticipantId.java =====
package com.localzero.api.entity;

import jakarta.persistence.Embeddable;
import lombok.AllArgsConstructor;
import lombok.Data;
import lombok.NoArgsConstructor;

import java.io.Serializable;

@Embeddable
@Data
@NoArgsConstructor
@AllArgsConstructor
public class InitiativeParticipantId implements Serializable {
    private Long initiativeId;
    private String personEmail;
}

===== ./java/com/localzero/api/entity/Notification.java =====
package com.localzero.api.entity;

/**
 * @author Adrian Von kr√∂sus Schwenssonmssims üíÄ
 */

import jakarta.persistence.*;
import lombok.Data;

import java.time.LocalDateTime;

    @Entity
    @Data
    public class Notification {

        @Id
        @GeneratedValue(strategy = GenerationType.IDENTITY)
        private Long id;

        @ManyToOne
        @JoinColumn(name = "email", referencedColumnName = "email", nullable = false)
        private Person person;

        @Column(name = "description", nullable = false)
        private String description;

        @Column(name = "creation_datetime", nullable = false)
        private LocalDateTime creationDatetime;

        @Column(name = "is_read")
        private boolean isRead = false;

    }



===== ./java/com/localzero/api/entity/Person.java =====
package com.localzero.api.entity;

/**
 * @author Andr√©
 */

import jakarta.persistence.*;
import lombok.Data;

import java.util.HashSet;
import java.util.Set;

@Entity
@Data
public class Person {

    @Id
    private String email;

    private String name;

    private String password;

    @Lob
    @Basic(fetch = FetchType.LAZY)
    @Column(name = "profile_pic")
    private byte[] profilePic;

    @ManyToMany
    private Set<Community> communities = new HashSet<>();
}

===== ./java/com/localzero/api/entity/Post.java =====
package com.localzero.api.entity;

/**
 * @author Emil
 * @author Mahyar
 */

import jakarta.persistence.*;
import lombok.Data;
import com.localzero.api.template.TimeStampEntry;

import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.List;

@Entity
@Data
public class Post implements TimeStampEntry{

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne
    @JoinColumn(name = "initiative_id")
    private Initiative initiative;

    @ManyToOne
    @JoinColumn(name = "author_email", referencedColumnName = "email")
    private Person author;

    private String content;

    @Lob
    private byte[] image;

    private int likesCount;

    @Column(name = "creation_datetime")
    private LocalDateTime creationDatetime;

    @PrePersist
    private void onCreate() {
        creationDatetime = LocalDateTime.now();
        likesCount = 0;
    }

    @OneToMany(mappedBy = "post", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<PostComment> comments = new ArrayList<>();

    
}


===== ./java/com/localzero/api/entity/PostComment.java =====
package com.localzero.api.entity;

/**
 * @author Emil
 */

import jakarta.persistence.*;
import lombok.AllArgsConstructor;
import lombok.NoArgsConstructor;
import lombok.Data;

import java.io.Serializable;
import java.time.LocalDateTime;

@Entity
@Data
public class PostComment {

    @EmbeddedId
    private PostCommentId id = new PostCommentId();

    @ManyToOne
    @MapsId("postId")
    @JoinColumn(name = "post_id", referencedColumnName = "id", nullable = false)
    private Post post;

    @ManyToOne
    @MapsId("memberEmail")
    @JoinColumn(name = "author_email", referencedColumnName = "email", nullable = false)
    private Person author;

    private String content;

    @Column(nullable = false)
    private LocalDateTime creationDatetime;

}


===== ./java/com/localzero/api/entity/PostCommentId.java =====
package com.localzero.api.entity;

import lombok.Data;

import java.io.Serializable;

/*
@AllArgsConstructor
@NoArgsConstructor

 */
@Data
public class PostCommentId implements Serializable {
    private Long postId;
    private String memberEmail;
}


===== ./java/com/localzero/api/entity/UserRoleAssignment.java =====
package com.localzero.api.entity;

import jakarta.persistence.Entity;
import jakarta.persistence.*;
import lombok.Data;
import com.localzero.api.enumeration.UserRole;

@Entity
@Data
public class UserRoleAssignment {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @ManyToOne(optional = false)
    @JoinColumn(name = "email", referencedColumnName = "email")
    private Person person;

    @Enumerated(EnumType.STRING)
    @Column(nullable = false)
    private UserRole role;

}


===== ./java/com/localzero/api/enumeration/InitiativeCategory.java =====
package com.localzero.api.enumeration;

public enum InitiativeCategory {
    TOOL_SHARING,
    FOOD_SWAP,
    GARDENING,
    RECYCLING,
    RIDE_SHARING,
    ENVIRONMENT
}


===== ./java/com/localzero/api/enumeration/UserRole.java =====
package com.localzero.api.enumeration;

public enum UserRole {

    RESIDENT,
    ORGANIZER,
    ADMIN
}


===== ./java/com/localzero/api/LocalZeroApplication.java =====
package com.localzero.api;

import org.springframework.boot.SpringApplication;
import org.springframework.boot.autoconfigure.SpringBootApplication;

@SpringBootApplication
public class LocalZeroApplication {

    public static void main(String[] args) {
        SpringApplication.run(LocalZeroApplication.class, args);
    }
}


===== ./java/com/localzero/api/repository/CommunityRepository.java =====
package com.localzero.api.repository;

import com.localzero.api.entity.Community;
import org.springframework.data.jpa.repository.JpaRepository;

public interface CommunityRepository extends JpaRepository<Community,Long> {
}


===== ./java/com/localzero/api/repository/DirectMessageRepository.java =====
package com.localzero.api.repository;

import com.localzero.api.entity.DirectMessage;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;

import java.util.List;

public interface DirectMessageRepository extends JpaRepository<DirectMessage, Long> {

    @Query("""
        SELECT dm FROM DirectMessage dm
        WHERE (dm.senderEmail = :user1 AND dm.receiverEmail = :user2)
           OR (dm.senderEmail = :user2 AND dm.receiverEmail = :user1) 
        ORDER BY dm.creationDatetime
    """)
    //OR f√∂r att se b√•da Conversations
    List<DirectMessage> findConversationBetween(String user1, String user2);

    List<DirectMessage> findByReceiverEmail(String receiverEmail);

    List<DirectMessage> findBySenderEmail(String senderEmail);

}


===== ./java/com/localzero/api/repository/InitiativeParticipantRepository.java =====
package com.localzero.api.repository;

import com.localzero.api.entity.InitiativeParticipant;
import com.localzero.api.entity.InitiativeParticipantId;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;
import java.util.Optional;

public interface InitiativeParticipantRepository
        extends JpaRepository<InitiativeParticipant, InitiativeParticipantId> {

    List<InitiativeParticipant> findByInitiativeId(Long initiativeId);
    Optional<InitiativeParticipant> findByInitiativeIdAndPersonEmail(Long initiativeId, String email);
}


===== ./java/com/localzero/api/repository/InitiativeRepository.java =====
package com.localzero.api.repository;

import com.localzero.api.entity.Community;
import com.localzero.api.entity.Initiative;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

import java.util.List;
import java.util.Set;

public interface InitiativeRepository extends JpaRepository<Initiative,Long> {
    List<Initiative> findByCreatorEmail(String email);
    @Query("""
        SELECT i FROM Initiative i
        JOIN i.participants p
        WHERE p.email = :email
    """)
    List<Initiative> findByParticipantEmail(@Param("email") String email);
    List<Initiative> findByIsPublicTrueOrCommunitiesContaining(Community community);
    List<Initiative> findByIsPublicTrue();

    List<Initiative> findByIsPublicTrueOrCommunitiesIn(Set<Community> communities);

}


===== ./java/com/localzero/api/repository/NotificationsRepository.java =====
package com.localzero.api.repository;

import org.springframework.data.jpa.repository.JpaRepository;
import com.localzero.api.entity.Notification;
import java.util.List;


public interface NotificationsRepository extends JpaRepository<Notification, Long> {

    List<Notification>findByPersonEmailAndIsReadFalse(String email);
}



===== ./java/com/localzero/api/repository/PersonRepository.java =====
package com.localzero.api.repository;
import com.localzero.api.entity.Person;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;
import java.util.Optional;

public interface PersonRepository extends JpaRepository<Person,String> {
    Optional<Person> findByEmail(String email);
    List<Person> findAll();
    List<Person> findByEmailNot(String email);
}


===== ./java/com/localzero/api/repository/PostCommentRepository.java =====
package com.localzero.api.repository;

import com.localzero.api.entity.PostComment;
import com.localzero.api.entity.PostCommentId;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface PostCommentRepository extends JpaRepository<PostComment, PostCommentId> {
    List<PostComment> findByPostId(Long postId);
}


===== ./java/com/localzero/api/repository/PostRepository.java =====
package com.localzero.api.repository;

import com.localzero.api.entity.Post;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface PostRepository extends JpaRepository<Post, Long> {
    List<Post> findByAuthorEmailOrderByCreationDatetimeDesc(String authorEmail);

    List<Post> findByInitiativeIsNullOrderByCreationDatetimeDesc();

    List<Post> findByInitiativeIdOrderByCreationDatetimeDesc(Long initiativeId);
}


===== ./java/com/localzero/api/repository/UserRoleAssignmentRepository.java =====
package com.localzero.api.repository;

import com.localzero.api.entity.UserRoleAssignment;
import org.springframework.data.jpa.repository.JpaRepository;

import java.util.List;

public interface UserRoleAssignmentRepository extends JpaRepository<UserRoleAssignment, Long> {
    List<UserRoleAssignment> findByPersonEmail(String email);
}

===== ./java/com/localzero/api/security/SecurityConfiguration.java =====
package com.localzero.api.security;

import com.localzero.api.service.PersonService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.security.authentication.AuthenticationProvider;
import org.springframework.security.authentication.dao.DaoAuthenticationProvider;
import org.springframework.security.config.annotation.web.builders.HttpSecurity;
import org.springframework.security.config.annotation.web.configuration.EnableWebSecurity;
import org.springframework.security.config.annotation.web.configurers.AbstractHttpConfigurer;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.crypto.password.NoOpPasswordEncoder;
import org.springframework.security.crypto.password.PasswordEncoder;
import org.springframework.security.web.SecurityFilterChain;

@Configuration
@EnableWebSecurity
public class SecurityConfiguration {

    @Autowired
    private PersonService personService;

    @Bean
    public UserDetailsService userDetailsService() {
        return personService;
    }

    @Bean
    public AuthenticationProvider authenticationProvider() {
        DaoAuthenticationProvider authProvider = new DaoAuthenticationProvider();
        authProvider.setUserDetailsService(personService);
        return authProvider;
    }

    @Bean
    public SecurityFilterChain securityFilterChain(HttpSecurity httpSecurity) throws Exception {
        return httpSecurity
                .csrf(AbstractHttpConfigurer::disable)
                .formLogin(httpForm -> {
                    httpForm
                            .loginPage("/login")
                            .usernameParameter("email")
                            .permitAll();
                    httpForm.defaultSuccessUrl("/feed", true); // Redirect to /feed after login
                })
                .authorizeHttpRequests(registry -> {
                    registry
                            .requestMatchers("/register", "/css/**", "/js/**").permitAll()
                            .anyRequest().authenticated();
                })
                .build();
    }
}


===== ./java/com/localzero/api/service/InitiativeService.java =====
package com.localzero.api.service;

import com.localzero.api.entity.Community;
import com.localzero.api.entity.Initiative;
import com.localzero.api.entity.Person;
import com.localzero.api.repository.InitiativeRepository;
import org.springframework.stereotype.Service;
import com.localzero.api.repository.PersonRepository;

import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;

@Service
public class InitiativeService {
    private final InitiativeRepository ir;
    private final PersonService personService;
    private final InitiativeRepository initiativeRepository;
    private final PersonRepository personRepository;

    public InitiativeService(InitiativeRepository ir, PersonService personService, InitiativeRepository initiativeRepository, PersonRepository personRepository){
        this.ir = ir;
        this.personService = personService;
        this.initiativeRepository = initiativeRepository;
        this.personRepository = personRepository;
    }

    public List<Initiative> getAll(){
        return ir.findAll();
    }

    public List<Initiative> getByParticipant(String email){
        return ir.findByParticipantEmail(email);
    }
    public Initiative getById(Long id){
        return ir.findById(id).orElseThrow();
    }

    public List<Initiative> getAllPublic() {
        return ir.findByIsPublicTrue();
    }

    public List<Initiative> getPublicOrByCommunity(Community community) {
        return ir.findByIsPublicTrueOrCommunitiesContaining(community);
    }

    public List<Initiative> getPublicOrByCommunities(Set<Community> communities) {
        return ir.findByIsPublicTrueOrCommunitiesIn(communities);
    }

    public List<Initiative> getVisibleForUser(Person person) {
        Set<Community> communities = person.getCommunities();
        String email = person.getEmail();

        Set<Initiative> all = new HashSet<>();
        all.addAll(ir.findByIsPublicTrueOrCommunitiesIn(communities));
        all.addAll(ir.findByCreatorEmail(email));

        return new ArrayList<>(all);
    }

    public void addParticipant(Long initiativeId, String email) {
        Initiative initiative = ir.findById(initiativeId).orElseThrow();
        Person person = personService.findByEmail(email);
        initiative.getParticipants().add(person);
        ir.save(initiative);
    }

    public void removeParticipant(Long initiativeId, String userEmail) {
        Initiative initiative = initiativeRepository.findById(initiativeId).orElseThrow();
        Person person = personRepository.findByEmail(userEmail).orElseThrow();

        initiative.getParticipants().remove(person);
        initiativeRepository.save(initiative);
    }

}


===== ./java/com/localzero/api/service/PersonService.java =====
package com.localzero.api.service;

import com.localzero.api.entity.Person;
import com.localzero.api.repository.PersonRepository;
import lombok.AllArgsConstructor;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.core.userdetails.User;
import org.springframework.security.core.userdetails.UserDetails;
import org.springframework.security.core.userdetails.UserDetailsService;
import org.springframework.security.core.userdetails.UsernameNotFoundException;
import org.springframework.stereotype.Service;

import java.util.Optional;
import java.util.List;

@Service
@AllArgsConstructor
public class PersonService implements UserDetailsService {

    @Autowired
    private final PersonRepository personRepository;

    @Override
    public UserDetails loadUserByUsername(String email) throws UsernameNotFoundException {
        System.out.println("Loading user by email: " + email);
        Optional<Person> person = personRepository.findByEmail(email);
        if (person.isPresent()) {
            var personObj = person.get();
            return User.builder().
                    username(personObj.getEmail()).
                    password(personObj.getPassword()).
                    build();
        } else {
            throw new UsernameNotFoundException("User not found with email: " + email);
        }
    }

    public Person findByEmail(String email) {
        return personRepository.findByEmail(email).orElseThrow(() -> new RuntimeException("User not found"));
    }

    public List<Person> findAll() {
        return personRepository.findAll();
    }

    public Optional<Person> findOptionalByEmail(String email) {
        return personRepository.findById(email);
    }

    public void save(Person person) {
        personRepository.save(person);
    }
}


===== ./java/com/localzero/api/service/PostService.java =====
package com.localzero.api.service;

import com.localzero.api.entity.Post;
import com.localzero.api.repository.PostRepository;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class PostService {

    private final PostRepository postRepository;

    public PostService(PostRepository postRepository) {
        this.postRepository = postRepository;
    }

    public List<Post> getPostsByAuthorEmail(String email) {
        return postRepository.findByAuthorEmailOrderByCreationDatetimeDesc(email);
    }

    public Post save(Post post) {
        return postRepository.save(post);
    }

    public List<Post> getAllStandalonePosts() {
        return postRepository.findByInitiativeIsNullOrderByCreationDatetimeDesc();
    }

    public List<Post> getPostsByInitiativeId(Long initiativeId) {
        return postRepository.findByInitiativeIdOrderByCreationDatetimeDesc(initiativeId);
    }

    public void incrementLikes(long postId) {
        Post post = postRepository.findById(postId).orElseThrow();
        post.setLikesCount(post.getLikesCount() + 1);
        postRepository.save(post);
    }
}


===== ./java/com/localzero/api/template/AbstractCreator.java =====
package com.localzero.api.template;

import com.localzero.api.entity.Person;
import com.localzero.api.entity.Post;
import com.localzero.api.template.TimeStampEntry;

import java.time.LocalDateTime;

public abstract class AbstractCreator<T extends TimeStampEntry> {

    public final T create(String email, String content){
        Person user = loadUser(email);
        T entity = build(user,content);
        setTimestamps(entity);
        return persist(entity);
    }

    protected abstract Person loadUser(String email);
    protected abstract T build(Person user,String content);
    protected abstract void setTimestamps(T entity);
    protected abstract T persist(T entity);

}


===== ./java/com/localzero/api/template/AbstractInitiativeCreator.java =====
package com.localzero.api.template;

import com.localzero.api.entity.Initiative;
import com.localzero.api.entity.Person;

import java.time.LocalDateTime;

public abstract class AbstractInitiativeCreator {
    public final Initiative create(String email, Initiative initiative){
        Person user = loadUser(email);
        initiativedetailer(user,initiative);
        initiative.setCreationDatetime(LocalDateTime.now());
        return save(initiative);
    }

    protected abstract Person loadUser(String email);
    protected abstract  void initiativedetailer(Person user, Initiative initiative);
    protected abstract Initiative save(Initiative initiative);
}


===== ./java/com/localzero/api/template/InitiativeCreator.java =====
package com.localzero.api.template;

import com.localzero.api.entity.Initiative;
import com.localzero.api.entity.Person;
import com.localzero.api.repository.InitiativeRepository;
import com.localzero.api.service.PersonService;
import org.springframework.stereotype.Service;

@Service
public class InitiativeCreator extends AbstractInitiativeCreator {

    private final InitiativeRepository ir;
    private final PersonService ps;

    public InitiativeCreator(InitiativeRepository ir, PersonService ps){
        this.ir = ir;
        this.ps = ps;
    }

    @Override
    protected Person loadUser(String email) {
        return ps.findByEmail(email);
    }

    @Override
    protected void initiativedetailer(Person user, Initiative initiative) {
        initiative.setCreator(user);
        initiative.setCommunityMember(user);
        initiative.getParticipants().add(user);
    }

    @Override
    protected Initiative save(Initiative initiative) {
        Initiative saved = ir.save(initiative);
        System.out.println(" SPARAT: ID=" + saved.getId() + " - " + saved.getTitle());
        return saved;
    }
}



===== ./java/com/localzero/api/template/PostCreator.java =====
package com.localzero.api.template;

import com.localzero.api.entity.Initiative;
import com.localzero.api.entity.Person;
import com.localzero.api.entity.Post;
import com.localzero.api.repository.InitiativeRepository;
import com.localzero.api.repository.PostRepository;
import com.localzero.api.service.PersonService;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;

@Service
public class PostCreator extends AbstractCreator<Post> {

    private final PostRepository postRepo;
    private final PersonService personService;
    private final InitiativeRepository initiativeRepository;

    public PostCreator(PostRepository postRepo, PersonService personService, InitiativeRepository initiativeRepository){
        this.postRepo = postRepo;
        this.personService = personService;
        this.initiativeRepository = initiativeRepository;
    }

    @Override
    protected Person loadUser(String email) {
        return personService.findByEmail(email);
    }

    @Override
    protected Post build(Person user,String content) {
        Post post = new Post();
        post.setAuthor(user);
        post.setContent(content);
        post.setLikesCount(0);
        return post;
    }

    public Post create(String email, String content,Long initiativeId){
        Post post = super.create(email,content);
        if (initiativeId != null){
            Initiative initiative = initiativeRepository.findById(initiativeId).orElseThrow(()->new IllegalArgumentException("The initiative does not exist!"));
            post.setInitiative(initiative);
        }
        return postRepo.save(post);
    }

    @Override
    protected void setTimestamps(Post entity) {
        entity.setCreationDatetime(LocalDateTime.now());
    }

    @Override
    protected Post persist(Post entity) {
        return postRepo.save(entity);
    }


}


===== ./java/com/localzero/api/template/TimeStampEntry.java =====
package com.localzero.api.template;

import java.time.LocalDateTime;

public interface TimeStampEntry {
    void setCreationDatetime(LocalDateTime dateTime);
}


===== ./resources/application-secrets.properties =====
spring.datasource.password=hx408oft
spring.datasource.username=ac9996

===== ./resources/application.properties =====
spring.application.name=LocalZero
spring.config.import=optional:application-secrets.properties
spring.datasource.url=jdbc:postgresql://pgserver.mau.se:5432/localzerooo
spring.datasource.username=${spring.datasource.username}
spring.datasource.password=${spring.datasource.password}
spring.datasource.hikari.maximum-pool-size=2
spring.jpa.hibernate.ddl-auto= create-drop
spring.jpa.show-sql=true
spring.jpa.properties.hibernate.format_sql=true
logging.level.org.hibernate.type.descriptor.sql=TRACE
spring.thymeleaf.prefix=classpath:/templates/
spring.thymeleaf.suffix=.html



===== ./resources/static/css/dm.css =====
.new-chat-btn {
    margin: 10px 20px;
    padding: 10px 20px;
    background-color: #4CAF50;
    color: white;
    border: none;
    border-radius: 4px;
    cursor: pointer;
}

.new-chat-dialog {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    z-index: 1000;
    max-height: 80vh;
    overflow-y: scroll;
}

.dialog-backdrop {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    z-index: 999;
}

.person-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
}

.person-item:hover {
    background-color: #f5f5f5;
}

.messages-layout {
    display: flex;
    height: calc(100vh - 60px); /* Full height minus navbar */
    overflow: hidden; /* Prevent layout scrolling */
}

.dm-container {
    width: 30%;
    border-right: 1px solid #ddd;
    overflow-y: scroll;
    padding: 20px;
    background: rgba(255, 255, 255, 0.9);
}

.chat-container {
    width: 70%;
    overflow-y: scroll;
    padding: 20px;
    background: rgba(255, 255, 255, 0.9);
}

/* Custom scrollbar styling */
.dm-container::-webkit-scrollbar,
.chat-container::-webkit-scrollbar {
    width: 8px;
}

.dm-container::-webkit-scrollbar-thumb,
.chat-container::-webkit-scrollbar-thumb {
    background-color: #888;
    border-radius: 4px;
}

.dm-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
}

.dm-item:hover {
    background-color: #f5f5f5;
}



===== ./resources/static/css/feed.css =====
body{
    margin: 0;
    padding: 0;
    font-family: 'Segoe UI',sans-serif;
    background-image: url("https://www.psdstack.com/wp-content/uploads/2019/08/copyright-free-images-750x420.jpg");
    background-repeat: no-repeat;
    background-size: cover;
    background-position: center;
    min-height: 100vh;
}

.feed-wrapper{
    max-width: 800px;
    margin: 2rem auto;
    padding: 1rem;
    background-color: rgba(255,255,255,0.1);
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 15px;
    backdrop-filter: blur(15px);
    box-shadow: 0 0 20px rgba(0,0,0,0.2);
}

.feed-post{
    background: rgba(255,255,255,0.15);
    border-radius: 10px;
    margin-bottom: 1rem;
    padding: 1rem;
    color: black;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
}

.feed-post-header{
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    color: #333;
}

.feed-post-content{
    font-size: 1rem;
    line-height: 1.4;
    color: #111;
}

.feed-post img{
    max-width: 100%;
    border-radius: 8px;
    margin-top: 0.5rem;
}

.feed-actions{
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.feed-actions button{
    background-color: #ffffffcc;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s;
}

.feed-actions button:hover{
    background-color: white;
}

.likes-count{
    font-size: 0.9rem;
    color: #222;
}

.navbar{
    display: flex;
    justify-content: space-between;
    background-color: #2c3e50;
    padding: 1rem 2rem;
    color: white;
}
.navbar a{
    color: white;
    text-decoration: none;
    font-weight: bold;
    margin-left: 1rem;
}
.navbar a:hover{
    text-decoration: underline;
}



===== ./resources/static/css/initiative.css =====
textarea, input[type="text"], input[type="datetime-local"], select {
    border: 2px solid #ffb6c1;
    border-radius: 10px;
    padding: 10px;
    font-size: 16px;
    width: 100%;
    margin-bottom: 12px;
    background-color: rgba(255, 255, 255, 0.8);
}

textarea:focus, input:focus, select:focus {
    outline: none;
    border-color: #ff77b9;
    box-shadow: 0 0 5px #ff7bbe;
}

button {
    background-color: #fd80bf;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: background-color 0.3s ease;
}

button:hover {
    background-color: #ff7bbe;
}

.create-initiative-container {
    border: 2px solid #ffcce5;
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    backdrop-filter: blur(15px);
    padding: 2rem;
    max-width: 500px;
    margin: 2rem auto;
    box-shadow: 0 0 25px rgba(255, 182, 193, 0.4);
}

.create-initiative-container h2 {
    text-align: center;
    color: #333;
    margin-bottom: 1.5rem;
    font-size: 1.5rem;
}


===== ./resources/static/css/login.css =====
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', sans-serif;
}

body {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    background-image: url("https://www.psdstack.com/wp-content/uploads/2019/08/copyright-free-images-750x420.jpg");
    background-repeat: no-repeat;
    background-position: center;
    background-size: cover;
}

section {
    background-color: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 15px;
    backdrop-filter: blur(15px);
    padding: 2rem;
    width: 350px;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
}

.form-container h1 {
    color: black;
    text-align: center;
    margin-bottom: 1rem;
}

.input-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
}

.input-group label {
    color: black;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.input-group input {
    padding: 0.5rem;
    border: none;
    border-radius: 8px;
    outline: none;
}

button {
    width: 100%;
    padding: 0.6rem;
    border: none;
    border-radius: 8px;
    background-color: #ffffffcc;
    font-weight: bold;
    cursor: pointer;
    transition: 0.3s;
}



button:hover {
    background-color: white;
}


===== ./resources/static/css/main.css =====
{
    margin: 0
;
    padding: 0
;
    box-sizing: border-box
;
    font-family: 'Segoe UI', sans-serif
;
}

* {
    font-family: 'Segoe UI', sans-serif;
}

body {
    min-height: 100vh;
    padding-top: 70px;
    background-image: url("https://www.psdstack.com/wp-content/uploads/2019/08/copyright-free-images-750x420.jpg");
    background-repeat: no-repeat;
    background-position: center;
    background-size: cover;
    font-family: 'Segoe UI', sans-serif;
}

.navbar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1000;
    display: flex;
    flex-wrap: wrap; /* M√∂jligg√∂r radbrytning */
    justify-content: center; /* Centrera inneh√•ll i flera rader */
    gap: 1rem;
    background-color: #2c3e50;
    padding: 1rem 2rem;
    color: white;
}

.navbar a {
    color: white;
    text-decoration: none;
    font-weight: bold;
    margin-left: 0.5rem;
}

.navbar a:hover {
    text-decoration: underline;
}

.feed-wrapper {
    max-width: 800px;
    margin: 2rem auto;
    padding: 1rem;
    background-color: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 15px;
    backdrop-filter: blur(15px);
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.2);
}

.chat-message {
    margin-bottom: 15px;
    padding: 10px;
    background: #f1f1f1;
    border-radius: 6px;
}

.messages-layout {
    display: flex;
    height: calc(100vh - 60px); /* Full height minus navbar */
    overflow: hidden; /* Prevent layout scrolling */
}

.dm-container {
    width: 30%;
    border-right: 1px solid #ddd;
    overflow-y: scroll;
    padding: 20px;
    background: rgba(255, 255, 255, 0.9);
}

.chat-container {
    width: 70%;
    overflow-y: scroll;
    padding: 20px;
    background: rgba(255, 255, 255, 0.9);
}

/* Custom scrollbar styling */
.dm-container::-webkit-scrollbar,
.chat-container::-webkit-scrollbar {
    width: 8px;
}

.dm-container::-webkit-scrollbar-thumb,
.chat-container::-webkit-scrollbar-thumb {
    background-color: #888;
    border-radius: 4px;
}

.dm-item {
    padding: 10px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
}

.dm-item:hover {
    background-color: #f5f5f5;
}

.like-button {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 1.2rem;
    padding: 0;
}

.like-button:hover {
    tansform: scale(1.1);
}

.post-footer {
    text-align: right;
    font-size: 0.8rem;
    color: #555;
    margin-top: 0.5rem;
}

.feed-post {
    background: rgba(255, 255, 255, 0.15);
    border-radius: 10px;
    margin-bottom: 1rem;
    padding: 1rem;
    color: black;
    box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
}

.feed-post-header {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
    color: #000000;
}

.feed-post-content {
    font-size: 1rem;
    line-height: 1.4;
    color: #000000;
}

.feed-post img {
    max-width: 100%;
    border-radius: 8px;
    margin-top: 0.5rem;
}

.feed-actions {
    margin-top: 0.5rem;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.feed-actions button {
    background-color: #ffffffcc;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.3s;
}

.feed-actions button:hover {
    background-color: white;
}

.likes-count {
    font-size: 0.9rem;
    color: #222;
}

.form-container,
.create-initiative-container {
    background-color: rgba(255, 255, 255, 0.1);
    border: 2px solid rgba(255, 255, 255, 0.3);
    border-radius: 15px;
    backdrop-filter: blur(15px);
    padding: 2rem;
    max-width: 350px;
    margin: 2rem auto;
    box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
}

.form-container h1,
.create-initiative-container h1 {
    text-align: center;
    margin-bottom: 1rem;
    color: black;
}

.input-group,
.create-initiative-container .input-group {
    display: flex;
    flex-direction: column;
    margin-bottom: 1rem;
}

.input-group label,
.create-initiative-container .input-group label {
    margin-bottom: 0.5rem;
    font-weight: 500;
    color: black;
}

.input-group input,
.create-initiative-container .input-group input,
.create-initiative-container .input-group textarea,
textarea {
    padding: 0.5rem;
    border: none;
    border-radius: 8px;
    outline: none;
    resize: vertical;
}

button {
    width: 100%;
    padding: 0.6rem;
    border: none;
    border-radius: 8px;
    background-color: #ffffffcc;
    font-weight: bold;
    cursor: pointer;
    transition: background-color 0.3s;
}

button:hover {
    background-color: white;
}

.profile-container {
    display: flex;
    justify-content: center;
    align-items: flex-start;
    gap: 2rem;
    margin-top: 3rem;
    flex-wrap: wrap;
    padding: 0 2rem;
}

.profile-card {
    background-color: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.4);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    border-radius: 15px;
    padding: 2rem 3rem;
    box-shadow: 0 0 20px rgba(0, 0, 0, 0.25);
    width: 100%;
    max-width: 350px;
    color: #000000;
}


.profile-card h1 {
    margin-top: 0;
    font-size: 1.8rem;
    color: #000000;
}

.profile-card p {
    font-size: 1rem;
    margin: 0.5rem 0;
    color: #000000;
}

.profile-card strong {
    color: #222;
}

.user-posts {
    flex: 1;
    max-width: 800px;
    min-width: 300px;
}

.user-posts h2 {
    color: #222;
    margin-bottom: 1rem;
}

.post-ball {
    border-radius: 15px;
    background-color: rgba(141, 68, 68, 0.6);
    padding: 4px 10px;
    font-size: 0.9em;
}

.initiative-islands {
    display: flex;
    justify-content: space-between;
    gap: 2rem;
    flex-wrap: wrap;
}

.card-box {
    background: rgba(255, 255, 255, 0.2);
    border-radius: 16px;
    padding: 1.5rem;
    backdrop-filter: blur(15px);
    -webkit-backdrop-filter: blur(15px);
    border: 1px solid rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    color: black;
    min-width: 300px;
}

.initiative-left-island {
    flex: 2;
}

.initiative-right-island {
    flex: 1;
    align-self: flex-start;
}

.participant-card {
    border-top: 1px solid currentColor;
    margin-top: 0.5rem;
    padding-top: 0.5rem;
}

.feed-wrapper-container{
    display: flex;
    justify-content: space-between;
    gap: 2rem;
    padding: 2rem;
    flex-wrap: wrap;
}
.initiative-info-row {
    display: flex;
    justify-content: space-between;
    gap: 2rem;
    flex-wrap: wrap;
}

.initiative-details,
.initiative-participants {
    flex: 1;
    min-width: 250px;
}
.post-form-wrapper{
    align-self: flex-start;
    max-width: 400px;
    width: 100%;
    height: auto;
}

===== ./resources/static/css/post.css =====
textarea, select {
    border: 2px solid #ffb6c1;
    border-radius: 10px;
    padding: 10px;
    font-size: 16px;
    width: 100%;
    margin-bottom: 12px;
}

textarea:focus, select:focus {
    outline: none;
    border-color: #ff77b9;
    box-shadow: 0 0 5px #ff7bbe;
}

button {
    background-color: #fd80bf;
    color: white;
    padding: 10px 20px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
}

button:hover {
    background-color: rgba(255, 123, 194, 0.99);
}

.flex-row {
    display: flex;
    align-items: center;
    gap: 10px;
}

.form-container {
    border: 2px solid #ffcce5;
    background-color: rgba(255, 255, 255, 0.1);
    border-radius: 15px;
    backdrop-filter: blur(15px);
    padding: 2rem;
    max-width: 500px;
    margin: 2rem auto;
    box-shadow: 0 0 25px rgba(255, 182, 193, 0.4);
}

===== ./resources/static/css/profile.css =====
body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background-color: #f4f6f8;
    margin: 0;
    padding: 0;
}

.navbar{
    display: flex;
    justify-content: space-between;
    background-color: #2c3e50;
    padding: 1rem 2rem;
    color: white;
}

.navbar a{
    color: white;
    text-decoration: none;
    font-weight: bold;
    margin-left: 1rem;
}

.navbar a:hover{
    text-decoration: underline;
}

.profile-container {
    display: flex;
    justify-content: center;
    margin-top: 3rem;
}


.profile-card {
    background-color: #ffffff;
    border-radius: 12px;
    padding: 2rem 3rem;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    width: 100%;
    max-width: 350px;
}

.profile-card h1 {
    margin-top: 0;
    font-size: 2rem;
    color: #333;
}

.profile-card p {
    font-size: 1rem;
    margin: 0.5rem 0;
    color: #555;
}

.profile-card strong {
    color: #222;
}


@media (max-width: 350px) {
    .profile-card {
        padding: 1.5rem;
    }

    .profile-card h1 {
        font-size: 1.5rem;
    }
}

===== ./resources/static/js/dm.js =====
const baseURL = 'http://localhost:8080';

function openNewChatDialog() {
    document.getElementById('dialogBackdrop').style.display = 'block';
    document.getElementById('newChatDialog').style.display = 'block';
}

function closeNewChatDialog() {
    document.getElementById('dialogBackdrop').style.display = 'none';
    document.getElementById('newChatDialog').style.display = 'none';
}

function startChat(email) {
    closeNewChatDialog();

    fetch(baseURL + '/messages/' + email)
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log("Chat started with " + email, data);

            const chatArea = document.querySelector('.chat-container .chat-area');
            if (!chatArea) return;
            chatArea.innerHTML = ''; // Clear previous messages

            data.forEach(msg => {
                const msgDiv = document.createElement('div');
                msgDiv.className = 'chat-message';
                msgDiv.innerHTML = `<strong>${msg.senderEmail}:</strong> ${msg.content} <br><small>${msg.creationDatetime}</small>`;
                chatArea.appendChild(msgDiv);
            });

            // Set receiver email for sendMessage
            const sendBtn = document.querySelector('.chat-container .chat-input button');
            if (sendBtn) sendBtn.setAttribute('data-receiver-email', email);

            //Make receiver subscribe to messages
            subscribeToMessages(clientEmail, email);
        })
        .catch(error => {
            console.error('Error starting chat:', error);
        });
}

function sendMessage() {
    const sendBtn = document.querySelector('.chat-container .chat-input button');
    const receiverEmail = sendBtn.getAttribute('data-receiver-email');
    const chatInput = document.getElementById('text-input');
    console.log('Attempt sending: ' + chatInput.value);
    const message = chatInput.value;

    if (!message) {
        alert("Please enter a message");
        return;
    }

    const data = {
        receiverEmail: receiverEmail,
        content: message
    };

    fetch(baseURL + '/messages', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            console.log("Message sent:", data);
            chatInput.value = '';
            startChat(receiverEmail);
        })
        .catch(error => {
            console.error('Error sending message:', error);
        });
}


let sseSource = null;
function subscribeToMessages(clientEmail, receiverEmail) {
    if (sseSource) sseSource.close();
    sseSource = new EventSource('/sse/messages/' + clientEmail);
    console.log(clientEmail + ' subscribed to messages');
    sseSource.onmessage = function(event) {
        const msg = JSON.parse(event.data);
        startChat(receiverEmail);
    };

    sseSource.onerror = function() {
        console.error('Error subscribing to messages');
        sseSource.close();
    };
}

const clientEmail = document.getElementById('clientEmail').value;
document.getElementById('dialogBackdrop').onclick = closeNewChatDialog;


===== ./resources/static/js/register.js =====
const baseURL = 'http://localhost:8080';

document.getElementById("submit").addEventListener('click', (event) => {
    event.preventDefault(); // Prevent default form submission
    submitForm();
});

function submitForm() {
    console.log("Submit button clicked");

    const data = {
        name: document.getElementById('name').value,
        email: document.getElementById('email').value,
        password: document.getElementById('password').value,
        profilePicture: document.getElementById('profilePicture').value
    };

    if (!data.name || !data.email || !data.password) {
        alert("Please fill in all fields");
        return;
    }

    console.log(data);

    const jsonData = JSON.stringify(data);
    fetch(baseURL + '/register', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: jsonData
    })
        .then(response => {
            if (response.redirected) {
                window.location.href = response.url;
            }
        })
}

===== ./resources/static/js/script.js =====


===== ./resources/templates/create-initiative.html =====
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Initiative Creator</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/initiative.css">
</head>
<body>
<div th:replace="fragments :: navbar"></div>

<div class="create-initiative-container">
    <h2>Create an Initiative!</h2>
    <form th:action="@{/initiatives/create}" method="post">
        <label for="title">Title: </label><br>
        <input type="text" name="title" id="title" required><br><br>

        <label for="description">Description:</label><br>
        <textarea name="description"  id="description" required></textarea><br><br>

        <label for="location">Location:</label><br>
        <input type="text" name="location" id="location" required><br><br>

        <label for="startDate">Start Date and time:</label><br>
        <input type="datetime-local" name="startDate" id="startDate" required><br><br>

        <label for="endDate">End Date and time:</label><br>
        <input type="datetime-local" name="endDate" id="endDate" required><br><br>

        <label for="category">Category:</label><br>
        <select name="category" id="category" required>
            <option th:each="cat : ${categories}"
                    th:value="${cat}"
                    th:text="${cat}"
            ></option>
        </select><br><br>

        <label for="isPublic">Public Initiative?</label>
        <input type="checkbox" name="isPublic" id="isPublic" value="true"><br><br>

        <label for="communities">Select Communities:</label><br>
        <select name="communityIds" id="communities" multiple size="3">
            <option th:each="c : ${allCommunities}"
                    th:value="${c.id}"
                    th:text="${c.memberEmail}">
            </option>
        </select><br><br>

        <button type="submit">Create Initiative</button>
    </form>
</div>
</body>
</html>


===== ./resources/templates/create-post.html =====
<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Create Post</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/post.css">
</head>
<body>

<div th:replace="fragments :: navbar"></div>

<div class="form-container">
    <h1> Create new post</h1>

    <form th:action="@{/create-post}" method="post">
        <textarea name="content" placeholder="Write your post here" required></textarea>


        <label for="initiativeId">Choose Initiative (Optional):</label>
        <select name="initiativeId" id="initiativeId">
            <option value="">-Public-</option>
            <option th:each="i : ${initiatives}" th:value="${i.id}" th:text="${i.title}"></option>
        </select>
        <button type="submit">Publish</button>
    </form>
</div>

</body>
</html>

===== ./resources/templates/feed.html =====
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LocalZero - Feed</title>
    <link rel="stylesheet" href="/css/main.css">
</head>

<body>

<div th:replace="~{fragments :: navbar}"></div>

<div class="feed-wrapper">
    <div th:each="post : ${posts}">
        <div th:replace="~{fragments :: post(post=${post})}"></div>
    </div>
</div>

</body>
</html>


===== ./resources/templates/fragments.html =====
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>

<div th:fragment="navbar">
    <nav class="navbar">
        <a href="/profile">Profile</a>
        <a href="/messages">Direct Messages</a>
        <a href="/initiatives/feed">Initiatives</a>
        <a href="/feed">Feed</a>
        <a href="/initiatives/new">Create initiative</a>
        <a href="/create-post">Create post</a>
        <a href="/logout">Log Out</a>
    </nav>
</div>

<div th:fragment="profile(user, posts)">
    <div class="profile-container">
        <div class="profile-card">
            <h1 th:text="'Hello,' + ${user.name} + '!'">Hello, User!</h1>
            <p><strong>Email</strong> <span th:text="${user.email}">mail@example.com</span></p>

            <form th:action="@{/profile/communities}" method="post">
                <label>Your Communities:</label><br>
                <div th:each="c : ${allCommunities}">
                    <label>
                        <input type="checkbox"
                               name="communityIds"
                               th:value="${c.id}"
                               th:checked="${user.communities.contains(c)}" />
                        <span th:text="${c.memberEmail}"></span>
                    </label><br>
                </div>
                <br>
                <button type="submit">Update Communities</button>
            </form>
        </div>

        <div class="user-posts">
            <h2>Your posts</h2>

            <div th:if="${#lists.isEmpty(posts)}">
                <p>You have not posts yet!</p>
            </div>
            <div th:each="post : ${posts}">
                <div th:replace="~{fragments :: post(post=${post})}"></div>
            </div>
        </div>
    </div>
</div>

<div th:fragment="post(post)">
    <div class="feed-post">
        <div class="feed-post-header">
            <span th:if="${post != null and post.author != null}" th:text="${post.author.name}"></span>
            <span th:unless="${post != null and post.author != null}">Unknown user</span>

            <div class="post-ball">
            <span th:if="${post.initiative != null}" th:text="' #' + ${post.initiative.title}"></span>
            </div>
        </div>

        <div class="feed-post-content" th:text="${post.content}">Post Content</div>

        <div class="feed-actions">
            <form th:action="@{/posts/{id}/like(id=${post.id})}" method="post" style="display:inline;">
                <input type ="hidden" name="source" th:value="${source}"/>
                <button type="submit" class="like-button">‚ù§Ô∏è</button>
                <span th:text="${post.likesCount}">0</span>
            </form>
        </div>

        <div class="post-comments">
            <h4>Comments:</h4>
            <div th:each="comment : ${post.comments}">
                <p><strong th:text="${comment.author.name}">Author</strong>: <span th:text="${comment.content}">Comment</span></p>
            </div>
        </div>
        <form th:action="@{/comments}" method="post">
            <input type="hidden" name="postId" th:value="${post.id}" />
            <textarea name="content" placeholder="Write a comment..." required></textarea>
            <button type="submit">Comment</button>
        </form>

        <div class="post-footer">
            <span th:text="${#temporals.format(post.creationDatetime, 'yyyy-MM-dd HH:mm')}"></span>
        </div>
    </div>
</div>

<div th:fragment="chat">
    <div class="chat-area">
        <!-- Chat messages will go here -->
    </div>
    <div class="chat-input">
        <textarea id="text-input" placeholder="Type a message..."></textarea>
        <button onclick="sendMessage()" data-receiver-email="">Send</button>
    </div>
</div>

</body>
</html>


===== ./resources/templates/initiative-feed.html =====
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LocalZero - Initiative Feed</title>
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>

<div th:replace="~{fragments :: navbar}"></div>

<div class="feed-wrapper">
    <h1>All visible initiatives:</h1>

    <div th:each="i : ${initiatives}">
        <a th:href="@{'/initiatives/' + ${i.id}}" style="text-decoration: none;">
            <div class="feed-post">

                <p th:if="${joinedInitiativeIds.contains(i.id)}" style="color: green; font-weight: bold">
                    You belong to this initiative
                </p>
                <div class="feed-post-header">
                    <strong th:text="${i.title}">Titel</strong>
                    <span th:text="${#temporals.format(i.creationDatetime, 'yyyy-MM-dd HH:mm')}"></span>
                </div>
                <div class="feed-post-content">
                    <p th:text="'Location: ' + ${i.location}"></p>
                    <p th:text="${i.description}"></p>
                    <p><strong>Category:</strong> <span th:text="${i.category}"></span></p>
                    <p><strong>Start:</strong> <span
                            th:text="${#temporals.format(i.startDate, 'yyyy-MM-dd HH:mm')}"></span>
                    </p>
                    <p><strong>End:</strong> <span th:text="${#temporals.format(i.endDate, 'yyyy-MM-dd HH:mm')}"></span>
                    </p>
                    <p><strong>Community:</strong></p>
                    <ul>
                        <li th:each="c : ${i.communities}" th:text="${c.memberEmail}"></li>
                    </ul>
                </div>
            </div>
        </a>
    </div>
</div>

</body>
</html>

===== ./resources/templates/initiative-view.html =====
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title th:text="${initiative.title}">Initiative Details</title>
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>

<div th:replace="~{fragments :: navbar}"></div>

<div class="feed-wrapper-container">

    <div class="feed-wrapper" style="flex: 2;">
        <div class="card-box">

            <div class="initiative-info-row">
                <div class="initiative-details">
                    <h2 th:text="${initiative.title}">Initiative Title</h2>
                    <div th:if="${error}" style="color: red; margin-bottom: 1rem;">
                        <p th:text="${error}"></p>
                    </div>
                    <p th:text="${initiative.description}">Description</p>
                    <p><strong>Location:</strong> <span th:text="${initiative.location}">Location</span></p>
                    <p><strong>Category:</strong> <span th:text="${initiative.category}">Category</span></p>
                    <p><strong>Start:</strong> <span th:text="${#temporals.format(initiative.startDate, 'yyyy-MM-dd HH:mm')}"></span></p>
                    <p><strong>End:</strong> <span th:text="${#temporals.format(initiative.endDate, 'yyyy-MM-dd HH:mm')}"></span></p>

                    <div th:if="${isParticipant}">
                        <p style="color: green;">You're in this initiative</p>
                        <form th:action="@{'/initiatives/' + ${initiative.id} + '/leave'}" method="post">
                            <button type="submit" style="color: red;">Leave Initiative</button>
                        </form>
                    </div>

                    <form th:if="${!isParticipant}" th:action="@{'/initiatives/' + ${initiative.id} + '/join'}" method="post">
                        <button type="submit">Join Initiative</button>
                    </form>
                </div>

                <!-- Participants -->
                <div class="initiative-participants">
                    <h3>Participants (<span th:text="${#lists.size(initiative.participants)}">0</span>)</h3>
                    <ul>
                        <li th:each="p : ${initiative.participants}" class="participant-card">
                            <span th:text="${p.name}">Participant Name</span><br/>
                            <small>Role:
                                <span th:each="r : ${participantsWithRoles}"
                                      th:if="${r.person.email == p.email}"
                                      th:text="${r.role}">Unknown</span>
                            </small>

                            <!-- Only show if current user is admin and not the creator -->
                            <form th:if="${myRole == 'ADMIN'} and ${p.email} != ${initiative.creator.email}"
                                  th:action="@{'/initiatives/' + ${initiative.id} + '/roles'}"
                                  method="post">
                                <input type="hidden" name="targetEmail" th:value="${p.email}" />
                                <select name="newRole">
                                    <option>MEMBER</option>
                                    <option>ORGANIZER</option>
                                    <option>ADMIN</option>
                                </select>
                                <button type="submit">Set Role</button>
                            </form>
                        </li>
                    </ul>
                </div>

                <div class="initiative-posts" style="margin-top: 2rem;">
                    <h3>Posts</h3>
                    <div th:if="${posts.isEmpty()}">
                        <p>No posts yet.</p>
                    </div>
                    <div th:each="post : ${posts}" style="margin-bottom: 1.5rem;">
                        <div style="border-top: 1px solid currentColor; padding-top: 1rem;">
                            <p><strong th:text="${post.author.name}">Author</strong></p>
                            <p th:text="${post.content}">Post content</p>
                            <p style="font-size: 0.9rem; font-weight: bold;" th:text="${#temporals.format(post.creationDatetime, 'yyyy-MM-dd HH:mm')}"></p>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <div class="feed-wrapper post-form-wrapper" style="flex: 1;">
        <div class="card-box">
            <h3>Add a new post</h3>
            <form th:action="@{/create-post}" method="post">
                <input type="hidden" name="initiativeId" th:value="${initiative.id}" />
                <textarea name="content" placeholder="Write your update..." rows="6" required
                          style="width: 100%; margin-bottom: 1rem;"></textarea>
                <button type="submit">Post</button>
            </form>
        </div>
    </div>

</div>

</body>
</html>


===== ./resources/templates/login.html =====
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LocalZero - Login</title>
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>
<section class="form-container">
<h1>Login</h1>
<form th:action="@{/login}" method="post">
    <div class="input-group">
        <label for="email">Email:</label>
        <input type="text" id="email" name="email" required>
    </div>
    <div class="input-group">
        <label for="password">Password:</label>
        <input type="password" id="password" name="password" required>
    </div>
    <button type="submit">Login</button>
    <p>Don't have an account? <a th:href="@{/register}" style="color: #90cdf4">Register here</a></p>

</form>
</section>
</body>
</html>

===== ./resources/templates/messages.html =====
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LocalZero - Direct Messages</title>
    <link rel="stylesheet" href="/css/main.css">
    <link rel="stylesheet" href="/css/dm.css">
    <script src="/js/dm.js" defer></script>
</head>
<body>

<div th:replace="~{fragments :: navbar}"></div>

<div class="messages-layout">
    <div class="dm-container">
        <div id="clientInfo">
            <strong th:text="${user.name}">User Name placeholder</strong>
            (<span th:text="${user.email}">user@example.com placeholder</span>)
            <input type="hidden" id="clientEmail" th:value="${user.email}" />
        </div>
        <h1>Direct Messages</h1>
        <button class="new-chat-btn" onclick="openNewChatDialog()">New Chat</button>
        <div class="dm-list">
            <!-- existing dm-list content -->
        </div>
    </div>

    <div class="chat-container">
        <div th:replace="~{fragments :: chat}"></div>
    </div>
</div>

<div class="dialog-backdrop" id="dialogBackdrop"></div>
<div class="new-chat-dialog" id="newChatDialog">
    <h2>Who do you want to chat with?</h2>
    <div th:if="${persons != null}">
        <div th:each="person : ${persons}"
             th:if="${person.email} != ${user.email}"
             class="person-item"
             th:attr="onclick='startChat(\'' + ${person.email} + '\')'">
            <span th:text="${person?.name}">Person Name</span>
        </div>
    </div>
</div>
</body>
</html>

===== ./resources/templates/profile.html =====
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>LocalZero - Profile</title>
    <link rel="stylesheet" href="/css/main.css">
</head>
<body>

<div th:replace="~{fragments :: navbar}"></div>
<div th:replace="~{fragments :: profile(user=${user}, posts=${posts})}"></div>



</body>
</html>

===== ./resources/templates/register.html =====
<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8">
    <title>LocalZero - Register</title>
    <link rel="stylesheet" href="/css/main.css">
    <script src="/js/register.js" defer></script>
</head>
<body>
<section>
<form class="form-container" method="post">
    <h1>Register</h1>
    <div class="input-group">
        <label for="name">Name:</label>
        <input type="text" id="name" name="name" required>
    </div>
    <div class="input-group">
        <label for="email">Email:</label>
        <input type="email" id="email" name="email" required>
    </div>
    <div class="input-group">
        <label for="password">Password:</label>
        <input type="password" id="password" name="password" required>
    </div>
    <div class="input-group">
        <label for="profilePicture">Profile Picture :</label>
        <input type="file" id="profilePicture" name="profilePicture" accept="image/*" onchange="previewFile(this)" required>
    </div>
    <button id= "submit" type="button">Register</button>
</form>
</section>
</body>
</html>

===== ./resources/templates/user-not-found.html =====

<!DOCTYPE html>
<html lang="sv">
<head>
    <meta charset="UTF-8">
    <title>Anv√§ndare ej hittad</title>
    <link rel="stylesheet" href="/css/profileStyle.css">
</head>
<body>

<!-- Navbar -->
<div th:replace="fragments :: navbar"></div>

<!-- Felmeddelande -->
<div class="error-container">
    <h1>Oj!</h1>
    <p th:text="${message}">Anv√§ndaren hittades inte.</p>
    <a href="/feed">Tillbaka till fl√∂det</a>
</div>

</body>
</html>


